<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase CORS 및 연결 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .log {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <h1>🔍 Supabase CORS 및 연결 진단</h1>
    
    <div class="test-section">
        <h2>1. 기본 Fetch 테스트</h2>
        <button onclick="testBasicFetch()">Fetch 테스트</button>
        <div id="fetch-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Supabase Health Check</h2>
        <button onclick="testHealthCheck()">Health Check</button>
        <div id="health-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 다양한 CDN 테스트</h2>
        <button onclick="testCDNs()">CDN 테스트</button>
        <div id="cdn-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 로컬 파일로 테스트</h2>
        <button onclick="testLocalFile()">로컬 파일 테스트</button>
        <div id="local-log" class="log"></div>
    </div>

    <script>
        function log(targetId, message, type = 'info') {
            const logDiv = document.getElementById(targetId);
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
        }

        // 1. 기본 Fetch 테스트
        async function testBasicFetch() {
            const logId = 'fetch-log';
            log(logId, '기본 fetch 테스트 시작...', 'info');
            
            // Google 테스트 (CORS 확인)
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
                log(logId, 'Google favicon 요청 성공 (no-cors mode)', 'success');
            } catch (error) {
                log(logId, `Google 요청 실패: ${error.message}`, 'error');
            }
            
            // Supabase REST API 직접 테스트
            try {
                const response = await fetch('https://intyabzhvtkxgldmvpvr.supabase.co/rest/v1/', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludHlhYnpodnRreGdsZG12cHZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkxODQwMTEsImV4cCI6MjA0NDc2MDAxMX0.mUgaLB6kQKvpsJ0L3n4cEBE_3S94BmdqYJoF-0K_vK0'
                    }
                });
                log(logId, `Supabase REST API 응답: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
            } catch (error) {
                log(logId, `Supabase REST API 실패: ${error.message}`, 'error');
                log(logId, `에러 타입: ${error.name}`, 'error');
                log(logId, `Stack: ${error.stack}`, 'error');
            }
        }

        // 2. Supabase Health Check
        async function testHealthCheck() {
            const logId = 'health-log';
            log(logId, 'Supabase health check 시작...', 'info');
            
            const endpoints = [
                'https://intyabzhvtkxgldmvpvr.supabase.co',
                'https://intyabzhvtkxgldmvpvr.supabase.co/rest/v1',
                'https://intyabzhvtkxgldmvpvr.supabase.co/auth/v1',
                'https://intyabzhvtkxgldmvpvr.supabase.co/storage/v1'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint + '/health', { 
                        method: 'HEAD',
                        mode: 'cors'
                    });
                    log(logId, `${endpoint} - Status: ${response.status}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    log(logId, `${endpoint} - 실패: ${error.message}`, 'error');
                }
            }
        }

        // 3. 다양한 CDN 테스트
        async function testCDNs() {
            const logId = 'cdn-log';
            log(logId, 'CDN 로딩 테스트 시작...', 'info');
            
            const cdns = [
                {
                    name: 'jsDelivr ESM',
                    url: 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
                },
                {
                    name: 'jsDelivr Regular',
                    url: 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'
                },
                {
                    name: 'unpkg',
                    url: 'https://unpkg.com/@supabase/supabase-js@2'
                },
                {
                    name: 'cdnjs',
                    url: 'https://cdnjs.cloudflare.com/ajax/libs/supabase/2.39.0/supabase.min.js'
                }
            ];
            
            for (const cdn of cdns) {
                try {
                    const response = await fetch(cdn.url, { method: 'HEAD' });
                    log(logId, `${cdn.name}: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    log(logId, `${cdn.name} 실패: ${error.message}`, 'error');
                }
            }
        }

        // 4. 로컬 파일로 테스트
        async function testLocalFile() {
            const logId = 'local-log';
            log(logId, '로컬 파일 테스트...', 'info');
            
            try {
                // 현재 파일이 file:// 프로토콜인지 확인
                log(logId, `현재 프로토콜: ${window.location.protocol}`, 'info');
                log(logId, `현재 호스트: ${window.location.host || 'localhost'}`, 'info');
                
                if (window.location.protocol === 'file:') {
                    log(logId, '⚠️ file:// 프로토콜에서 실행 중입니다. 로컬 서버 사용을 권장합니다.', 'error');
                    log(logId, '다음 명령어로 로컬 서버 실행: python3 -m http.server 8000', 'info');
                } else {
                    log(logId, '✅ HTTP(S) 프로토콜에서 실행 중입니다.', 'success');
                }
                
                // 네트워크 상태 확인
                log(logId, `네트워크 상태: ${navigator.onLine ? '온라인' : '오프라인'}`, navigator.onLine ? 'success' : 'error');
                
            } catch (error) {
                log(logId, `로컬 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 페이지 로드시 자동 실행
        window.addEventListener('DOMContentLoaded', () => {
            log('fetch-log', '페이지 로드 완료. 테스트 버튼을 클릭하세요.', 'info');
        });
    </script>
</body>
</html>