<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct API 테스트</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #111;
            padding: 15px;
            border: 1px solid #0f0;
            overflow-x: auto;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>Direct REST API 테스트 (Supabase 라이브러리 없이)</h1>
    
    <button onclick="testDirectAPI()">Direct API 테스트</button>
    <button onclick="testWithProxy()">Proxy 경유 테스트</button>
    <button onclick="checkNetwork()">네트워크 진단</button>
    
    <pre id="log"></pre>

    <script>
        const SUPABASE_URL = 'https://intyabzhvtkxgldmvpvr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludHlhYnpodnRreGdsZG12cHZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkxODQwMTEsImV4cCI6MjA0NDc2MDAxMX0.mUgaLB6kQKvpsJ0L3n4cEBE_3S94BmdqYJoF-0K_vK0';
        
        function log(message, type = '') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
        }
        
        // 1. Direct API 호출
        async function testDirectAPI() {
            log('Direct API 테스트 시작...');
            
            try {
                // 가장 기본적인 방법으로 시도
                const response = await fetch(`${SUPABASE_URL}/rest/v1/price_history?select=*&limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                });
                
                log(`응답 상태: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('데이터: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const error = await response.text();
                    log('에러 응답: ' + error, 'error');
                }
            } catch (error) {
                log(`네트워크 오류: ${error.message}`, 'error');
                log(`오류 타입: ${error.name}`, 'error');
                
                // 더 자세한 진단
                if (error.message.includes('Load failed')) {
                    log('⚠️ 네트워크가 차단된 것 같습니다. 다음을 확인하세요:', 'error');
                    log('1. VPN을 사용중이면 끄고 시도', 'error');
                    log('2. 회사/학교 네트워크는 제한이 있을 수 있음', 'error');
                    log('3. 광고 차단기를 끄고 시도', 'error');
                    log('4. 다른 네트워크(모바일 핫스팟 등)로 시도', 'error');
                }
            }
        }
        
        // 2. 프록시 경유 테스트
        async function testWithProxy() {
            log('Proxy 경유 테스트...');
            
            // CORS 프록시 서비스 사용 (테스트용)
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = `${SUPABASE_URL}/rest/v1/price_history?select=*&limit=1`;
            
            log('⚠️ 이 방법은 테스트용입니다. 실제 사용시에는 권장하지 않습니다.', 'error');
            log(`Proxy URL: ${proxyUrl}${targetUrl}`);
            
            try {
                const response = await fetch(proxyUrl + targetUrl, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                log(`Proxy 응답: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    log('Proxy 서비스가 작동하지 않을 수 있습니다.', 'error');
                    log('https://cors-anywhere.herokuapp.com/corsdemo 에서 활성화 필요', 'error');
                }
            } catch (error) {
                log(`Proxy 오류: ${error.message}`, 'error');
            }
        }
        
        // 3. 네트워크 진단
        async function checkNetwork() {
            log('네트워크 진단 시작...');
            
            // 1. 기본 네트워크 상태
            log(`온라인 상태: ${navigator.onLine ? '온라인' : '오프라인'}`, navigator.onLine ? 'success' : 'error');
            
            // 2. DNS 해석 테스트 (이미지로)
            const img = new Image();
            img.onload = () => log('Supabase 도메인 접근 가능 (이미지 테스트)', 'success');
            img.onerror = () => log('Supabase 도메인 접근 불가 (이미지 테스트)', 'error');
            img.src = `${SUPABASE_URL}/favicon.ico?t=${Date.now()}`;
            
            // 3. 다른 API 테스트
            try {
                const response = await fetch('https://api.github.com/zen');
                const text = await response.text();
                log(`GitHub API 테스트: ${text}`, 'success');
            } catch (error) {
                log('GitHub API도 실패 - 네트워크 문제일 가능성 높음', 'error');
            }
            
            // 4. WebSocket 테스트
            try {
                const ws = new WebSocket('wss://echo.websocket.org');
                ws.onopen = () => {
                    log('WebSocket 연결 가능', 'success');
                    ws.close();
                };
                ws.onerror = () => log('WebSocket 연결 불가', 'error');
            } catch (error) {
                log('WebSocket 테스트 실패', 'error');
            }
            
            // 5. 로컬 서버 실행 안내
            log('\n💡 해결 방법:', 'success');
            log('1. 터미널에서: cd "' + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/')) + '"');
            log('2. Python3: python3 -m http.server 8000');
            log('3. 브라우저에서: http://localhost:8000 접속');
            log('4. 이 파일을 다시 실행');
        }
        
        // 페이지 로드시 자동 진단
        window.addEventListener('DOMContentLoaded', () => {
            log('페이지 로드 완료', 'success');
            log(`현재 프로토콜: ${window.location.protocol}`);
            log(`현재 호스트: ${window.location.host || 'file:///'}`);
            
            if (window.location.protocol === 'file:') {
                log('⚠️ file:// 프로토콜은 CORS 문제가 발생할 수 있습니다!', 'error');
            }
        });
    </script>
</body>
</html>