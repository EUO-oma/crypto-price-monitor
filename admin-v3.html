<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>링크 관리 - Admin v3 (수정 기능 포함)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #0a0a0a;
            border-radius: 20px;
            padding: 30px;
            border: 1px solid #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }

        .config-section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .config-section h3 {
            color: #aaa;
            margin-bottom: 15px;
        }

        input, select, button {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #222;
            color: #fff;
        }

        input {
            width: 300px;
        }

        button {
            cursor: pointer;
            background: #333;
            transition: background 0.3s;
        }

        button:hover {
            background: #444;
        }

        .add-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
        }

        .links-table {
            width: 100%;
            border-collapse: collapse;
        }

        .links-table th {
            background: #1a1a1a;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #333;
        }

        .links-table tbody {
            background: #0a0a0a;
        }

        .links-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
        }

        .links-table tr:hover {
            background: #1a1a1a;
        }

        .sortable-ghost {
            opacity: 0.4;
            background: #444 !important;
        }

        .drag-handle {
            cursor: move;
            color: #666;
            padding: 0 10px;
            font-size: 1.2em;
        }

        .drag-handle:hover {
            color: #fff;
        }

        .position-btn {
            background: #444;
            color: white;
            border: none;
            padding: 3px 8px;
            margin: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .position-btn:hover {
            background: #666;
        }

        .edit-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 5px 15px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .edit-btn:hover {
            background: #1976d2;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .save-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 5px 15px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .save-btn:hover {
            background: #45a049;
        }

        .cancel-btn {
            background: #666;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background: #555;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }

        .success {
            background: #4caf50;
        }

        .error {
            background: #f44336;
        }

        .info {
            background: #2196f3;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        a {
            color: #4ecdc4;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .edit-input {
            padding: 5px;
            margin: 2px;
            border-radius: 3px;
            border: 1px solid #444;
            background: #333;
            color: #fff;
            width: 200px;
        }

        .edit-mode {
            background: #2a2a2a !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔗 링크 관리 시스템 v3</h1>
        
        <div class="info" style="position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleGuide()">
                <span>💡 기능 안내 <span id="guide-arrow" style="font-size: 0.8em;">▼</span></span>
                <span style="font-size: 0.9em; opacity: 0.7;">클릭하여 펼치기/접기</span>
            </div>
            <div id="guide-content" style="display: none; margin-top: 15px;">
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>✏️ <strong>수정</strong>: 링크 이름과 URL 직접 수정</li>
                    <li>🔄 <strong>드래그 앤 드롭</strong>: ≡ 아이콘으로 순서 변경</li>
                    <li>⬆️⬇️ <strong>버튼 이동</strong>: 위/아래 이동</li>
                    <li>➕ <strong>추가</strong>: 새 링크 추가</li>
                    <li>🗑️ <strong>삭제</strong>: 링크 제거</li>
                    <li>🎨 <strong>스타일 설정</strong>: 각 섹션별 글자 크기, 색상, 효과 등 커스터마이징</li>
                    <li>🏷️ <strong>카테고리 관리</strong>: 새로운 카테고리 추가 및 관리</li>
                </ul>
            </div>
        </div>

        <div class="config-section">
            <h3>⚙️ Supabase 연결 상태</h3>
            <div id="connection-status">확인 중...</div>
        </div>

        <div class="add-form" style="margin-bottom: 20px;">
            <h3 style="width: 100%; margin-bottom: 10px;">🏷️ 카테고리 관리</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="new-category-id" placeholder="카테고리 ID (예: voucher)" style="flex: 1;">
                <input type="text" id="new-category-name" placeholder="표시 이름 (예: Voucher)" style="flex: 1;">
                <button onclick="addCustomCategory()" style="background: #007bff;">카테고리 추가</button>
            </div>
            <div id="custom-categories" style="font-size: 0.9em; color: #888;">
                기본 카테고리: youtube, favorite, gpt, fun-youtube
            </div>
        </div>

        <!-- 디자인 설정 토글 버튼 -->
        <div style="background: #1a1a1a; padding: 15px; margin-bottom: 20px; border-radius: 10px; cursor: pointer;" onclick="toggleDesignSettings()">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">🎨 디자인 설정 <span id="design-arrow" style="font-size: 0.8em;">▼</span></h3>
                <span style="font-size: 0.9em; opacity: 0.7;">클릭하여 펼치기/접기</span>
            </div>
        </div>

        <!-- 디자인 설정 컨텐츠 -->
        <div id="design-settings-content" class="add-form" style="display: none; margin-bottom: 20px; background: #1a1a1a;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">🎨 링크 카드 스타일 설정</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveStyles()" style="background: #4caf50; padding: 8px 15px; font-size: 0.9em;">💾 스타일 저장</button>
                    <button onclick="resetStyles()" style="background: #ff9800; padding: 8px 15px; font-size: 0.9em;">🔄 기본값으로 초기화</button>
                    <button onclick="previewStyles()" style="background: #2196f3; padding: 8px 15px; font-size: 0.9em;">👁️ 미리보기</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <!-- GPT Links 스타일 -->
                <div style="border: 1px solid #333; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #4fc3f7; margin-bottom: 10px;">🤖 GPT Links</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        글자 크기:
                        <input type="range" id="gpt-font-size" min="10" max="24" value="16" style="width: 100px; margin-left: 10px;">
                        <span id="gpt-font-size-display">16px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        글자 굵기:
                        <select id="gpt-font-weight" style="width: 100px; margin-left: 10px; background: #333; border: 1px solid #444; color: #fff;">
                            <option value="300">Light</option>
                            <option value="400">Normal</option>
                            <option value="500" selected>Medium</option>
                            <option value="600">SemiBold</option>
                            <option value="700">Bold</option>
                        </select>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        배경색:
                        <input type="color" id="gpt-bg-color" value="#1a1a1a" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        글자색:
                        <input type="color" id="gpt-text-color" value="#ffffff" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        테두리색:
                        <input type="color" id="gpt-border-color" value="#333333" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        테두리 두께:
                        <input type="range" id="gpt-border-width" min="0" max="5" value="1" style="width: 100px; margin-left: 10px;">
                        <span id="gpt-border-width-display">1px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        모서리 둥글기:
                        <input type="range" id="gpt-border-radius" min="0" max="20" value="10" style="width: 100px; margin-left: 10px;">
                        <span id="gpt-border-radius-display">10px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        안쪽 여백:
                        <input type="range" id="gpt-padding" min="5" max="30" value="15" style="width: 100px; margin-left: 10px;">
                        <span id="gpt-padding-display">15px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        카드 간격:
                        <input type="range" id="gpt-gap" min="5" max="30" value="10" style="width: 100px; margin-left: 10px;">
                        <span id="gpt-gap-display">10px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="gpt-shadow" checked> 그림자 효과
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="gpt-hover-effect" checked> 호버 효과
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        호버 배경색:
                        <input type="color" id="gpt-hover-bg" value="#2a2a2a" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        호버 스케일:
                        <input type="range" id="gpt-hover-scale" min="100" max="110" value="102" style="width: 100px; margin-left: 10px;">
                        <span id="gpt-hover-scale-display">102%</span>
                    </label>
                </div>

                <!-- YouTube Live 스타일 -->
                <div style="border: 1px solid #333; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #ff6b6b; margin-bottom: 10px;">📺 YouTube Live</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        글자 크기:
                        <input type="range" id="youtube-font-size" min="10" max="24" value="17" style="width: 100px; margin-left: 10px;">
                        <span id="youtube-font-size-display">17px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        글자 굵기:
                        <select id="youtube-font-weight" style="width: 100px; margin-left: 10px; background: #333; border: 1px solid #444; color: #fff;">
                            <option value="300">Light</option>
                            <option value="400">Normal</option>
                            <option value="500">Medium</option>
                            <option value="600" selected>SemiBold</option>
                            <option value="700">Bold</option>
                        </select>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        배경색:
                        <input type="color" id="youtube-bg-color" value="#1a1a1a" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        글자색:
                        <input type="color" id="youtube-text-color" value="#ffffff" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        테두리색:
                        <input type="color" id="youtube-border-color" value="#333333" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        테두리 두께:
                        <input type="range" id="youtube-border-width" min="0" max="5" value="1" style="width: 100px; margin-left: 10px;">
                        <span id="youtube-border-width-display">1px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        모서리 둥글기:
                        <input type="range" id="youtube-border-radius" min="0" max="20" value="10" style="width: 100px; margin-left: 10px;">
                        <span id="youtube-border-radius-display">10px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        안쪽 여백:
                        <input type="range" id="youtube-padding" min="5" max="30" value="15" style="width: 100px; margin-left: 10px;">
                        <span id="youtube-padding-display">15px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        카드 간격:
                        <input type="range" id="youtube-gap" min="5" max="30" value="10" style="width: 100px; margin-left: 10px;">
                        <span id="youtube-gap-display">10px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="youtube-shadow" checked> 그림자 효과
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="youtube-hover-effect" checked> 호버 효과
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        호버 배경색:
                        <input type="color" id="youtube-hover-bg" value="#2a2a2a" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        호버 스케일:
                        <input type="range" id="youtube-hover-scale" min="100" max="110" value="102" style="width: 100px; margin-left: 10px;">
                        <span id="youtube-hover-scale-display">102%</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="youtube-show-live-indicator" checked> 라이브 인디케이터 표시
                    </label>
                </div>

                <!-- Favorite Sites 스타일 -->
                <div style="border: 1px solid #333; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #ffd93d; margin-bottom: 10px;">⭐ Favorite Sites</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        글자 크기:
                        <input type="range" id="favorite-font-size" min="10" max="24" value="16" style="width: 100px; margin-left: 10px;">
                        <span id="favorite-font-size-display">16px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        글자 굵기:
                        <select id="favorite-font-weight" style="width: 100px; margin-left: 10px; background: #333; border: 1px solid #444; color: #fff;">
                            <option value="300">Light</option>
                            <option value="400">Normal</option>
                            <option value="500" selected>Medium</option>
                            <option value="600">SemiBold</option>
                            <option value="700">Bold</option>
                        </select>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        배경색:
                        <input type="color" id="favorite-bg-color" value="#1a1a1a" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        글자색:
                        <input type="color" id="favorite-text-color" value="#ffffff" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        테두리색:
                        <input type="color" id="favorite-border-color" value="#333333" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        테두리 두께:
                        <input type="range" id="favorite-border-width" min="0" max="5" value="1" style="width: 100px; margin-left: 10px;">
                        <span id="favorite-border-width-display">1px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        모서리 둥글기:
                        <input type="range" id="favorite-border-radius" min="0" max="20" value="10" style="width: 100px; margin-left: 10px;">
                        <span id="favorite-border-radius-display">10px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        안쪽 여백:
                        <input type="range" id="favorite-padding" min="5" max="30" value="15" style="width: 100px; margin-left: 10px;">
                        <span id="favorite-padding-display">15px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        카드 간격:
                        <input type="range" id="favorite-gap" min="5" max="30" value="10" style="width: 100px; margin-left: 10px;">
                        <span id="favorite-gap-display">10px</span>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="favorite-shadow" checked> 그림자 효과
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="favorite-hover-effect" checked> 호버 효과
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        호버 배경색:
                        <input type="color" id="favorite-hover-bg" value="#2a2a2a" style="margin-left: 10px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        호버 스케일:
                        <input type="range" id="favorite-hover-scale" min="100" max="110" value="102" style="width: 100px; margin-left: 10px;">
                        <span id="favorite-hover-scale-display">102%</span>
                    </label>
                </div>
            </div>

            <div id="style-preview" style="margin-top: 20px; display: none;">
                <h4 style="margin-bottom: 10px;">미리보기:</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div id="gpt-preview" style="padding: 10px; border-radius: 10px; text-align: center;">GPT Sample</div>
                    <div id="youtube-preview" style="padding: 10px; border-radius: 10px; text-align: center;">YouTube Sample</div>
                    <div id="favorite-preview" style="padding: 10px; border-radius: 10px; text-align: center;">Favorite Sample</div>
                </div>
            </div>
        </div>

        <!-- Fun YouTube 표시 설정 토글 버튼 -->
        <div style="background: #1a1a1a; padding: 15px; margin-bottom: 20px; border-radius: 10px; cursor: pointer;" onclick="toggleFunYoutubeSettings()">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">🎬 Fun YouTube 표시 설정 <span id="fun-youtube-arrow" style="font-size: 0.8em;">▼</span></h3>
                <span style="font-size: 0.9em; opacity: 0.7;">클릭하여 펼치기/접기</span>
            </div>
        </div>

        <!-- Fun YouTube 표시 설정 컨텐츠 -->
        <div id="fun-youtube-settings-content" class="add-form" style="display: none; margin-bottom: 20px; background: #1a1a1a;">
            <h3 style="width: 100%; margin-bottom: 15px;">🎬 Fun YouTube 표시 설정</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- 표시 옵션 -->
                <div style="border: 1px solid #333; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #ff6b6b; margin-bottom: 15px;">📺 표시 옵션</h4>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>기본 보기 모드:</strong>
                        <select id="fun-youtube-default-view" style="width: 100%; margin-top: 5px; padding: 8px; background: #333; border: 1px solid #444; border-radius: 5px; color: #fff;">
                            <option value="list">리스트 뷰 (가로형)</option>
                            <option value="grid">그리드 뷰 (카드형)</option>
                            <option value="compact">컴팩트 뷰 (텍스트만)</option>
                        </select>
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>그리드 열 개수:</strong>
                        <select id="fun-youtube-grid-cols" style="width: 100%; margin-top: 5px; padding: 8px; background: #333; border: 1px solid #444; border-radius: 5px; color: #fff;">
                            <option value="2">2열</option>
                            <option value="3" selected>3열</option>
                            <option value="4">4열</option>
                        </select>
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>썸네일 표시:</strong>
                        <input type="checkbox" id="fun-youtube-show-thumbnail" checked style="margin-left: 10px;">
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>채널명 표시:</strong>
                        <input type="checkbox" id="fun-youtube-show-author" checked style="margin-left: 10px;">
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>뷰 전환 버튼 표시:</strong>
                        <input type="checkbox" id="fun-youtube-show-toggle" checked style="margin-left: 10px;">
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>자동으로 제목 가져오기:</strong>
                        <input type="checkbox" id="fun-youtube-auto-fetch" checked style="margin-left: 10px;">
                    </label>
                </div>

                <!-- 스타일 설정 -->
                <div style="border: 1px solid #333; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #ff6b6b; margin-bottom: 15px;">🎨 스타일 설정</h4>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>제목 글자 크기:</strong>
                        <input type="range" id="fun-youtube-title-size" min="12" max="20" value="15" style="width: 150px; margin-left: 10px;">
                        <span id="fun-youtube-title-size-display">15px</span>
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>카드 배경색:</strong>
                        <input type="color" id="fun-youtube-card-bg" value="#1a1a1a" style="margin-left: 10px;">
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>테두리 색상:</strong>
                        <input type="color" id="fun-youtube-border-color" value="#333333" style="margin-left: 10px;">
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>호버 효과:</strong>
                        <select id="fun-youtube-hover-effect" style="width: 100%; margin-top: 5px; padding: 8px; background: #333; border: 1px solid #444; border-radius: 5px; color: #fff;">
                            <option value="lift" selected>들어올리기</option>
                            <option value="glow">빛나기</option>
                            <option value="scale">확대</option>
                            <option value="none">효과 없음</option>
                        </select>
                    </label>

                    <label style="display: block; margin-bottom: 15px;">
                        <strong>모서리 둥글기:</strong>
                        <input type="range" id="fun-youtube-border-radius" min="0" max="20" value="10" style="width: 150px; margin-left: 10px;">
                        <span id="fun-youtube-radius-display">10px</span>
                    </label>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveFunYoutubeSettings()" style="background: #ff6b6b;">💾 Fun YouTube 설정 저장</button>
                <button onclick="resetFunYoutubeSettings()" style="background: #666;">🔄 기본값 초기화</button>
            </div>
        </div>

        <div class="add-form">
            <h3 style="width: 100%; margin-bottom: 10px;">➕ 새 링크 추가</h3>
            <input type="text" id="link-name" placeholder="이름 (예: 사또)">
            <input type="text" id="link-url" placeholder="URL (예: https://...)">
            <select id="link-category">
                <option value="youtube">YouTube</option>
                <option value="favorite">Favorite</option>
                <option value="gpt">GPT Tools</option>
                <option value="fun-youtube">Fun YouTube</option>
            </select>
            <input type="number" id="link-position" placeholder="순서 (1, 2, 3...)" value="999">
            <button onclick="addNewLink()">추가</button>
        </div>

        <div id="status-message"></div>

        <h2 style="margin-bottom: 20px;">📋 현재 링크 목록</h2>
        
        <div id="links-container">
            <p>로딩 중...</p>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="index.html" style="margin-right: 20px;">← 메인 페이지로 돌아가기</a>
            <button onclick="signOut()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">로그아웃</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-helper.js"></script>
    <script>
        // supabase는 supabase-config.js에서 전역 변수로 선언됨
        let editingId = null;
        let customCategories = [];
        let guideOpen = false;
        let designSettingsOpen = false;
        let funYoutubeSettingsOpen = false;

        // 기능 안내 토글
        function toggleGuide() {
            const guideContent = document.getElementById('guide-content');
            const guideArrow = document.getElementById('guide-arrow');

            guideOpen = !guideOpen;

            if (guideOpen) {
                guideContent.style.display = 'block';
                guideArrow.textContent = '▲';
            } else {
                guideContent.style.display = 'none';
                guideArrow.textContent = '▼';
            }

            // 상태 저장
            localStorage.setItem('adminGuideOpen', guideOpen);
        }

        // 디자인 설정 토글
        function toggleDesignSettings() {
            const settingsContent = document.getElementById('design-settings-content');
            const settingsArrow = document.getElementById('design-arrow');

            designSettingsOpen = !designSettingsOpen;

            if (designSettingsOpen) {
                settingsContent.style.display = 'block';
                settingsArrow.textContent = '▲';
            } else {
                settingsContent.style.display = 'none';
                settingsArrow.textContent = '▼';
            }

            // 상태 저장
            localStorage.setItem('adminDesignSettingsOpen', designSettingsOpen);
        }

        // Fun YouTube 설정 토글
        function toggleFunYoutubeSettings() {
            const settingsContent = document.getElementById('fun-youtube-settings-content');
            const settingsArrow = document.getElementById('fun-youtube-arrow');

            funYoutubeSettingsOpen = !funYoutubeSettingsOpen;

            if (funYoutubeSettingsOpen) {
                settingsContent.style.display = 'block';
                settingsArrow.textContent = '▲';
            } else {
                settingsContent.style.display = 'none';
                settingsArrow.textContent = '▼';
            }

            // 상태 저장
            localStorage.setItem('adminFunYoutubeSettingsOpen', funYoutubeSettingsOpen);
        }

        // 페이지 로드시 가이드 상태 복원
        function restoreGuideState() {
            const savedState = localStorage.getItem('adminGuideOpen');
            if (savedState === 'true') {
                guideOpen = false; // toggleGuide가 반대로 토글하므로
                toggleGuide();
            }
        }

        // 페이지 로드시 디자인 설정 상태 복원
        function restoreDesignSettingsState() {
            const savedState = localStorage.getItem('adminDesignSettingsOpen');
            if (savedState === 'true') {
                designSettingsOpen = false; // toggle이 반대로 토글하므로
                toggleDesignSettings();
            }
        }

        // 페이지 로드시 Fun YouTube 설정 상태 복원
        function restoreFunYoutubeSettingsState() {
            const savedState = localStorage.getItem('adminFunYoutubeSettingsOpen');
            if (savedState === 'true') {
                funYoutubeSettingsOpen = false; // toggle이 반대로 토글하므로
                toggleFunYoutubeSettings();
            }
        }

        // localStorage에서 커스텀 카테고리 불러오기
        function loadCustomCategories() {
            const saved = localStorage.getItem('customCategories');
            if (saved) {
                customCategories = JSON.parse(saved);
                updateCategoryDropdown();
                updateCategoryDisplay();
            }
        }

        // 카테고리 드롭다운 업데이트
        function updateCategoryDropdown() {
            const select = document.getElementById('link-category');

            // select 요소가 없으면 리턴
            if (!select) {
                console.warn('link-category select element not found');
                return;
            }

            // 커스텀 카테고리 옵션 추가
            customCategories.forEach(cat => {
                if (!document.querySelector(`option[value="${cat.id}"]`)) {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                }
            });
        }

        // 카테고리 표시 업데이트
        function updateCategoryDisplay() {
            const display = document.getElementById('custom-categories');
            const allCategories = [
                'youtube', 'favorite', 'gpt', 'fun-youtube',
                ...customCategories.map(c => c.id)
            ];
            display.innerHTML = `
                <div>기본 카테고리: youtube, favorite, gpt, fun-youtube</div>
                ${customCategories.length > 0 ? 
                    `<div>커스텀 카테고리: ${customCategories.map(c => `${c.id} (${c.name})`).join(', ')}</div>` : 
                    ''}
            `;
        }

        // 커스텀 카테고리 추가
        function addCustomCategory() {
            const idInput = document.getElementById('new-category-id');
            const nameInput = document.getElementById('new-category-name');
            
            const categoryId = idInput.value.trim().toLowerCase();
            const categoryName = nameInput.value.trim();
            
            if (!categoryId || !categoryName) {
                alert('카테고리 ID와 이름을 모두 입력해주세요.');
                return;
            }
            
            // 중복 체크
            const existing = ['youtube', 'favorite', 'gpt', 'fun-youtube', ...customCategories.map(c => c.id)];
            if (existing.includes(categoryId)) {
                alert('이미 존재하는 카테고리 ID입니다.');
                return;
            }
            
            // 카테고리 추가
            customCategories.push({ id: categoryId, name: categoryName });
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            // UI 업데이트
            updateCategoryDropdown();
            updateCategoryDisplay();
            
            // 입력 필드 초기화
            idInput.value = '';
            nameInput.value = '';
            
            showStatus(`카테고리 '${categoryName}' (${categoryId})가 추가되었습니다.`, 'success');
        }

        // 스타일 관련 함수들
        function loadSavedStyles() {
            const savedStyles = JSON.parse(localStorage.getItem('linkCardStyles') || '{}');

            // 기본값 설정
            const defaultStyles = {
                gpt: {
                    fontSize: 16, fontWeight: '500', bgColor: '#1a1a1a', textColor: '#ffffff',
                    borderColor: '#333333', borderWidth: 1, borderRadius: 10, padding: 15, gap: 10,
                    shadow: true, hoverEffect: true, hoverBg: '#2a2a2a', hoverScale: 102
                },
                youtube: {
                    fontSize: 17, fontWeight: '600', bgColor: '#1a1a1a', textColor: '#ffffff',
                    borderColor: '#333333', borderWidth: 1, borderRadius: 10, padding: 15, gap: 10,
                    shadow: true, hoverEffect: true, hoverBg: '#2a2a2a', hoverScale: 102,
                    showLiveIndicator: true
                },
                favorite: {
                    fontSize: 16, fontWeight: '500', bgColor: '#1a1a1a', textColor: '#ffffff',
                    borderColor: '#333333', borderWidth: 1, borderRadius: 10, padding: 15, gap: 10,
                    shadow: true, hoverEffect: true, hoverBg: '#2a2a2a', hoverScale: 102
                }
            };

            // 저장된 스타일 또는 기본값 적용
            ['gpt', 'youtube', 'favorite'].forEach(category => {
                const styles = { ...defaultStyles[category], ...(savedStyles[category] || {}) };

                // 기본 스타일
                document.getElementById(`${category}-font-size`).value = styles.fontSize;
                document.getElementById(`${category}-font-size-display`).textContent = `${styles.fontSize}px`;
                document.getElementById(`${category}-font-weight`).value = styles.fontWeight;
                document.getElementById(`${category}-bg-color`).value = styles.bgColor;
                document.getElementById(`${category}-text-color`).value = styles.textColor;
                document.getElementById(`${category}-border-color`).value = styles.borderColor;

                // 확장 스타일
                document.getElementById(`${category}-border-width`).value = styles.borderWidth;
                document.getElementById(`${category}-border-width-display`).textContent = `${styles.borderWidth}px`;
                document.getElementById(`${category}-border-radius`).value = styles.borderRadius;
                document.getElementById(`${category}-border-radius-display`).textContent = `${styles.borderRadius}px`;
                document.getElementById(`${category}-padding`).value = styles.padding;
                document.getElementById(`${category}-padding-display`).textContent = `${styles.padding}px`;
                document.getElementById(`${category}-gap`).value = styles.gap;
                document.getElementById(`${category}-gap-display`).textContent = `${styles.gap}px`;

                // 효과 설정
                document.getElementById(`${category}-shadow`).checked = styles.shadow;
                document.getElementById(`${category}-hover-effect`).checked = styles.hoverEffect;
                document.getElementById(`${category}-hover-bg`).value = styles.hoverBg;
                document.getElementById(`${category}-hover-scale`).value = styles.hoverScale;
                document.getElementById(`${category}-hover-scale-display`).textContent = `${styles.hoverScale}%`;
            });

            // YouTube Live 전용 설정
            const youtubeStyles = savedStyles.youtube || defaultStyles.youtube;
            document.getElementById('youtube-show-live-indicator').checked = youtubeStyles.showLiveIndicator;
        }

        function initStyleControls() {
            // 각 카테고리별 컨트롤 초기화
            ['gpt', 'youtube', 'favorite'].forEach(category => {
                // 폰트 사이즈 슬라이더
                const fontSlider = document.getElementById(`${category}-font-size`);
                const fontDisplay = document.getElementById(`${category}-font-size-display`);
                if (fontSlider) {
                    fontSlider.addEventListener('input', (e) => {
                        fontDisplay.textContent = `${e.target.value}px`;
                        previewStyles();
                    });
                }

                // 테두리 두께 슬라이더
                const borderSlider = document.getElementById(`${category}-border-width`);
                const borderDisplay = document.getElementById(`${category}-border-width-display`);
                if (borderSlider) {
                    borderSlider.addEventListener('input', (e) => {
                        borderDisplay.textContent = `${e.target.value}px`;
                        previewStyles();
                    });
                }

                // 모서리 둥글기 슬라이더
                const radiusSlider = document.getElementById(`${category}-border-radius`);
                const radiusDisplay = document.getElementById(`${category}-border-radius-display`);
                if (radiusSlider) {
                    radiusSlider.addEventListener('input', (e) => {
                        radiusDisplay.textContent = `${e.target.value}px`;
                        previewStyles();
                    });
                }

                // 패딩 슬라이더
                const paddingSlider = document.getElementById(`${category}-padding`);
                const paddingDisplay = document.getElementById(`${category}-padding-display`);
                if (paddingSlider) {
                    paddingSlider.addEventListener('input', (e) => {
                        paddingDisplay.textContent = `${e.target.value}px`;
                        previewStyles();
                    });
                }

                // 간격 슬라이더
                const gapSlider = document.getElementById(`${category}-gap`);
                const gapDisplay = document.getElementById(`${category}-gap-display`);
                if (gapSlider) {
                    gapSlider.addEventListener('input', (e) => {
                        gapDisplay.textContent = `${e.target.value}px`;
                        previewStyles();
                    });
                }

                // 호버 스케일 슬라이더
                const scaleSlider = document.getElementById(`${category}-hover-scale`);
                const scaleDisplay = document.getElementById(`${category}-hover-scale-display`);
                if (scaleSlider) {
                    scaleSlider.addEventListener('input', (e) => {
                        scaleDisplay.textContent = `${e.target.value}%`;
                        previewStyles();
                    });
                }

                // 색상 선택기 이벤트
                ['bg-color', 'text-color', 'border-color', 'hover-bg'].forEach(type => {
                    const colorInput = document.getElementById(`${category}-${type}`);
                    if (colorInput) {
                        colorInput.addEventListener('change', () => previewStyles());
                    }
                });

                // 체크박스 이벤트
                ['shadow', 'hover-effect'].forEach(type => {
                    const checkbox = document.getElementById(`${category}-${type}`);
                    if (checkbox) {
                        checkbox.addEventListener('change', () => previewStyles());
                    }
                });

                // 셀렉트 박스 이벤트 (font-weight)
                const fontWeight = document.getElementById(`${category}-font-weight`);
                if (fontWeight) {
                    fontWeight.addEventListener('change', () => previewStyles());
                }
            });

            // YouTube Live 전용 - 라이브 인디케이터
            const liveIndicator = document.getElementById('youtube-show-live-indicator');
            if (liveIndicator) {
                liveIndicator.addEventListener('change', () => previewStyles());
            }
        }

        function saveStyles() {
            const styles = {};

            ['gpt', 'youtube', 'favorite'].forEach(category => {
                styles[category] = {
                    fontSize: parseInt(document.getElementById(`${category}-font-size`).value),
                    fontWeight: document.getElementById(`${category}-font-weight`).value,
                    bgColor: document.getElementById(`${category}-bg-color`).value,
                    textColor: document.getElementById(`${category}-text-color`).value,
                    borderColor: document.getElementById(`${category}-border-color`).value,
                    borderWidth: parseInt(document.getElementById(`${category}-border-width`).value),
                    borderRadius: parseInt(document.getElementById(`${category}-border-radius`).value),
                    padding: parseInt(document.getElementById(`${category}-padding`).value),
                    gap: parseInt(document.getElementById(`${category}-gap`).value),
                    shadow: document.getElementById(`${category}-shadow`).checked,
                    hoverEffect: document.getElementById(`${category}-hover-effect`).checked,
                    hoverBg: document.getElementById(`${category}-hover-bg`).value,
                    hoverScale: parseInt(document.getElementById(`${category}-hover-scale`).value)
                };
            });

            // YouTube Live 전용 설정
            styles.youtube.showLiveIndicator = document.getElementById('youtube-show-live-indicator').checked;

            localStorage.setItem('linkCardStyles', JSON.stringify(styles));
            showStatus('스타일이 저장되었습니다. 메인 페이지를 새로고침하면 적용됩니다.', 'success');
        }

        function resetStyles() {
            if (confirm('정말로 모든 스타일을 기본값으로 초기화하시겠습니까?')) {
                localStorage.removeItem('linkCardStyles');
                loadSavedStyles();
                previewStyles();
                showStatus('스타일이 초기화되었습니다.', 'success');
            }
        }

        // Fun YouTube 설정 저장
        function saveFunYoutubeSettings() {
            const settings = {
                viewMode: document.getElementById('fun-youtube-view-mode').value,
                gridColumns: parseInt(document.getElementById('fun-youtube-grid-columns').value),
                showThumbnails: document.getElementById('fun-youtube-thumbnails').checked,
                showAuthor: document.getElementById('fun-youtube-author').checked,
                showViewButton: document.getElementById('fun-youtube-view-button').checked,
                fontSize: parseInt(document.getElementById('fun-youtube-font-size').value),
                bgColor: document.getElementById('fun-youtube-bg-color').value,
                textColor: document.getElementById('fun-youtube-text-color').value,
                hoverBgColor: document.getElementById('fun-youtube-hover-bg').value,
                borderRadius: parseInt(document.getElementById('fun-youtube-border-radius').value),
                hoverScale: document.getElementById('fun-youtube-hover-scale').checked
            };

            localStorage.setItem('funYoutubeSettings', JSON.stringify(settings));
            showStatus('Fun YouTube 설정이 저장되었습니다', 'success');
        }

        // Fun YouTube 설정 초기화
        function resetFunYoutubeSettings() {
            const defaultSettings = {
                viewMode: 'list',
                gridColumns: 3,
                showThumbnails: true,
                showAuthor: false,
                showViewButton: false,
                fontSize: 16,
                bgColor: '#1a1a1a',
                textColor: '#ffffff',
                hoverBgColor: '#2a2a2a',
                borderRadius: 8,
                hoverScale: true
            };

            // 폼에 기본값 설정
            document.getElementById('fun-youtube-view-mode').value = defaultSettings.viewMode;
            document.getElementById('fun-youtube-grid-columns').value = defaultSettings.gridColumns;
            document.getElementById('fun-youtube-thumbnails').checked = defaultSettings.showThumbnails;
            document.getElementById('fun-youtube-author').checked = defaultSettings.showAuthor;
            document.getElementById('fun-youtube-view-button').checked = defaultSettings.showViewButton;
            document.getElementById('fun-youtube-font-size').value = defaultSettings.fontSize;
            document.getElementById('fun-youtube-bg-color').value = defaultSettings.bgColor;
            document.getElementById('fun-youtube-text-color').value = defaultSettings.textColor;
            document.getElementById('fun-youtube-hover-bg').value = defaultSettings.hoverBgColor;
            document.getElementById('fun-youtube-border-radius').value = defaultSettings.borderRadius;
            document.getElementById('fun-youtube-hover-scale').checked = defaultSettings.hoverScale;

            localStorage.setItem('funYoutubeSettings', JSON.stringify(defaultSettings));
            showStatus('Fun YouTube 설정이 초기화되었습니다', 'success');
        }

        // Fun YouTube 설정 로드
        function loadFunYoutubeSettings() {
            const defaultSettings = {
                viewMode: 'list',
                gridColumns: 3,
                showThumbnails: true,
                showAuthor: false,
                showViewButton: false,
                fontSize: 16,
                bgColor: '#1a1a1a',
                textColor: '#ffffff',
                hoverBgColor: '#2a2a2a',
                borderRadius: 8,
                hoverScale: true
            };

            const savedSettings = JSON.parse(localStorage.getItem('funYoutubeSettings') || '{}');
            const settings = { ...defaultSettings, ...savedSettings };

            // 폼에 저장된 값 설정
            document.getElementById('fun-youtube-view-mode').value = settings.viewMode;
            document.getElementById('fun-youtube-grid-columns').value = settings.gridColumns;
            document.getElementById('fun-youtube-thumbnails').checked = settings.showThumbnails;
            document.getElementById('fun-youtube-author').checked = settings.showAuthor;
            document.getElementById('fun-youtube-view-button').checked = settings.showViewButton;
            document.getElementById('fun-youtube-font-size').value = settings.fontSize;
            document.getElementById('fun-youtube-bg-color').value = settings.bgColor;
            document.getElementById('fun-youtube-text-color').value = settings.textColor;
            document.getElementById('fun-youtube-hover-bg').value = settings.hoverBgColor;
            document.getElementById('fun-youtube-border-radius').value = settings.borderRadius;
            document.getElementById('fun-youtube-hover-scale').checked = settings.hoverScale;
        }

        function previewStyles() {
            const previewDiv = document.getElementById('style-preview');
            previewDiv.style.display = 'block';

            ['gpt', 'youtube', 'favorite'].forEach(category => {
                const preview = document.getElementById(`${category}-preview`);
                const fontSize = document.getElementById(`${category}-font-size`).value;
                const fontWeight = document.getElementById(`${category}-font-weight`).value;
                const bgColor = document.getElementById(`${category}-bg-color`).value;
                const textColor = document.getElementById(`${category}-text-color`).value;
                const borderColor = document.getElementById(`${category}-border-color`).value;
                const borderWidth = document.getElementById(`${category}-border-width`).value;
                const borderRadius = document.getElementById(`${category}-border-radius`).value;
                const padding = document.getElementById(`${category}-padding`).value;
                const shadow = document.getElementById(`${category}-shadow`).checked;
                const hoverEffect = document.getElementById(`${category}-hover-effect`).checked;
                const hoverBg = document.getElementById(`${category}-hover-bg`).value;
                const hoverScale = document.getElementById(`${category}-hover-scale`).value;

                preview.style.fontSize = `${fontSize}px`;
                preview.style.fontWeight = fontWeight;
                preview.style.backgroundColor = bgColor;
                preview.style.color = textColor;
                preview.style.border = `${borderWidth}px solid ${borderColor}`;
                preview.style.borderRadius = `${borderRadius}px`;
                preview.style.padding = `${padding}px`;
                preview.style.boxShadow = shadow ? '0 2px 8px rgba(0,0,0,0.2)' : 'none';
                preview.style.transition = hoverEffect ? 'all 0.3s ease' : 'none';
                preview.style.cursor = 'pointer';

                // 호버 효과 적용
                if (hoverEffect) {
                    preview.onmouseover = function() {
                        this.style.backgroundColor = hoverBg;
                        this.style.transform = `scale(${hoverScale / 100})`;
                        if (shadow) {
                            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                        }
                    };
                    preview.onmouseout = function() {
                        this.style.backgroundColor = bgColor;
                        this.style.transform = 'scale(1)';
                        if (shadow) {
                            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                        }
                    };
                }
            });
        }

        // 페이지 로드시 인증 확인 후 링크 목록 불러오기
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded event fired');

            // Supabase 초기화 확인 및 재시도
            console.log('[admin-v3] Checking Supabase initialization...');
            console.log('[admin-v3] supabase variable:', typeof supabase !== 'undefined' ? 'defined' : 'undefined');
            console.log('[admin-v3] window.supabase:', window.supabase ? 'available' : 'not available');

            // initializeSupabase 함수 호출
            if (typeof initializeSupabase === 'function') {
                console.log('[admin-v3] Calling initializeSupabase()');
                const initialized = initializeSupabase();
                console.log('[admin-v3] initializeSupabase result:', initialized);
            } else {
                console.error('[admin-v3] initializeSupabase function not found');
            }

            // 여전히 없으면 직접 시도
            if (!supabase && window.supabase && window.supabase.createClient) {
                try {
                    console.log('[admin-v3] Attempting direct initialization');
                    supabase = window.supabase.createClient(
                        'https://ddfnxbkiewolgweivomv.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8'
                    );
                    console.log('[admin-v3] Direct initialization successful');
                } catch (error) {
                    console.error('[admin-v3] Direct initialization failed:', error);
                }
            }

            // 최종 확인
            if (!supabase) {
                console.error('[admin-v3] Failed to initialize Supabase client');
                console.error('[admin-v3] Please check browser console for more details');
                document.getElementById('connection-status').innerHTML = '<span style="color: #f44336;">❌ Supabase 초기화 실패 (콘솔 확인)</span>';
                return;
            }

            console.log('[admin-v3] Supabase client ready:', supabase);

            // 인증 확인
            const hasAccess = await checkAdminAccess();
            if (!hasAccess) {
                return; // 인증 실패시 login.html로 자동 리다이렉트됨
            }

            restoreGuideState(); // 가이드 상태 복원
            restoreDesignSettingsState(); // 디자인 설정 상태 복원
            restoreFunYoutubeSettingsState(); // Fun YouTube 설정 상태 복원
            loadCustomCategories(); // 커스텀 카테고리 로드
            updateCategoryDropdown(); // 카테고리 드롭다운 업데이트
            loadSavedStyles(); // 저장된 스타일 로드
            initStyleControls(); // 스타일 컨트롤 초기화
            loadFunYoutubeSettings(); // Fun YouTube 설정 로드

            await checkConnection();
            await loadLinks();

            // 실시간 업데이트 활성화
            enableRealtimeUpdates();
        });

        // Supabase 연결 확인
        async function checkConnection() {
            const statusElement = document.getElementById('connection-status');

            if (!statusElement) {
                console.error('connection-status element not found');
                return;
            }

            if (!supabase) {
                console.error('Supabase client not initialized');
                statusElement.innerHTML = '<span style="color: #f44336;">❌ Supabase 초기화 실패</span>';
                return;
            }

            try {
                console.log('Checking Supabase connection...');
                const { data, error } = await supabase.from('links').select('count').limit(1);
                if (error) throw error;
                console.log('Supabase connection successful');
                statusElement.innerHTML = '<span style="color: #4caf50;">✅ 연결됨</span>';
            } catch (error) {
                console.error('Supabase connection error:', error);
                statusElement.innerHTML = `<span style="color: #f44336;">❌ 연결 실패: ${error.message}</span>`;
            }
        }

        // 링크 목록 로드
        async function loadLinks() {
            const container = document.getElementById('links-container');

            if (!container) {
                console.error('links-container element not found');
                return;
            }

            console.log('Loading links...');
            container.innerHTML = '<p>로딩 중...</p>';

            try {
                // 모든 링크를 가져오기
                const { data: allLinks, error } = await supabase
                    .from('links')
                    .select('*')
                    .order('category', { ascending: true })
                    .order('position', { ascending: true });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                console.log('Loaded links:', allLinks);

                // 카테고리별로 그룹화
                const linksByCategory = {};
                allLinks.forEach(link => {
                    if (!linksByCategory[link.category]) {
                        linksByCategory[link.category] = [];
                    }
                    linksByCategory[link.category].push(link);
                });

                let html = '';

                // 카테고리 순서 정의 (기본 카테고리 먼저)
                const categoryOrder = ['youtube', 'favorite', 'gpt', 'fun-youtube'];
                const customCats = Object.keys(linksByCategory).filter(cat => !categoryOrder.includes(cat));
                const allCategories = [...categoryOrder, ...customCats];

                // 카테고리 이름 매핑
                const categoryNames = {
                    'youtube': '🎬 YouTube',
                    'favorite': '⭐ Favorites',
                    'gpt': '🤖 GPT Tools',
                    'fun-youtube': '🎮 Fun YouTube'
                };

                // 커스텀 카테고리 이름 추가
                customCategories.forEach(cat => {
                    categoryNames[cat.id] = `📌 ${cat.name}`;
                });

                // 모든 카테고리 렌더링
                allCategories.forEach(category => {
                    if (linksByCategory[category] && linksByCategory[category].length > 0) {
                        const displayName = categoryNames[category] || `📁 ${category}`;
                        html += `<h3 style="margin: 20px 0 10px;">${displayName}</h3>`;
                        html += createTable(linksByCategory[category], category);
                    }
                });

                container.innerHTML = html || '<p>등록된 링크가 없습니다.</p>';

                console.log('Links rendered successfully');

                // 드래그 앤 드롭 초기화
                initSortable();
            } catch (error) {
                console.error('Error loading links:', error);
                container.innerHTML = `<p style="color: #f44336;">오류: ${error.message}</p>`;
            }
        }

        // 테이블 생성
        function createTable(links, category) {
            let html = `<table class="links-table" data-category="${category}">`;
            html += '<thead><tr><th width="30">⇅</th><th width="60">순서</th><th>이름</th><th>URL</th><th width="120">카테고리</th><th width="250">작업</th></tr></thead>';
            html += `<tbody id="sortable-${category}">`;
            
            links.forEach(link => {
                html += `
                    <tr data-id="${link.id}" data-position="${link.position}" data-category="${link.category}" id="row-${link.id}">
                        <td class="drag-handle">≡</td>
                        <td>${link.position || '-'}</td>
                        <td class="name-cell" id="name-${link.id}">${link.name}</td>
                        <td class="url-cell" id="url-${link.id}">
                            <a href="${link.url}" target="_blank">${link.url.substring(0, 50)}${link.url.length > 50 ? '...' : ''}</a>
                        </td>
                        <td class="category-cell" id="category-${link.id}" style="text-align: center; color: #888; font-size: 0.9em;">${link.category}</td>
                        <td class="action-cell" id="actions-${link.id}">
                            <button class="position-btn" onclick="moveUp(${link.id}, ${link.position}, '${category}')">↑</button>
                            <button class="position-btn" onclick="moveDown(${link.id}, ${link.position}, '${category}')">↓</button>
                            <button class="edit-btn" onclick="editLink(${link.id}, '${link.name.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${link.url.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${link.category}')">수정</button>
                            <button class="delete-btn" onclick="removeLink(${link.id})">삭제</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        // 카테고리 목록 가져오기
        function getCategories() {
            const defaultCategories = [
                { id: 'youtube', name: 'YouTube' },
                { id: 'favorite', name: 'Favorite' },
                { id: 'gpt', name: 'GPT Tools' },
                { id: 'fun-youtube', name: 'Fun YouTube' }
            ];

            // 전역 변수 customCategories 사용
            return [...defaultCategories, ...customCategories];
        }

        // 링크 수정 모드
        function editLink(id, name, url, currentCategory) {
            // 이미 다른 항목을 수정 중이면 취소
            if (editingId && editingId !== id) {
                cancelEdit(editingId);
            }

            editingId = id;
            const row = document.getElementById(`row-${id}`);
            row.classList.add('edit-mode');

            // 이름 셀을 입력 필드로 변경
            document.getElementById(`name-${id}`).innerHTML = 
                `<input type="text" class="edit-input" id="edit-name-${id}" value="${name}">`;

            // URL 셀을 입력 필드로 변경
            document.getElementById(`url-${id}`).innerHTML = 
                `<input type="text" class="edit-input" id="edit-url-${id}" value="${url}" style="width: 90%;">`;

            // 카테고리 셀을 선택 박스로 변경
            const categories = getCategories();
            let categoryOptions = '';
            categories.forEach(cat => {
                categoryOptions += `<option value="${cat.id}" ${cat.id === currentCategory ? 'selected' : ''}>${cat.name}</option>`;
            });
            
            document.getElementById(`category-${id}`).innerHTML = 
                `<select class="edit-input" id="edit-category-${id}" style="width: 100px; background: #333; color: #fff; border: 1px solid #444;">
                    ${categoryOptions}
                </select>`;

            // 작업 버튼 변경
            document.getElementById(`actions-${id}`).innerHTML = 
                `<button class="save-btn" onclick="saveEdit(${id})">저장</button>
                 <button class="cancel-btn" onclick="cancelEdit(${id})">취소</button>`;
        }

        // 수정 저장
        async function saveEdit(id) {
            const newName = document.getElementById(`edit-name-${id}`).value;
            const newUrl = document.getElementById(`edit-url-${id}`).value;
            const newCategory = document.getElementById(`edit-category-${id}`).value;

            if (!newName || !newUrl || !newCategory) {
                showStatus('이름, URL, 카테고리를 모두 입력하세요', 'error');
                return;
            }

            const result = await updateLink(id, { 
                name: newName, 
                url: newUrl, 
                category: newCategory 
            });
            
            if (result) {
                showStatus('수정되었습니다', 'success');
                editingId = null;
                await loadLinks();
            } else {
                showStatus('수정 실패', 'error');
            }
        }

        // 수정 취소
        function cancelEdit(id) {
            editingId = null;
            loadLinks();
        }

        // 드래그 앤 드롭 초기화
        function initSortable() {
            // 모든 sortable tbody 요소를 찾아서 초기화
            const allSortables = document.querySelectorAll('[id^="sortable-"]');
            allSortables.forEach(element => {
                const category = element.id.replace('sortable-', '');
                if (element) {
                    new Sortable(element, {
                        handle: '.drag-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: async function(evt) {
                            await updatePositions(category);
                        }
                    });
                }
            });
        }

        // 순서 업데이트
        async function updatePositions(category) {
            const tbody = document.getElementById(`sortable-${category}`);
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            const updates = [];
            
            rows.forEach((row, index) => {
                const id = row.dataset.id;
                const newPosition = index + 1;
                updates.push(updateLink(id, { position: newPosition }));
            });
            
            await Promise.all(updates);
            showStatus('순서가 업데이트되었습니다', 'success');
            await loadLinks();
        }

        // 위로 이동
        async function moveUp(id, currentPos, category) {
            if (currentPos <= 1) return;
            
            const { data: links } = await supabase
                .from('links')
                .select('*')
                .eq('category', category)
                .order('position');
            
            const currentIndex = links.findIndex(l => l.id === id);
            if (currentIndex > 0) {
                const prevLink = links[currentIndex - 1];
                
                await updateLink(id, { position: prevLink.position });
                await updateLink(prevLink.id, { position: currentPos });
                
                await loadLinks();
            }
        }

        // 아래로 이동
        async function moveDown(id, currentPos, category) {
            const { data: links } = await supabase
                .from('links')
                .select('*')
                .eq('category', category)
                .order('position');
            
            const currentIndex = links.findIndex(l => l.id === id);
            if (currentIndex < links.length - 1) {
                const nextLink = links[currentIndex + 1];
                
                await updateLink(id, { position: nextLink.position });
                await updateLink(nextLink.id, { position: currentPos });
                
                await loadLinks();
            }
        }

        // 새 링크 추가
        async function addNewLink() {
            const name = document.getElementById('link-name').value;
            const url = document.getElementById('link-url').value;
            const category = document.getElementById('link-category').value;
            const position = parseInt(document.getElementById('link-position').value) || 999;
            
            if (!name || !url) {
                showStatus('이름과 URL을 입력하세요', 'error');
                return;
            }
            
            const result = await addLink(name, url, category, position);
            
            if (result) {
                showStatus('링크가 추가되었습니다', 'success');
                document.getElementById('link-name').value = '';
                document.getElementById('link-url').value = '';
                document.getElementById('link-position').value = '999';
                await loadLinks();
            } else {
                showStatus('추가 실패', 'error');
            }
        }

        // 링크 삭제
        async function removeLink(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            
            const result = await deleteLink(id);
            
            if (result) {
                showStatus('삭제되었습니다', 'success');
                await loadLinks();
            } else {
                showStatus('삭제 실패', 'error');
            }
        }

        // 상태 메시지 표시
        function showStatus(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
            
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = '';
            }, 3000);
        }

        // 실시간 업데이트는 페이지 로드 후에 활성화
        function enableRealtimeUpdates() {
            if (typeof subscribeToLinks === 'function') {
                subscribeToLinks(async (payload) => {
                    console.log('데이터 변경 감지:', payload);
                    if (!editingId) {  // 수정 중이 아닐 때만 자동 새로고침
                        await loadLinks();
                    }
                });
            } else {
                console.warn('subscribeToLinks function not available');
            }
        }
    </script>
</body>
</html>