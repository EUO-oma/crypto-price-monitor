-- messages í…Œì´ë¸” ìƒì„± ë˜ëŠ” ìˆ˜ì •

-- 1. í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
CREATE TABLE IF NOT EXISTS messages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    message TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ip_hash VARCHAR(64)
);

-- 2. í…Œì´ë¸”ì´ ì´ë¯¸ ìˆê³  content ì»¬ëŸ¼ë§Œ ìˆë‹¤ë©´ message ì»¬ëŸ¼ ì¶”ê°€
DO $$
BEGIN
    -- content ì»¬ëŸ¼ì´ ìˆê³  message ì»¬ëŸ¼ì´ ì—†ëŠ” ê²½ìš°
    IF EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'messages' AND column_name = 'content'
    ) AND NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'messages' AND column_name = 'message'
    ) THEN
        -- contentë¥¼ messageë¡œ ë³µì‚¬
        ALTER TABLE messages ADD COLUMN message TEXT;
        UPDATE messages SET message = content;
        ALTER TABLE messages ALTER COLUMN message SET NOT NULL;
    END IF;
END $$;

-- 3. í•„ìš”í•œ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì¶”ê°€
ALTER TABLE messages ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE messages ADD COLUMN IF NOT EXISTS ip_hash VARCHAR(64);

-- 4. ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages(created_at DESC);

-- 5. RLS í™œì„±í™”
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- 6. ê¸°ì¡´ ì •ì±… ëª¨ë‘ ì‚­ì œ
DROP POLICY IF EXISTS "Enable read access for all users" ON messages;
DROP POLICY IF EXISTS "Enable insert for all users" ON messages;
DROP POLICY IF EXISTS "Enable insert for anonymous users" ON messages;
DROP POLICY IF EXISTS "Anyone can read messages" ON messages;
DROP POLICY IF EXISTS "Anyone can insert messages" ON messages;

-- 7. ìƒˆë¡œìš´ ì •ì±… ìƒì„±
CREATE POLICY "Anyone can read messages" ON messages
    FOR SELECT 
    USING (true);

CREATE POLICY "Anyone can insert messages" ON messages
    FOR INSERT 
    WITH CHECK (true);  -- ì¼ë‹¨ ê¸¸ì´ ì œí•œ ì—†ì´ í—ˆìš©

-- 8. ìµœëŒ€ 100ê°œ ë©”ì‹œì§€ë§Œ ìœ ì§€í•˜ëŠ” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION limit_messages()
RETURNS TRIGGER AS $$
BEGIN
    DELETE FROM messages
    WHERE id IN (
        SELECT id FROM messages
        ORDER BY created_at DESC
        OFFSET 100
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 9. íŠ¸ë¦¬ê±° ìƒì„±
DROP TRIGGER IF EXISTS limit_messages_trigger ON messages;
CREATE TRIGGER limit_messages_trigger
    AFTER INSERT ON messages
    FOR EACH STATEMENT
    EXECUTE FUNCTION limit_messages();

-- 10. í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì‚½ì…
INSERT INTO messages (message) VALUES ('ì±„íŒ… ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤! ğŸ‰');

-- 11. í™•ì¸
SELECT * FROM messages ORDER BY created_at DESC LIMIT 5;