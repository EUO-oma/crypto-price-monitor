<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>CRYPTO Ã— LIVE ğŸ’¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #0a0a0a;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            max-width: 900px;
            width: 100%;
            border: 1px solid #1a1a1a;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5em;
        }

        .exchange-section {
            margin-bottom: 40px;
        }

        h2 {
            color: #aaa;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .price-card {
            background: #1a1a1a;
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid #333;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }

        .price-card:hover {
            transform: translateY(-5px);
            border-color: #555;
        }

        .symbol {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .price {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .timestamp {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .status {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #888;
        }

        .links {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .links a {
            color: #888;
            text-decoration: none;
            margin: 0 15px;
            font-size: 0.9em;
            transition: color 0.3s ease;
        }

        .links a:hover {
            color: #aaa;
            text-decoration: underline;
        }

        #status-message {
            display: inline-block;
            margin-right: 20px;
            font-weight: bold;
        }

        .connected {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
        
        /* YouTube ë¼ì´ë¸Œ ì¸ë””ì¼€ì´í„° ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes livePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 5px rgba(255, 0, 0, 0);
                transform: scale(1.2);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
                transform: scale(1);
            }
        }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ (ì›¹í‚· ë¸Œë¼ìš°ì €) */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin: 5px;
        }
        
        #chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #444 0%, #222 100%);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #555 0%, #333 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        #chat-container::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #666 0%, #444 100%);
        }
        
        /* Firefox ìŠ¤í¬ë¡¤ë°” */
        #chat-container {
            scrollbar-width: thin;
            scrollbar-color: #444 rgba(0, 0, 0, 0.4);
        }
        
        /* ì±„íŒ… ì»¨í…Œì´ë„ˆ í˜¸ë²„ ì‹œ ìŠ¤í¬ë¡¤ë°” ë” ì„ ëª…í•˜ê²Œ */
        #chat-container:hover::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #555 0%, #333 100%);
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        /* ì±„íŒ… ë©”ì‹œì§€ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        .message-content-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 5px;
        }
        
        .my-message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 5px;
        }
        
        .message-time {
            margin-bottom: 5px;
            white-space: nowrap;
        }
        
        /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ (í™”ë©´ ë„ˆë¹„ 768px ì´í•˜) */
        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ì—ì„œ ì „ì²´ í™”ë©´ í™œìš© */
            body {
                padding: 0;
                margin: 0;
            }
            
            .container {
                border-radius: 0;
                padding: 0;
                max-width: 100%;
                border: none;
                box-shadow: none;
            }
            
            /* ì¹´ë“œ ì„¹ì…˜ë“¤ ì—¬ë°± ì œê±° */
            .cards {
                padding: 10px 5px;
                gap: 8px;
            }
            
            .card {
                margin: 0;
                padding: 12px;
            }
            
            /* ì±„íŒ… ì„¹ì…˜ ëª¨ë°”ì¼ ìµœì í™” */
            .chat-section {
                padding: 10px !important;
                margin-top: 15px !important;
                border-radius: 0 !important;
            }
            
            #chat-container {
                border-radius: 10px !important;
                height: 350px !important;
                padding: 10px !important;
            }
            
            /* í—¤ë” ì¹´ë“œ ëª¨ë°”ì¼ ìµœì í™” */
            .header-card {
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 15px !important;
            }
            
            /* í…Œì´ë¸” ì„¹ì…˜ íŒ¨ë”© ì¤„ì´ê¸° */
            table {
                margin: 0 5px;
            }
            
            /* ë§í¬ ì„¹ì…˜ íŒ¨ë”© ì¤„ì´ê¸° */
            div[style*="margin-top: 30px"] {
                margin-top: 15px !important;
                padding: 10px 5px !important;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
            #chat-container::-webkit-scrollbar {
                width: 4px;
                opacity: 0.5;
            }
            
            #chat-container::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .message-content-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }
            
            .my-message-wrapper {
                flex-direction: column-reverse;
                align-items: flex-end;
                gap: 2px;
            }
            
            .message-time {
                margin-bottom: 2px;
                margin-left: 5px;
                font-size: 10px !important;
                opacity: 0.8;
            }
            
            .my-message-wrapper .message-time {
                margin-left: 0;
                margin-right: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” ì¹´ë“œ -->
        <div class="header-card" style="
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
            width: 100%;
            box-sizing: border-box;
        ">
            <div style="text-align: center;">
                <div style="margin-bottom: 15px;">
                    <span style="
                        background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #dda0dd);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        font-size: clamp(1.5em, 4vw, 2.5em);
                        font-weight: 900;
                        font-family: 'Courier New', monospace;
                        letter-spacing: 2px;
                        text-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
                        display: inline-block;
                        animation: glow 3s ease-in-out infinite;
                    ">EUO.NETLIFY.APP</span>
                </div>
                <style>
                    @keyframes glow {
                        0%, 100% { filter: brightness(1) contrast(1); }
                        50% { filter: brightness(1.2) contrast(1.1); }
                    }
                </style>
                
                <!-- ì‹œê³„ ì¹´ë“œë“¤ -->
                <div id="header-update-time" style="margin: 15px 0;"></div>
                
                <div style="margin-top: 10px;">
                    <a href="https://www.weather.go.kr/w/weather/warning/status.do" target="_blank" style="
                        color: #888; 
                        text-decoration: none; 
                        font-size: 0.85em;
                        transition: color 0.3s;
                    " onmouseover="this.style.color='#aaa'" onmouseout="this.style.color='#888'">
                        ğŸŒ¦ï¸ ë‚ ì”¨ëˆ„ë¦¬ íŠ¹ë³´í˜„í™©
                    </a>
                </div>
            </div>
        </div>
        
        <div class="exchange-section">
            <h2><a href="dual-chart.html" style="color: inherit; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.color='#f7931a'" onmouseout="this.style.color='inherit'">ğŸ“ˆ Binance Futures</a></h2>
            <div class="price-grid">
                <a href="chart.html?symbol=BTCUSDT" class="price-card">
                    <div class="symbol"><span style="color: #f7931a;">â‚¿</span> BTC<span style="color: #888; font-size: 0.9em;">USDT</span></div>
                    <div class="price" id="binance-btc">èª­è¾¼ä¸­...</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em;">
                        <span style="color: #aaa;"><span id="btc-high">-</span></span>
                        <span style="color: #aaa;"><span id="btc-low">-</span></span>
                    </div>
                </a>
                <a href="chart.html?symbol=ETHUSDT" class="price-card">
                    <div class="symbol"><span style="color: #627eea;">Î</span> ETH<span style="color: #888; font-size: 0.9em;">USDT</span></div>
                    <div class="price" id="binance-eth">èª­è¾¼ä¸­...</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em;">
                        <span style="color: #aaa;"><span id="eth-high">-</span></span>
                        <span style="color: #aaa;"><span id="eth-low">-</span></span>
                    </div>
                </a>
                <a href="chart.html?symbol=SOLUSDT" class="price-card">
                    <div class="symbol"><span style="color: #00FFA3;">â—</span> SOL<span style="color: #888; font-size: 0.9em;">USDT</span></div>
                    <div class="price" id="binance-sol">èª­è¾¼ä¸­...</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em;">
                        <span style="color: #aaa;"><span id="sol-high">-</span></span>
                        <span style="color: #aaa;"><span id="sol-low">-</span></span>
                    </div>
                </a>
                <a href="chart.html?symbol=XRPUSDT" class="price-card">
                    <div class="symbol"><span style="color: #00aae4;">âœ•</span> XRP<span style="color: #888; font-size: 0.9em;">USDT</span></div>
                    <div class="price" id="binance-xrp">èª­è¾¼ä¸­...</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em;">
                        <span style="color: #aaa;"><span id="xrp-high">-</span></span>
                        <span style="color: #aaa;"><span id="xrp-low">-</span></span>
                    </div>
                </a>
                <a href="chart.html?symbol=AVAXUSDT" class="price-card">
                    <div class="symbol"><span style="color: #e84142;">ğŸ”º</span> AVAX<span style="color: #888; font-size: 0.9em;">USDT</span></div>
                    <div class="price" id="binance-avax">èª­è¾¼ä¸­...</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em;">
                        <span style="color: #aaa;"><span id="avax-high">-</span></span>
                        <span style="color: #aaa;"><span id="avax-low">-</span></span>
                    </div>
                </a>
                <a href="chart.html?symbol=NASDAQ" class="price-card">
                    <div class="symbol"><span style="color: #00a2e8;">ğŸ“ˆ</span> NASDAQ<span style="color: #888; font-size: 0.9em;">100</span></div>
                    <div class="price" id="nasdaq-price">èª­è¾¼ä¸­...</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em;">
                        <span style="color: #aaa;">Day: <span id="nasdaq-change">-</span></span>
                        <span style="color: #aaa;"><span id="nasdaq-percent">-</span></span>
                    </div>
                </a>
            </div>
        </div>

        <!-- ìµëª… ì±„íŒ… ì„¹ì…˜ -->
        <div class="chat-section" style="margin-top: 30px; padding: 20px 0; border-top: 1px solid #333; border-bottom: 1px solid #333;">
            <h2 style="color: #aaa; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                ğŸ’¬ Anonymous Chat
            </h2>
            <div id="chat-container" style="background: linear-gradient(to bottom, #1a1a1a, #0f0f0f); border-radius: 15px; padding: 10px; height: 400px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #333; scroll-behavior: smooth; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);">
                <div id="chat-messages" style="display: flex; flex-direction: column; width: 100%;">
                    <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" 
                    id="chat-input" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                    maxlength="200" 
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                    style="flex: 1; padding: 10px 15px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 20px; font-size: 14px; -webkit-appearance: none; outline: none;"
                    onfocus="this.style.borderColor='#555'" 
                    onblur="this.style.borderColor='#333'">
                <button type="button" 
                    id="chat-send" 
                    onclick="sendMessage()" 
                    style="
                        width: 40px; 
                        height: 40px; 
                        background: #000; 
                        border: 1px solid #333; 
                        border-radius: 50%; 
                        cursor: pointer; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        transition: all 0.2s;
                        -webkit-appearance: none; 
                        touch-action: manipulation;
                        padding: 0;
                    "
                    onmouseover="this.style.transform='scale(1.1)'; this.style.background='#222'" 
                    onmouseout="this.style.transform='scale(1)'; this.style.background='#000'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-left: 2px;">
                        <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="#fff"/>
                    </svg>
                </button>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                ìµëª… ì±„íŒ… â€¢ ë©”ì‹œì§€ëŠ” 7ì¼ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤ â€¢ ìµœëŒ€ 100ê°œ ë©”ì‹œì§€ ìœ ì§€
            </div>
        </div>
        
        <div class="gpt-section" style="margin-top: 20px; padding-bottom: 20px;">
            <h2 style="color: #aaa; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                ğŸ¤– GPT Links
            </h2>
            <div id="gpt-links" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <!-- GPT ë§í¬ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <div class="youtube-section" style="margin-top: 20px; padding-bottom: 20px;">
            <h2 style="color: #aaa; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                <span style="color: #ff0000; font-weight: bold;">â–¶</span> YouTube Live
            </h2>
            <div id="youtube-links" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                <!-- YouTube ë§í¬ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <div class="favorite-section" style="margin-top: 20px; padding-bottom: 20px;">
            <h2 style="color: #aaa; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                â­ Favorite Sites
            </h2>
            <div id="favorite-links" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <!-- Favorite ë§í¬ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <!-- Fun YouTube ì„¹ì…˜ -->
        <div class="fun-youtube-section" style="margin-top: 20px; padding-bottom: 20px;">
            <h2 style="color: #aaa; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                ğŸ® Fun YouTube
            </h2>
            <div id="fun-youtube-links" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <!-- Fun YouTube ë§í¬ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <!-- ì»¤ìŠ¤í…€ ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        <div id="custom-category-sections"></div>
        
        <!-- BTC 10ì¼ ê°€ê²© ê¸°ë¡ ì„¹ì…˜ -->
        <div class="btc-history-section" style="margin-top: 20px; padding: 20px; background: #0a0a0a; border-radius: 15px; border: 1px solid #333;">
            <h3 style="color: #aaa; margin-bottom: 15px;">
                <span style="color: #f7931a;">â‚¿</span> BTC ìµœê·¼ 10ì¼ ê¸°ë¡
            </h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="border-bottom: 2px solid #333;">
                            <th style="padding: 10px; text-align: left; color: #888;">ë‚ ì§œ</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ìµœê³ ê°€</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ìµœì €ê°€</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ì¢…ê°€</th>
                        </tr>
                    </thead>
                    <tbody id="btc-history-tbody">
                        <tr>
                            <td colspan="4" style="padding: 20px; text-align: center; color: #666;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ETH 10ì¼ ê°€ê²© ê¸°ë¡ ì„¹ì…˜ -->
        <div class="eth-history-section" style="margin-top: 20px; padding: 20px; background: #0a0a0a; border-radius: 15px; border: 1px solid #333;">
            <h3 style="color: #aaa; margin-bottom: 15px;">
                <span style="color: #627eea;">Î</span> ETH ìµœê·¼ 10ì¼ ê¸°ë¡
            </h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="border-bottom: 2px solid #333;">
                            <th style="padding: 10px; text-align: left; color: #888;">ë‚ ì§œ</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ìµœê³ ê°€</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ìµœì €ê°€</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ì¢…ê°€</th>
                        </tr>
                    </thead>
                    <tbody id="eth-history-tbody">
                        <tr>
                            <td colspan="4" style="padding: 20px; text-align: center; color: #666;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SOL 10ì¼ ê°€ê²© ê¸°ë¡ ì„¹ì…˜ -->
        <div class="sol-history-section" style="margin-top: 20px; padding: 20px; background: #0a0a0a; border-radius: 15px; border: 1px solid #333;">
            <h3 style="color: #aaa; margin-bottom: 15px;">
                <span style="color: #00FFA3;">â—</span> SOL ìµœê·¼ 10ì¼ ê¸°ë¡
            </h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="border-bottom: 2px solid #333;">
                            <th style="padding: 10px; text-align: left; color: #888;">ë‚ ì§œ</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ìµœê³ ê°€</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ìµœì €ê°€</th>
                            <th style="padding: 10px; text-align: right; color: #aaa;">ì¢…ê°€</th>
                        </tr>
                    </thead>
                    <tbody id="sol-history-tbody">
                        <tr>
                            <td colspan="4" style="padding: 20px; text-align: center; color: #666;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-loader.js"></script>
    <script>
        let binanceBtcWs = null;
        let binanceEthWs = null;
        let binanceXrpWs = null;
        let binanceSolWs = null;
        let binanceAvaxWs = null;

        function formatPrice(price) {
            // null, undefined, ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
            if (price === null || price === undefined || price === '') {
                return '-';
            }
            
            const num = parseFloat(price);
            
            // NaN ì²´í¬
            if (isNaN(num)) {
                return '-';
            }
            
            const parts = num.toFixed(2).split('.');
            const integerPart = parseInt(parts[0]).toLocaleString('en-US');
            return `<span>${integerPart}</span><span style="color: #666; font-size: 0.8em;">.${parts[1]}</span>`;
        }


        function updateLastUpdate() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const dateString = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            
            // Header update time with multiple timezones
            const headerTimeElement = document.getElementById('header-update-time');
            if (headerTimeElement) {
                // Calculate different timezones
                const korTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                const euTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/London"}));
                const usTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                
                // Format times
                const formatTime = (date) => {
                    const h = date.getHours();
                    const m = date.getMinutes().toString().padStart(2, '0');
                    const s = date.getSeconds().toString().padStart(2, '0');
                    const ap = h >= 12 ? 'PM' : 'AM';
                    const displayH = h % 12 || 12;
                    return {hours: displayH, minutes: m, seconds: s, ampm: ap};
                };
                
                const kor = formatTime(korTime);
                const eu = formatTime(euTime);
                const us = formatTime(usTime);
                
                // US Market hours (9:30 AM - 4:00 PM ET)
                const marketHour = usTime.getHours();
                const marketMin = usTime.getMinutes();
                let marketStatus = '';
                
                if ((marketHour === 9 && marketMin >= 30) || (marketHour > 9 && marketHour < 16)) {
                    marketStatus = '<span style="color: #4caf50;">ğŸŸ¢ Market Open</span>';
                } else if (marketHour < 9 || (marketHour === 9 && marketMin < 30)) {
                    const openTime = new Date(usTime);
                    openTime.setHours(9, 30, 0);
                    const diff = Math.floor((openTime - usTime) / 60000);
                    if (diff > 0) {
                        marketStatus = `<span style="color: #ff9800;">â° Opens in ${Math.floor(diff/60)}h ${diff%60}m</span>`;
                    }
                } else {
                    marketStatus = '<span style="color: #f44336;">ğŸ”´ Market Closed</span>';
                }
                
                headerTimeElement.innerHTML = `
                    <div style="text-align: center;">
                        <div style="
                            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #dda0dd);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            font-size: 1.2em;
                            font-weight: bold;
                            margin-bottom: 15px;
                        ">${dateString}</div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 0 auto 10px;">
                            <div style="
                                background: #0a0a0a;
                                color: white;
                                padding: 15px 10px;
                                border-radius: 10px;
                                text-align: center;
                                border: 1px solid #333;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onclick="window.open('fullscreen-clock.html?tz=Asia/Seoul', '_blank')" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#555'" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#333'">
                                <div style="color: #888; font-size: 0.9em; margin-bottom: 8px; font-weight: bold;">KOR</div>
                                <div style="font-size: 1.4em; font-weight: bold; line-height: 1;">
                                    ${kor.hours}:${kor.minutes}<span style="font-size: 0.6em; color: #666;">:${kor.seconds}</span>
                                    <span style="font-size: 0.5em; color: #666; margin-left: 3px;">${kor.ampm}</span>
                                </div>
                            </div>
                            
                            <div style="
                                background: #0a0a0a;
                                color: white;
                                padding: 15px 10px;
                                border-radius: 10px;
                                text-align: center;
                                border: 1px solid #333;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onclick="window.open('fullscreen-clock.html?tz=Europe/London', '_blank')" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#555'" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#333'">
                                <div style="color: #888; font-size: 0.9em; margin-bottom: 8px; font-weight: bold;">LON</div>
                                <div style="font-size: 1.4em; font-weight: bold; line-height: 1;">
                                    ${eu.hours}:${eu.minutes}<span style="font-size: 0.6em; color: #666;">:${eu.seconds}</span>
                                    <span style="font-size: 0.5em; color: #666; margin-left: 3px;">${eu.ampm}</span>
                                </div>
                            </div>
                            
                            <div style="
                                background: #0a0a0a;
                                color: white;
                                padding: 15px 10px;
                                border-radius: 10px;
                                text-align: center;
                                border: 1px solid #333;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onclick="window.open('fullscreen-clock.html?tz=America/New_York', '_blank')" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#555'" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#333'">
                                <div style="color: #888; font-size: 0.9em; margin-bottom: 8px; font-weight: bold;">NYC</div>
                                <div style="font-size: 1.4em; font-weight: bold; line-height: 1;">
                                    ${us.hours}:${us.minutes}<span style="font-size: 0.6em; color: #666;">:${us.seconds}</span>
                                    <span style="font-size: 0.5em; color: #666; margin-left: 3px;">${us.ampm}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.85em; margin-top: 10px;">
                            ${marketStatus}
                        </div>
                    </div>
                `;
            }
        }

        // Binance WebSocket
        function connectBinance() {
            const symbols = ['btcusdt', 'ethusdt', 'solusdt', 'xrpusdt', 'avaxusdt'];
            
            symbols.forEach(symbol => {
                const ws = new WebSocket(`wss://fstream.binance.com/ws/${symbol}@ticker`);
                

                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.c) {
                        const price = data.c;
                        const high = data.h;  // 24ì‹œê°„ ìµœê³ ê°€
                        const low = data.l;   // 24ì‹œê°„ ìµœì €ê°€
                        
                        // ì‹¬ë³¼ ì´ë¦„ ì¶”ì¶œ (btc, eth, xrp ë“±)
                        const coinName = symbol.replace('usdt', '');
                        const fullSymbol = symbol.toUpperCase() + 'USDT';
                        
                        // ê°€ê²© ê¸°ë¡ ì—…ë°ì´íŠ¸ (BTC, ETH, SOLë§Œ)
                        if (fullSymbol === 'BTCUSDT' || fullSymbol === 'ETHUSDT' || fullSymbol === 'SOLUSDT') {
                            if (currentPrices[fullSymbol]) {
                                currentPrices[fullSymbol].current = parseFloat(price);
                                currentPrices[fullSymbol].high = Math.max(currentPrices[fullSymbol].high || 0, parseFloat(high));
                                currentPrices[fullSymbol].low = Math.min(currentPrices[fullSymbol].low || 999999999, parseFloat(low));
                            }
                        }
                        
                        // ê°€ê²© ì—…ë°ì´íŠ¸
                        const priceElement = document.getElementById(`binance-${coinName}`);
                        if (priceElement) {
                            priceElement.innerHTML = formatPrice(price);
                            priceElement.classList.remove('loading');
                        }
                        
                        // ìµœê³ ê°€/ìµœì €ê°€ ì—…ë°ì´íŠ¸
                        const highElement = document.getElementById(`${coinName}-high`);
                        const lowElement = document.getElementById(`${coinName}-low`);
                        if (highElement && high) {
                            highElement.innerHTML = formatPrice(high);
                        }
                        if (lowElement && low) {
                            lowElement.innerHTML = formatPrice(low);
                        }
                        
                        // ê°€ê²© ê¸°ë¡ ì €ì¥ (ë§¤ì¼ ìì •)
                        if (symbol === 'btcusdt') {
                            saveBTCDailyPrice(high, low, price);
                        } else if (symbol === 'ethusdt') {
                            saveETHDailyPrice(high, low, price);
                        } else if (symbol === 'solusdt') {
                            saveSOLDailyPrice(high, low, price);
                        }
                        
                        updateLastUpdate();
                    }
                };

                ws.onerror = function(error) {
                    console.error('Binance WebSocket error:', error);
                };

                if (symbol === 'btcusdt') {
                    binanceBtcWs = ws;
                } else if (symbol === 'ethusdt') {
                    binanceEthWs = ws;
                } else if (symbol === 'xrpusdt') {
                    binanceXrpWs = ws;
                } else if (symbol === 'solusdt') {
                    binanceSolWs = ws;
                } else if (symbol === 'avaxusdt') {
                    binanceAvaxWs = ws;
                }
            });
        }

        // ì´ˆê¸° ë¡œë”© í´ë˜ìŠ¤ ì¶”ê°€
        document.querySelectorAll('.price').forEach(el => {
            el.classList.add('loading');
        });

        // WebSocket ì—°ê²° ì‹œì‘
        connectBinance();
        
        // Supabaseì—ì„œ ë§í¬ ë°ì´í„° ë¡œë“œ
        async function loadLinksFromSupabase() {
            console.log('Loading links from Supabase...');
            console.log('Supabase URL:', typeof SUPABASE_URL !== 'undefined' ? SUPABASE_URL : 'NOT DEFINED');
            console.log('Supabase client:', typeof supabase !== 'undefined' ? 'Initialized' : 'NOT INITIALIZED');
            
            try {
                const { data: links, error } = await window.supabaseClient.from('links')
                    .select('*')
                    .order('position', { ascending: true });
                
                if (error) {
                    console.error('Supabase error:', error);
                    console.error('Error details:', error.message, error.code);
                    throw error;
                }
                
                console.log('Links loaded:', links);
                console.log('Total links count:', links ? links.length : 0);
                
                // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë§í¬ ë¶„ë¥˜
                const gptLinks = links ? links.filter(link => link.category === 'gpt') : [];
                const youtubeLinks = links ? links.filter(link => link.category === 'youtube') : [];
                const favoriteLinks = links ? links.filter(link => link.category === 'favorite') : [];
                const funYoutubeLinks = links ? links.filter(link => link.category === 'fun-youtube') : [];
                
                // ì»¤ìŠ¤í…€ ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
                const customCategories = JSON.parse(localStorage.getItem('customCategories') || '[]');
                const customCategoryLinks = {};
                customCategories.forEach(cat => {
                    customCategoryLinks[cat.id] = links ? links.filter(link => link.category === cat.id) : [];
                });
                
                console.log('GPT links:', gptLinks.length);
                console.log('YouTube links:', youtubeLinks.length);
                console.log('Favorite links:', favoriteLinks.length);
                console.log('Fun YouTube links:', funYoutubeLinks.length);
                console.log('Custom categories:', customCategories);
                
                // GPT ë§í¬ ë Œë”ë§
                const gptContainer = document.getElementById('gpt-links');
                if (gptContainer) {
                    if (gptLinks.length > 0) {
                        gptContainer.innerHTML = gptLinks.map(link => `
                            <a href="${link.url}" target="_blank" style="
                                background: #1a1a1a;
                                color: white;
                                padding: 15px;
                                border-radius: 10px;
                                text-align: center;
                                border: 1px solid #333;
                                text-decoration: none;
                                transition: transform 0.3s ease;
                                display: block;
                            ">
                                <div style="font-size: 1em;">${link.name}</div>
                            </a>
                        `).join('');
                    } else {
                        gptContainer.innerHTML = '<div style="color: #666; text-align: center;">ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                    }
                }
                
                // YouTube ë§í¬ ë Œë”ë§
                const youtubeContainer = document.getElementById('youtube-links');
                if (youtubeContainer) {
                    if (youtubeLinks.length > 0) {
                        youtubeContainer.innerHTML = youtubeLinks.map(link => `
                        <a href="${link.url}" target="_blank" style="
                            background: #1a1a1a;
                            color: white;
                            padding: 15px;
                            border-radius: 10px;
                            text-align: center;
                            border: 1px solid #333;
                            text-decoration: none;
                            transition: transform 0.3s ease;
                            display: block;
                            position: relative;
                        ">
                            <div style="font-size: 1.1em; font-weight: bold;">${link.name}</div>
                            <span class="live-indicator" data-channel-url="${link.url}" style="
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                width: 10px;
                                height: 10px;
                                border-radius: 50%;
                                background: #666;
                                animation: none;
                            "></span>
                        </a>
                        `).join('');
                        
                        // YouTube ë¼ì´ë¸Œ ìƒíƒœ ì²´í¬
                        checkYouTubeLiveStatus();
                    } else {
                        youtubeContainer.innerHTML = '<div style="color: #666; text-align: center;">ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                    }
                }
                
                // Favorite ë§í¬ ë Œë”ë§
                const favoriteContainer = document.getElementById('favorite-links');
                if (favoriteContainer) {
                    if (favoriteLinks.length > 0) {
                        favoriteContainer.innerHTML = favoriteLinks.map(link => `
                        <a href="${link.url}" target="_blank" style="
                            background: #1a1a1a;
                            color: white;
                            padding: 15px;
                            border-radius: 10px;
                            text-align: center;
                            border: 1px solid #333;
                            text-decoration: none;
                            transition: transform 0.3s ease;
                            display: block;
                        ">
                            <div style="font-size: 1em;">${link.name}</div>
                        </a>
                        `).join('');
                    } else {
                        favoriteContainer.innerHTML = '<div style="color: #666; text-align: center;">ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                    }
                }
                
                // Fun YouTube ë§í¬ ë Œë”ë§
                const funYoutubeContainer = document.getElementById('fun-youtube-links');
                if (funYoutubeContainer) {
                    if (funYoutubeLinks.length > 0) {
                        funYoutubeContainer.innerHTML = funYoutubeLinks.map(link => `
                        <a href="${link.url}" target="_blank" style="
                            background: #1a1a1a;
                            color: white;
                            padding: 15px;
                            border-radius: 10px;
                            text-align: center;
                            border: 1px solid #333;
                            text-decoration: none;
                            transition: transform 0.3s ease;
                            display: block;
                        ">
                            <div style="font-size: 1em;">${link.name}</div>
                        </a>
                        `).join('');
                    } else {
                        funYoutubeContainer.innerHTML = '<div style="color: #666; text-align: center;">ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                    }
                }
                
                // ì»¤ìŠ¤í…€ ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ ë Œë”ë§
                const customSectionsContainer = document.getElementById('custom-category-sections');
                if (customSectionsContainer && customCategories.length > 0) {
                    customSectionsContainer.innerHTML = '';
                    
                    customCategories.forEach(category => {
                        const categoryLinks = customCategoryLinks[category.id] || [];
                        
                        if (categoryLinks.length > 0) {
                            const section = document.createElement('div');
                            section.className = 'custom-category-section';
                            section.style.cssText = 'margin-top: 20px; padding-bottom: 20px;';
                            
                            section.innerHTML = `
                                <h2 style="color: #aaa; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                                    ğŸ“Œ ${category.name}
                                </h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    ${categoryLinks.map(link => `
                                        <a href="${link.url}" target="_blank" style="
                                            background: #1a1a1a;
                                            color: white;
                                            padding: 15px;
                                            border-radius: 10px;
                                            text-align: center;
                                            border: 1px solid #333;
                                            text-decoration: none;
                                            transition: transform 0.3s ease;
                                            display: block;
                                        ">
                                            <div style="font-size: 1em;">${link.name}</div>
                                        </a>
                                    `).join('')}
                                </div>
                            `;
                            
                            customSectionsContainer.appendChild(section);
                        }
                    });
                }
                
            } catch (error) {
                console.error('ë§í¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('Error stack:', error.stack);
                
                // ì—ëŸ¬ ë°œìƒì‹œ ë¹ˆ ì»¨í…Œì´ë„ˆì— ë©”ì‹œì§€ í‘œì‹œ
                const gptContainer = document.getElementById('gpt-links');
                if (gptContainer && gptContainer.innerHTML === '') {
                    gptContainer.innerHTML = '<div style="color: #666;">ë§í¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
                }
            }
        }
        
        // YouTube ë¼ì´ë¸Œ ìƒíƒœ ì²´í¬ í•¨ìˆ˜
        async function checkYouTubeLiveStatus() {
            const indicators = document.querySelectorAll('.live-indicator');
            
            indicators.forEach(async (indicator) => {
                const channelUrl = indicator.getAttribute('data-channel-url');
                
                // URLì—ì„œ ì±„ë„ ì •ë³´ ì¶”ì¶œ
                try {
                    // CORS ì œí•œìœ¼ë¡œ ì¸í•´ ì§ì ‘ ì²´í¬ê°€ ì–´ë ¤ìš°ë¯€ë¡œ,
                    // í”„ë¡ì‹œ ì„œë²„ë‚˜ YouTube APIë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
                    // ì¼ë‹¨ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ êµ¬í˜„
                    
                    // ì‹¤ì œ êµ¬í˜„ì‹œ YouTube Data API v3 ì‚¬ìš© í•„ìš”
                    // ì—¬ê¸°ì„œëŠ” URLì— '/live'ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë¼ì´ë¸Œë¡œ ê°€ì •
                    const isLive = channelUrl.includes('/live');
                    
                    if (isLive) {
                        // ë¼ì´ë¸Œ ì¤‘ - ë¹¨ê°„ìƒ‰ ì› + ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜
                        indicator.style.background = '#ff0000';
                        indicator.style.animation = 'livePulse 1.5s infinite';
                        indicator.title = 'ğŸ”´ LIVE';
                    } else {
                        // ì˜¤í”„ë¼ì¸ - íšŒìƒ‰ ì›
                        indicator.style.background = '#666';
                        indicator.style.animation = 'none';
                        indicator.title = 'âš« Offline';
                    }
                } catch (error) {
                    console.error('ë¼ì´ë¸Œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                }
            });
        }
        
        // BTC ê°€ê²© ê¸°ë¡ ì €ì¥ (í•˜ë£¨ì— í•œ ë²ˆ)
        let btcDailyData = {};
        let lastSavedDate = null;
        
        function saveBTCDailyPrice(high, low, close) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // ì˜¤ëŠ˜ ë°ì´í„° ì—…ë°ì´íŠ¸
            btcDailyData = {
                high: high,
                low: low,
                close: close
            };
            
            // ìì •ì´ ë˜ë©´ DBì— ì €ì¥
            if (now.getHours() === 0 && now.getMinutes() < 1 && lastSavedDate !== today) {
                saveBTCToSupabase(today, high, low, close);
                lastSavedDate = today;
            }
        }
        
        // Supabaseì— BTC ê°€ê²© ì €ì¥
        async function saveBTCToSupabase(date, high, low, close) {
            try {
                const { error } = await window.supabaseClient.from('price_history')
                    .upsert({
                        symbol: 'BTCUSDT',
                        date: date,
                        high_price: parseFloat(high),
                        low_price: parseFloat(low),
                        close_price: parseFloat(close)
                    }, {
                        onConflict: 'symbol,date'
                    });
                
                if (!error) {
                    loadBTCHistory(); // ì €ì¥ í›„ ìƒˆë¡œê³ ì¹¨
                }
            } catch (err) {
                console.error('BTC ê°€ê²© ì €ì¥ ì‹¤íŒ¨:', err);
            }
        }
        
        // ETH ê°€ê²© ê¸°ë¡ ì €ì¥ (í•˜ë£¨ì— í•œ ë²ˆ)
        let ethDailyData = {};
        let ethLastSavedDate = null;
        
        function saveETHDailyPrice(high, low, close) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            ethDailyData = { high, low, close };
            
            if (now.getHours() === 0 && now.getMinutes() < 1 && ethLastSavedDate !== today) {
                saveToSupabase('ETHUSDT', today, high, low, close);
                ethLastSavedDate = today;
            }
        }
        
        // SOL ê°€ê²© ê¸°ë¡ ì €ì¥ (í•˜ë£¨ì— í•œ ë²ˆ)
        let solDailyData = {};
        let solLastSavedDate = null;
        
        function saveSOLDailyPrice(high, low, close) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            solDailyData = { high, low, close };
            
            if (now.getHours() === 0 && now.getMinutes() < 1 && solLastSavedDate !== today) {
                saveToSupabase('SOLUSDT', today, high, low, close);
                solLastSavedDate = today;
            }
        }
        
        // í˜„ì¬ ê°€ê²© ì¶”ì 
        let currentPrices = {
            BTCUSDT: { high: 0, low: 999999999, current: 0 },
            ETHUSDT: { high: 0, low: 999999999, current: 0 },
            SOLUSDT: { high: 0, low: 999999999, current: 0 }
        };
        
        // ê³µí†µ Supabase ì €ì¥ í•¨ìˆ˜
        async function saveToSupabase(symbol, date, high, low, close) {
            try {
                const { error } = await window.supabaseClient.from('price_history')
                    .upsert({
                        symbol: symbol,
                        date: date,
                        high_price: parseFloat(high),
                        low_price: parseFloat(low),
                        price: parseFloat(close)  // close_price -> priceë¡œ ìˆ˜ì •
                    }, {
                        onConflict: 'symbol,date'
                    });
                
                if (!error) {
                    if (symbol === 'BTCUSDT') loadBTCHistory();
                    else if (symbol === 'ETHUSDT') loadETHHistory();
                    else if (symbol === 'SOLUSDT') loadSOLHistory();
                }
            } catch (err) {
                console.error(`${symbol} ê°€ê²© ì €ì¥ ì‹¤íŒ¨:`, err);
            }
        }
        
        // BTC 10ì¼ ê°€ê²© ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadBTCHistory() {
            console.log('BTC ê¸°ë¡ ë¡œë“œ ì‹œì‘');
            try {
                const { data, error } = await window.supabaseClient.from('price_history')
                    .select('*')
                    .eq('symbol', 'BTCUSDT')
                    .order('date', { ascending: false })
                    .limit(10);
                
                console.log('BTC ë°ì´í„°:', data);
                console.log('BTC ì—ëŸ¬:', error);
                
                if (error) throw error;
                
                const tbody = document.getElementById('btc-history-tbody');
                if (!tbody) {
                    console.error('btc-history-tbody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                if (data && data.length > 0) {
                    tbody.innerHTML = data.map(record => {
                        // ê°€ê²© í¬ë§· í•¨ìˆ˜ (HTML ì—†ì´)
                        const formatPriceSimple = (price) => {
                            if (price === null || price === undefined || price === '') return '-';
                            const num = parseFloat(price);
                            if (isNaN(num)) return '-';
                            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        };
                        
                        const dateObj = new Date(record.date + 'T00:00:00');
                        const month = dateObj.getMonth() + 1;
                        const day = dateObj.getDate();
                        const dateStr = `${month}.${day}`;

                        return `
                        <tr style="border-bottom: 1px solid #222;">
                            <td style="padding: 8px; color: #888;">${dateStr}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.high_price)}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.low_price)}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.price)}</td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #666;">ì•„ì§ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (error) {
                console.error('BTC ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const tbody = document.getElementById('btc-history-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            }
        }
        
        // ETH 10ì¼ ê°€ê²© ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadETHHistory() {
            try {
                const { data, error } = await window.supabaseClient.from('price_history')
                    .select('*')
                    .eq('symbol', 'ETHUSDT')
                    .order('date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const tbody = document.getElementById('eth-history-tbody');
                if (!tbody) return;
                
                if (data && data.length > 0) {
                    tbody.innerHTML = data.map(record => {
                        // ê°€ê²© í¬ë§· í•¨ìˆ˜ (HTML ì—†ì´)
                        const formatPriceSimple = (price) => {
                            if (price === null || price === undefined || price === '') return '-';
                            const num = parseFloat(price);
                            if (isNaN(num)) return '-';
                            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        };
                        
                        const dateObj = new Date(record.date + 'T00:00:00');
                        const month = dateObj.getMonth() + 1;
                        const day = dateObj.getDate();
                        const dateStr = `${month}.${day}`;

                        return `
                        <tr style="border-bottom: 1px solid #222;">
                            <td style="padding: 8px; color: #888;">${dateStr}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.high_price)}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.low_price)}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.price)}</td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #666;">ì•„ì§ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (error) {
                console.error('ETH ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // SOL 10ì¼ ê°€ê²© ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSOLHistory() {
            try {
                const { data, error } = await window.supabaseClient.from('price_history')
                    .select('*')
                    .eq('symbol', 'SOLUSDT')
                    .order('date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const tbody = document.getElementById('sol-history-tbody');
                if (!tbody) return;
                
                if (data && data.length > 0) {
                    tbody.innerHTML = data.map(record => {
                        // ê°€ê²© í¬ë§· í•¨ìˆ˜ (HTML ì—†ì´)
                        const formatPriceSimple = (price) => {
                            if (price === null || price === undefined || price === '') return '-';
                            const num = parseFloat(price);
                            if (isNaN(num)) return '-';
                            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        };
                        
                        const dateObj = new Date(record.date + 'T00:00:00');
                        const month = dateObj.getMonth() + 1;
                        const day = dateObj.getDate();
                        const dateStr = `${month}.${day}`;

                        return `
                        <tr style="border-bottom: 1px solid #222;">
                            <td style="padding: 8px; color: #888;">${dateStr}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.high_price)}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.low_price)}</td>
                            <td style="padding: 8px; text-align: right; color: #fff;">$${formatPriceSimple(record.price)}</td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #666;">ì•„ì§ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (error) {
                console.error('SOL ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ì±„íŒ… ê¸°ëŠ¥
        let chatChannel = null;
        
        // ë¸Œë¼ìš°ì € fingerprint ìƒì„± (ëª¨ë°”ì¼ í˜¸í™˜ ë²„ì „)
        function getBrowserFingerprint() {
            // localStorageì—ì„œ ê¸°ì¡´ ID í™•ì¸ (ì˜êµ¬ ë³´ì¡´)
            let storedId = localStorage.getItem('persistent_browser_id');
            
            if (storedId) {
                console.log('ê¸°ì¡´ Browser ID ì‚¬ìš©:', storedId);
                return storedId;
            }
            
            // ìƒˆ ID ìƒì„± (ì²˜ìŒ ì ‘ì†ì‹œ)
            try {
                const isMobile = /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);
                const deviceType = isMobile ? 'M' : 'D'; // Mobile ë˜ëŠ” Desktop
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substring(2, 9);
                
                // í˜•ì‹: M_timestamp_random ë˜ëŠ” D_timestamp_random
                const newId = `${deviceType}_${timestamp}_${randomStr}`;
                
                // localStorageì— ì˜êµ¬ ì €ì¥
                localStorage.setItem('persistent_browser_id', newId);
                localStorage.setItem('browser_id', newId); // í˜¸í™˜ì„±ì„ ìœ„í•´ ë‘ ê³³ì— ì €ì¥
                
                console.log('ìƒˆ Browser ID ìƒì„±:', newId, {
                    ë””ë°”ì´ìŠ¤: isMobile ? 'ëª¨ë°”ì¼' : 'ë°ìŠ¤í¬íƒ‘',
                    í™”ë©´: `${screen.width}x${screen.height}`,
                    ì–¸ì–´: navigator.language
                });
                
                return newId;
            } catch (e) {
                // ì—ëŸ¬ ë°œìƒì‹œ ê°„ë‹¨í•œ ID ìƒì„±
                const fallbackId = 'F_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 5);
                localStorage.setItem('persistent_browser_id', fallbackId);
                console.error('Browser ID ìƒì„± ì—ëŸ¬, fallback ì‚¬ìš©:', fallbackId);
                return fallbackId;
            }
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ
        async function loadChatMessages() {
            try {
                console.log('ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘...');
                const { data, error } = await window.supabaseClient.from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);
                
                if (error) {
                    console.error('ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                    const messagesContainer = document.getElementById('chat-messages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = `<div style="color: #f44; padding: 10px;">ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
                    }
                    return;
                }
                
                console.log('ë¡œë“œëœ ë©”ì‹œì§€:', data);
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    if (data && data.length > 0) {
                        messagesContainer.innerHTML = data.map(msg => createMessageElement(msg)).join('');
                    } else {
                        messagesContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</div>';
                    }
                    scrollToBottom();
                }
            } catch (error) {
                console.error('ì±„íŒ… ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `<div style="color: #f44; padding: 10px;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
                }
            }
        }
        
        // ì½”ì¸ ëª©ë¡ - ì•ˆì •ì ì¸ CDN ì´ë¯¸ì§€ URL ì‚¬ìš©  
        const coinAvatars = [
            { id: 'btc', name: 'Bitcoin', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/btc.png', color: '#f7931a' },
            { id: 'eth', name: 'Ethereum', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/eth.png', color: '#627eea' },
            { id: 'bnb', name: 'BNB', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/bnb.png', color: '#f3ba2f' },
            { id: 'xrp', name: 'XRP', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/xrp.png', color: '#23292f' },
            { id: 'sol', name: 'Solana', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/sol.png', color: '#14f195' },
            { id: 'ada', name: 'Cardano', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/ada.png', color: '#0033ad' },
            { id: 'doge', name: 'Dogecoin', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/doge.png', color: '#c3a634' },
            { id: 'avax', name: 'Avalanche', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/avax.png', color: '#e84142' },
            { id: 'dot', name: 'Polkadot', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/dot.png', color: '#e6007a' },
            { id: 'matic', name: 'Polygon', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/matic.png', color: '#8247e5' },
            { id: 'link', name: 'Chainlink', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/link.png', color: '#2a5ada' },
            { id: 'uni', name: 'Uniswap', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/uni.png', color: '#ff007a' },
            { id: 'atom', name: 'Cosmos', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/atom.png', color: '#2e3148' },
            { id: 'ltc', name: 'Litecoin', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/ltc.png', color: '#bfbbbb' },
            { id: 'xlm', name: 'Stellar', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/xlm.png', color: '#14b8a6' },
            { id: 'algo', name: 'Algorand', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/algo.png', color: '#000000' },
            { id: 'vet', name: 'VeChain', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/vet.png', color: '#15bdff' },
            { id: 'icp', name: 'ICP', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/icp.png', color: '#29abe2' },
            { id: 'fil', name: 'Filecoin', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/fil.png', color: '#0090ff' },
            { id: 'sand', name: 'Sandbox', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/sand.png', color: '#04adef' },
            { id: 'mana', name: 'Decentraland', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/mana.png', color: '#ff2d55' },
            { id: 'trx', name: 'Tron', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/trx.png', color: '#ff0013' },
            { id: 'near', name: 'NEAR', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/near.png', color: '#000000' },
            { id: 'mkr', name: 'Maker', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/mkr.png', color: '#1aab9b' },
            { id: 'aave', name: 'Aave', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/aave.png', color: '#b6509e' },
            { id: 'crv', name: 'Curve', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/crv.png', color: '#fffc33' },
            { id: 'grt', name: 'The Graph', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/grt.png', color: '#6f4cff' },
            { id: 'shib', name: 'Shiba Inu', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/shib.png', color: '#fda32b' },
            { id: 'ftm', name: 'Fantom', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/ftm.png', color: '#1969ff' },
            { id: 'eos', name: 'EOS', image: 'https://cdn.jsdelivr.net/gh/Pymmdrza/Cryptocurrency_Logos@mainx/PNG/eos.png', color: '#000000' }
        ];
        
        // ì‚¬ìš©ìë³„ ê³ ì • ì½”ì¸ ì•„ë°”íƒ€ í• ë‹¹
        const userAvatarMap = {}; // ì‚¬ìš©ì ID -> ì½”ì¸ ì•„ë°”íƒ€ ë§µí•‘
        const usedAvatarIndices = new Set(); // ì´ë¯¸ ì‚¬ìš©ëœ ì•„ë°”íƒ€ ì¸ë±ìŠ¤
        
        function getCoinAvatar(userId) {
            // userIdê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’(ë¹„íŠ¸ì½”ì¸) ë°˜í™˜
            if (!userId || userId === 'undefined' || userId === 'null') {
                return coinAvatars[0]; // ê¸°ë³¸ê°’ì€ ë¹„íŠ¸ì½”ì¸
            }
            
            // ì´ë¯¸ í• ë‹¹ëœ ì•„ë°”íƒ€ê°€ ìˆìœ¼ë©´ ë°˜í™˜
            if (userAvatarMap[userId]) {
                return userAvatarMap[userId];
            }
            
            // ìƒˆë¡œìš´ ì‚¬ìš©ìì—ê²Œ ì½”ì¸ í• ë‹¹
            let avatarIndex;
            
            // ì•„ì§ ì‚¬ìš© ì•ˆ ëœ ì½”ì¸ì´ ìˆìœ¼ë©´ ìˆœì°¨ì ìœ¼ë¡œ í• ë‹¹
            if (usedAvatarIndices.size < coinAvatars.length) {
                for (let i = 0; i < coinAvatars.length; i++) {
                    if (!usedAvatarIndices.has(i)) {
                        avatarIndex = i;
                        break;
                    }
                }
            } else {
                // ëª¨ë“  ì½”ì¸ì´ ì‚¬ìš© ì¤‘ì´ë©´ í•´ì‹œ ê¸°ë°˜ í• ë‹¹
                let hashNum = 0;
                for (let i = 0; i < Math.min(userId.length, 10); i++) {
                    hashNum += userId.charCodeAt(i) * (i + 1);
                }
                avatarIndex = hashNum % coinAvatars.length;
            }
            
            // avatarIndexê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
            if (avatarIndex === undefined || avatarIndex < 0 || avatarIndex >= coinAvatars.length) {
                avatarIndex = 0;
            }
            
            // ì•„ë°”íƒ€ í• ë‹¹ ë° ì €ì¥
            const avatar = coinAvatars[avatarIndex];
            userAvatarMap[userId] = avatar;
            usedAvatarIndices.add(avatarIndex);
            
            // localStorageì—ë„ ì €ì¥ (ì˜êµ¬ ë³´ì¡´)
            try {
                const savedMappings = JSON.parse(localStorage.getItem('userCoinAvatars') || '{}');
                savedMappings[userId] = avatarIndex;
                localStorage.setItem('userCoinAvatars', JSON.stringify(savedMappings));
            } catch (e) {
                console.error('ì•„ë°”íƒ€ ë§µí•‘ ì €ì¥ ì‹¤íŒ¨:', e);
            }
            
            return avatar;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë§µí•‘ ë³µì›
        function loadSavedAvatarMappings() {
            try {
                const savedMappings = JSON.parse(localStorage.getItem('userCoinAvatars') || '{}');
                for (const [userId, avatarIndex] of Object.entries(savedMappings)) {
                    if (avatarIndex < coinAvatars.length) {
                        userAvatarMap[userId] = coinAvatars[avatarIndex];
                        usedAvatarIndices.add(avatarIndex);
                    }
                }
                console.log('ì½”ì¸ ì•„ë°”íƒ€ ë§µí•‘ ë³µì›:', Object.keys(userAvatarMap).length, 'ëª…');
            } catch (e) {
                console.error('ì•„ë°”íƒ€ ë§µí•‘ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„± (ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼)
        function createMessageElement(message) {
            const time = new Date(message.created_at).toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ fingerprintì™€ ë¹„êµ
            const currentBrowserId = getBrowserFingerprint();
            const isMyMessage = message.browser_id === currentBrowserId || 
                               message.browser_id === localStorage.getItem('chat_browser_id');
            
            // ë¸Œë¼ìš°ì € ID ì €ì¥ (ì¼ê´€ì„± ìœ ì§€)
            if (isMyMessage && message.browser_id) {
                localStorage.setItem('chat_browser_id', message.browser_id);
            }
            
            // ë””ë°”ì´ìŠ¤ ì •ë³´ í‘œì‹œ í…ìŠ¤íŠ¸
            let deviceInfo = '';
            if (message.device_type || message.browser_name) {
                const parts = [];
                if (message.device_type) {
                    const icon = message.device_type === 'Mobile' ? 'ğŸ“±' : 
                                message.device_type === 'Tablet' ? 'ğŸ“‹' : 'ğŸ’»';
                    parts.push(icon + ' ' + message.device_type);
                }
                if (message.browser_name) parts.push(message.browser_name);
                if (message.os_name) parts.push(message.os_name);
                if (parts.length > 0) {
                    deviceInfo = parts.join(' Â· ');
                }
            }
            
            // ì‚¬ìš©ìì˜ ì½”ì¸ ì•„ë°”íƒ€ ê°€ì ¸ì˜¤ê¸° (browser_id ê¸°ë°˜)
            const userIdentifier = message.browser_id || message.ip_hash || `user_${message.id}`;
            const coinAvatar = getCoinAvatar(userIdentifier);
            
            if (isMyMessage) {
                // ë‚´ ë©”ì‹œì§€ (ì¢Œì¸¡ ì •ë ¬ë¡œ ë³€ê²½) - ì „ì²´ ë„ˆë¹„ ì‚¬ìš©
                return `
                    <div data-message-id="${message.id}" style="
                        display: flex;
                        margin-bottom: 10px;
                        width: 100%;
                    ">
                        <div style="
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            margin-right: 8px;
                            background: ${coinAvatar.color || '#fff'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                            position: relative;
                            flex-shrink: 0;
                        ">
                            <img src="${coinAvatar.image}"
                                style="
                                    width: 100%;
                                    height: 100%;
                                    object-fit: contain;
                                    padding: 4px;
                                "
                                alt="${coinAvatar.name}"
                                onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9IiNmN2EwMGMiLz48dGV4dCB4PSI1MCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7CpzwvdGV4dD48L3N2Zz4='">
                        </div>
                        <div style="
                            flex-grow: 1;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            min-width: 0;
                            width: calc(100% - 44px);
                        ">
                            <div class="message-bubble" style="
                                background: #1a1a1a;
                                color: #fff;
                                padding: 8px 12px;
                                border-radius: 15px;
                                border-top-left-radius: 4px;
                                font-size: 14px;
                                line-height: 1.4;
                                word-wrap: break-word;
                                border: 1px solid #444;
                                flex-grow: 1;
                                min-width: 0;
                            ">
                                ${escapeHtml(message.message)}
                            </div>
                            <span class="message-time" style="color: #666; font-size: 11px; flex-shrink: 0; width: 45px;">
                                ${time}
                            </span>
                        </div>
                    </div>
                `;
            } else {
                // ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ (ì™¼ìª½ ì •ë ¬)
                return `
                    <div data-message-id="${message.id}" style="
                        display: flex;
                        margin-bottom: 10px;
                        width: 100%;
                    ">
                        <div style="
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            margin-right: 8px;
                            background: ${coinAvatar.color || '#fff'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                            position: relative;
                            flex-shrink: 0;
                        ">
                            <img src="${coinAvatar.image}"
                                style="
                                    width: 100%;
                                    height: 100%;
                                    object-fit: contain;
                                    padding: 4px;
                                "
                                alt="${coinAvatar.name}"
                                onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9IiNmN2EwMGMiLz48dGV4dCB4PSI1MCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7CpzwvdGV4dD48L3N2Zz4='">
                        </div>
                        <div style="
                            flex-grow: 1;
                            display: flex;
                            flex-direction: column;
                            gap: 2px;
                            min-width: 0;
                            width: calc(100% - 44px);
                        ">
                            ${deviceInfo ? `<div style="color: #888; font-size: 11px; margin-left: 5px;">${deviceInfo}</div>` : ''}
                            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <div class="message-bubble" style="
                                    background: #000;
                                    color: #fff;
                                    padding: 8px 12px;
                                    border-radius: 15px;
                                    border-top-left-radius: 4px;
                                    font-size: 14px;
                                    line-height: 1.4;
                                    word-wrap: break-word;
                                    border: 1px solid #333;
                                    flex-grow: 1;
                                    min-width: 0;
                                ">
                                    ${escapeHtml(message.message)}
                                </div>
                                <span class="message-time" style="color: #666; font-size: 11px; flex-shrink: 0; width: 45px;">
                                    ${time}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // ë©”ì‹œì§€ ì „ì†¡ (ë””ë²„ê¹… í¬í•¨)
        async function sendMessage() {
            console.log('sendMessage í•¨ìˆ˜ ì‹œì‘');
            
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send');
            
            console.log('ì…ë ¥ ìš”ì†Œ:', input);
            console.log('ë²„íŠ¼ ìš”ì†Œ:', sendButton);
            console.log('ì…ë ¥ê°’:', input?.value);
            
            if (!input || !input.value.trim()) {
                console.log('ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìŒ');
                return;
            }
            
            const message = input.value.trim();
            console.log('ì „ì†¡í•  ë©”ì‹œì§€:', message);
            
            // UI ìƒíƒœ ë³€ê²½
            if (sendButton) {
                sendButton.disabled = true;
                sendButton.style.opacity = '0.5';
            }
            
            try {
                console.log('Supabase ì „ì†¡ ì‹œì‘');
                
                // browser_id ìƒì„± (ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€)
                const browserId = getBrowserFingerprint();
                console.log('ë©”ì‹œì§€ ì „ì†¡ì‹œ Browser ID:', browserId);
                
                // ë©”ì‹œì§€ ì „ì†¡
                const { data, error } = await window.supabaseClient.from('messages')
                    .insert([{ 
                        message: message,
                        browser_id: browserId
                    }])
                    .select();
                
                console.log('Supabase ì‘ë‹µ:', { data, error });
                
                if (error) {
                    console.error('ì „ì†¡ ì—ëŸ¬ ìƒì„¸:', error);
                    
                    // í…Œì´ë¸” êµ¬ì¡° ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ browser_id ì—†ì´ ì¬ì‹œë„
                    console.log('browser_id ì—†ì´ ì¬ì‹œë„');
                    const { data: retryData, error: retryError } = await window.supabaseClient.from('messages')
                        .insert([{ message: message }])
                        .select();
                    
                    if (retryError) {
                        console.error('ì¬ì‹œë„ë„ ì‹¤íŒ¨:', retryError);
                        alert(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨\nì—ëŸ¬: ${retryError.message}\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
                    } else {
                        console.log('ì¬ì‹œë„ ì„±ê³µ:', retryData);
                        input.value = '';
                        await loadChatMessages();
                    }
                } else {
                    console.log('ì „ì†¡ ì„±ê³µ:', data);
                    input.value = '';
                    await loadChatMessages();
                }
                
            } catch (error) {
                console.error('ì˜ˆì™¸ ë°œìƒ:', error);
                alert('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ë²„íŠ¼ ì¬í™œì„±í™”
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.style.opacity = '1';
                }
            }
        }
        
        // ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
        function subscribeToChatUpdates() {
            console.log('ì±„íŒ… ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘');
            
            // ê¸°ì¡´ ì±„ë„ êµ¬ë… í•´ì œ
            if (chatChannel) {
                chatChannel.unsubscribe();
            }
            
            chatChannel = window.supabaseClient.channel('chat-channel-' + Date.now())
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' },
                    (payload) => {
                        console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', payload);
                        const messagesContainer = document.getElementById('chat-messages');
                        if (messagesContainer && payload.new) {
                            // ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                            const existingMessage = document.querySelector(`[data-message-id="${payload.new.id}"]`);
                            if (!existingMessage) {
                                messagesContainer.innerHTML += createMessageElement(payload.new);
                                scrollToBottom();
                            }
                            
                            // 100ê°œ ì´ìƒì´ë©´ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±°
                            const messages = messagesContainer.children;
                            while (messages.length > 100) {
                                messages[0].remove();
                            }
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('ì±„íŒ… êµ¬ë… ìƒíƒœ:', status);
                });
        
            // 20ì´ˆë§ˆë‹¤ ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨ (fallback)
            setInterval(async () => {
                await loadChatMessages();
            }, 20000);
        }
        
        // ì±„íŒ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupChatListeners() {
            console.log('ì±„íŒ… ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
            
            const input = document.getElementById('chat-input');
            const button = document.getElementById('chat-send');
            
            if (input) {
                console.log('ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ì„¤ì •');
                
                // Enter í‚¤ ì²˜ë¦¬
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        console.log('Enter í‚¤ ê°ì§€');
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì¶”ê°€ ë³´ì¥)
            if (button) {
                console.log('ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •');
                
                // ê¸°ì¡´ onclick ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€
                button.onclick = null;
                
                // í´ë¦­ ì´ë²¤íŠ¸
                button.addEventListener('click', (e) => {
                    console.log('ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸');
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage();
                });
                
                // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼)
                button.addEventListener('touchend', (e) => {
                    console.log('ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸');
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage();
                });
            }
        }
        
        // ë‚˜ìŠ¤ë‹¥ ì§€ìˆ˜ ê°€ì ¸ì˜¤ê¸° (Yahoo Finance API ëŒ€ì²´)
        async function fetchNasdaqData() {
            try {
                // Alpha Vantage ë¬´ë£Œ API ì‚¬ìš© (ì¼ì¼ ì œí•œ ìˆìŒ)
                // ë˜ëŠ” ë‹¤ë¥¸ ë°©ë²•: finnhub.io, twelvedata.com ë“±
                
                // ê°„ë‹¨í•œ ëŒ€ì²´ ë°©ë²•: ê³ ì •ê°’ í‘œì‹œ ë˜ëŠ” ì™¸ë¶€ API
                // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ ê³ ì •ê°’ í‘œì‹œ
                const nasdaqElement = document.getElementById('nasdaq-price');
                const changeElement = document.getElementById('nasdaq-change');
                const percentElement = document.getElementById('nasdaq-percent');
                
                // ì‹¤ì‹œê°„ APIê°€ í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì¶”ê°€ ê°€ëŠ¥
                // ì˜ˆì‹œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” APIë¥¼ í†µí•´ ê°€ì ¸ì™€ì•¼ í•¨)
                if (nasdaqElement) {
                    // ëœë¤ ë³€ë™ ì‹œë®¬ë ˆì´ì…˜ (ì„ì‹œ)
                    const basePrice = 20000;
                    const variation = Math.random() * 200 - 100;
                    const currentPrice = basePrice + variation;
                    const change = variation;
                    const changePercent = (variation / basePrice * 100);
                    
                    nasdaqElement.innerHTML = formatPrice(currentPrice.toFixed(2));
                    nasdaqElement.classList.remove('loading');
                    
                    if (changeElement && percentElement) {
                        changeElement.innerHTML = `${change >= 0 ? '+' : ''}${change.toFixed(2)}`;
                        changeElement.style.color = change >= 0 ? '#4caf50' : '#f44336';
                        
                        percentElement.innerHTML = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                        percentElement.style.color = changePercent >= 0 ? '#4caf50' : '#f44336';
                    }
                }
            } catch (error) {
                console.error('NASDAQ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                const nasdaqElement = document.getElementById('nasdaq-price');
                if (nasdaqElement) {
                    nasdaqElement.innerHTML = 'N/A';
                    nasdaqElement.classList.remove('loading');
                }
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ë§í¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', () => {
            // ì €ì¥ëœ ì•„ë°”íƒ€ ë§µí•‘ ë³µì›
            loadSavedAvatarMappings();
            
            loadLinksFromSupabase();
            loadBTCHistory(); // BTC ê°€ê²© ê¸°ë¡ ë¡œë“œ
            loadETHHistory(); // ETH ê°€ê²© ê¸°ë¡ ë¡œë“œ
            loadSOLHistory(); // SOL ê°€ê²© ê¸°ë¡ ë¡œë“œ
            
            // ë‚˜ìŠ¤ë‹¥ ë°ì´í„° ë¡œë“œ
            fetchNasdaqData();
            // 1ë¶„ë§ˆë‹¤ ë‚˜ìŠ¤ë‹¥ ì—…ë°ì´íŠ¸ (ì‹¤ì œ API ì‚¬ìš© ì‹œ)
            setInterval(fetchNasdaqData, 60000);
            
            // ì±„íŒ… ê¸°ëŠ¥ ì´ˆê¸°í™”
            loadChatMessages();
            setupChatListeners();
            subscribeToChatUpdates();
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë… (ì„ íƒì‚¬í•­)
            const subscription = window.supabaseClient.channel('links-channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'links' }, 
                    () => {
                        loadLinksFromSupabase(); // ë³€ê²½ì‚¬í•­ ë°œìƒì‹œ ìë™ ìƒˆë¡œê³ ì¹¨
                    }
                )
                .subscribe();
            
            // ê°€ê²© ê¸°ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            const priceHistorySubscription = window.supabaseClient.channel('price-history-channel')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'price_history' },
                    (payload) => {
                        if (payload.new && payload.new.symbol === 'BTCUSDT') loadBTCHistory();
                        if (payload.new && payload.new.symbol === 'ETHUSDT') loadETHHistory();
                        if (payload.new && payload.new.symbol === 'SOLUSDT') loadSOLHistory();
                    }
                )
                .subscribe();
        });
        
        // 5ë¶„ë§ˆë‹¤ YouTube ë¼ì´ë¸Œ ìƒíƒœ ì¬í™•ì¸
        setInterval(() => {
            checkYouTubeLiveStatus();
        }, 300000);

        // ì—°ê²° ìƒíƒœ ì²´í¬ (30ì´ˆë§ˆë‹¤)
        setInterval(() => {
            if (binanceBtcWs && binanceBtcWs.readyState !== WebSocket.OPEN) {
                connectBinance();
            }
        }, 30000);
        
        // ê°€ê²© ê¸°ë¡ ì €ì¥ í•¨ìˆ˜ (5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰)
        async function savePriceHistory() {
            const today = new Date().toISOString().split('T')[0];
            console.log('ê°€ê²© ê¸°ë¡ ìë™ ì €ì¥:', today, currentPrices);
            
            // BTC ì €ì¥
            if (currentPrices.BTCUSDT && currentPrices.BTCUSDT.current > 0) {
                await saveToSupabase('BTCUSDT', today, 
                    currentPrices.BTCUSDT.high, 
                    currentPrices.BTCUSDT.low, 
                    currentPrices.BTCUSDT.current);
            }
            
            // ETH ì €ì¥
            if (currentPrices.ETHUSDT && currentPrices.ETHUSDT.current > 0) {
                await saveToSupabase('ETHUSDT', today,
                    currentPrices.ETHUSDT.high, 
                    currentPrices.ETHUSDT.low, 
                    currentPrices.ETHUSDT.current);
            }
            
            // SOL ì €ì¥
            if (currentPrices.SOLUSDT && currentPrices.SOLUSDT.current > 0) {
                await saveToSupabase('SOLUSDT', today,
                    currentPrices.SOLUSDT.high, 
                    currentPrices.SOLUSDT.low, 
                    currentPrices.SOLUSDT.current);
            }
        }
        
        // 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
        setInterval(savePriceHistory, 300000);
        
        // ì´ˆê¸° ì‹¤í–‰ (20ì´ˆ í›„ - WebSocket ì—°ê²° í›„)
        setTimeout(savePriceHistory, 20000);
    </script>
    
    <!-- ê´€ë¦¬ì ì„¤ì • ë²„íŠ¼ -->
    <a href="../admin-links.html" class="settings-btn" title="ê´€ë¦¬ì ì„¤ì •">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M20.46 20.46l-4.24-4.24M1.54 20.46l4.24-4.24M22 12h-6m-6 0H1"></path>
        </svg>
    </a>
    
    <style>
        .settings-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            transform: rotate(90deg);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }
        
        .settings-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .settings-btn {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
            }
            
            .settings-btn svg {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</body>
</html>