<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>애니메이션 추천 보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 20px;
            border: 1px solid #333;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #e50914 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #888;
            font-size: 1.1em;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            color: #888;
        }

        .nav-tab.active {
            background: #e50914;
            border-color: #e50914;
            color: #fff;
            transform: translateY(-2px);
        }

        .nav-tab:hover {
            background: #2a2a2a;
            color: #fff;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-container {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #333;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9em;
            font-weight: 500;
        }

        label .required {
            color: #e50914;
        }

        input[type="text"],
        input[type="number"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #e50914;
            box-shadow: 0 0 0 2px rgba(229, 9, 20, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        select {
            cursor: pointer;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .star {
            font-size: 24px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
            transform: scale(1.1);
        }

        /* Image Upload */
        .image-upload {
            margin-top: 8px;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-item {
            position: relative;
            padding-top: 60%;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .image-item .remove-btn:hover {
            background: #e50914;
            transform: scale(1.1);
        }

        /* Buttons */
        .btn {
            background: #e50914;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            background: #f40612;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(229, 9, 20, 0.3);
        }

        .btn-secondary {
            background: #333;
        }

        .btn-secondary:hover {
            background: #444;
        }

        /* Anime List */
        .anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .anime-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .anime-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-color: #e50914;
        }

        .anime-poster {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #0a0a0a;
        }

        .anime-info {
            padding: 20px;
        }

        .anime-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .anime-subtitle {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .anime-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
        }

        .anime-platform {
            background: #e50914;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            display: inline-block;
            margin-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 1000px;
            margin: 50px auto;
            background: #1a1a1a;
            border-radius: 20px;
            border: 1px solid #333;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            position: relative;
            height: 300px;
            background: #0a0a0a;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
        }

        .modal-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
        }

        .modal-header-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }

        .modal-body {
            padding: 30px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .modal-close:hover {
            background: #e50914;
            transform: rotate(90deg);
        }

        .detail-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #333;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h3 {
            color: #e50914;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #222;
        }

        .detail-label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #fff;
            font-size: 1em;
        }

        /* Screenshots Gallery */
        .screenshot-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .screenshot-item {
            position: relative;
            padding-top: 56.25%;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .screenshot-item:hover {
            transform: scale(1.05);
            border-color: #e50914;
        }

        .screenshot-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid #333;
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Status Messages */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
            z-index: 2000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .status-success {
            background: #4caf50;
        }

        .status-error {
            background: #f44336;
        }

        .status-warning {
            background: #ff9800;
        }

        /* Tag Input */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            min-height: 48px;
            align-items: center;
        }

        .tag {
            background: #e50914;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag .remove-tag {
            cursor: pointer;
            font-size: 16px;
        }

        .tag-input {
            border: none;
            background: none;
            outline: none;
            color: #fff;
            flex: 1;
            min-width: 100px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .modal-content {
                margin: 20px;
                border-radius: 15px;
            }

            .anime-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🎬 애니메이션 추천 보드</h1>
            <p>넷플릭스, 디즈니+ 등에서 볼만한 작품들을 공유해보세요</p>
            <div id="auth-status" style="margin-top: 20px; text-align: center; color: #666;">
                <span id="auth-text">로그인하지 않음</span>
                <button id="auth-btn" class="btn btn-secondary" style="margin-left: 10px; padding: 8px 16px; font-size: 14px;" onclick="toggleAuth()">로그인</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('list')">
                <i class="fas fa-list"></i> 작품 목록
            </div>
            <div class="nav-tab" onclick="switchTab('add')">
                <i class="fas fa-plus"></i> 작품 추가
            </div>
            <div class="nav-tab" onclick="switchTab('stats')">
                <i class="fas fa-chart-bar"></i> 통계
            </div>
        </div>

        <!-- List Section -->
        <div class="section active" id="list-section">
            <div class="anime-grid" id="anime-grid">
                <div class="loading">작품 목록을 불러오는 중...</div>
            </div>
        </div>

        <!-- Add Section -->
        <div class="section" id="add-section">
            <div class="form-container">
                <h2 style="margin-bottom: 30px;">새 작품 추가</h2>
                
                <form id="anime-form">
                    <!-- 기본 정보 -->
                    <h3 style="color: #e50914; margin-bottom: 20px;">📌 기본 정보</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>제목 <span class="required">*</span></label>
                            <input type="text" id="title" required placeholder="예: 스파이더맨: 어크로스 더 스파이더버스">
                        </div>
                        
                        <div class="form-group">
                            <label>부제목 / 원제</label>
                            <input type="text" id="subtitle" placeholder="예: Spider-Man: Across the Spider-Verse">
                        </div>
                        
                        <div class="form-group">
                            <label>제작년도 <span class="required">*</span></label>
                            <input type="number" id="year" required min="1900" max="2030" placeholder="2023">
                        </div>
                        
                        <div class="form-group">
                            <label>시즌/화수</label>
                            <input type="text" id="episodes" placeholder="예: 시즌 1 (12화)">
                        </div>
                        
                        <div class="form-group">
                            <label>플랫폼 <span class="required">*</span></label>
                            <select id="platform" required>
                                <option value="">선택하세요</option>
                                <option value="넷플릭스">넷플릭스</option>
                                <option value="디즈니+">디즈니+</option>
                                <option value="왓챠">왓챠</option>
                                <option value="웨이브">웨이브</option>
                                <option value="티빙">티빙</option>
                                <option value="애플TV+">애플TV+</option>
                                <option value="아마존 프라임">아마존 프라임</option>
                                <option value="극장">극장</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>장르 (태그 형식)</label>
                            <div class="tag-input-container" id="genre-tags">
                                <input type="text" class="tag-input" placeholder="엔터키로 추가" 
                                       onkeypress="handleTagInput(event, 'genre-tags')">
                            </div>
                        </div>
                    </div>

                    <!-- 제작 정보 -->
                    <h3 style="color: #e50914; margin: 30px 0 20px;">🎬 제작 정보</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>감독</label>
                            <input type="text" id="director" placeholder="예: 호아킴 도스 산토스, 켐프 파워스">
                        </div>
                        
                        <div class="form-group">
                            <label>제작사</label>
                            <input type="text" id="studio" placeholder="예: 소니 픽처스 애니메이션">
                        </div>
                        
                        <div class="form-group">
                            <label>원작</label>
                            <input type="text" id="original" placeholder="예: 마블 코믹스">
                        </div>
                        
                        <div class="form-group">
                            <label>주요 성우/출연진</label>
                            <input type="text" id="cast" placeholder="예: 샤메익 무어, 헤일리 스타인펠드">
                        </div>
                    </div>

                    <!-- 평가 정보 -->
                    <h3 style="color: #e50914; margin: 30px 0 20px;">⭐ 평가 정보</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>평점</label>
                            <div class="star-rating" id="rating">
                                <span class="star" data-value="1">☆</span>
                                <span class="star" data-value="2">☆</span>
                                <span class="star" data-value="3">☆</span>
                                <span class="star" data-value="4">☆</span>
                                <span class="star" data-value="5">☆</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>추천 연령</label>
                            <select id="age_rating">
                                <option value="">선택하세요</option>
                                <option value="전체">전체 관람가</option>
                                <option value="7+">7세 이상</option>
                                <option value="12+">12세 이상</option>
                                <option value="15+">15세 이상</option>
                                <option value="19+">청소년 관람불가</option>
                            </select>
                        </div>
                    </div>

                    <!-- 상세 정보 -->
                    <h3 style="color: #e50914; margin: 30px 0 20px;">📝 상세 정보</h3>
                    <div class="form-group full-width">
                        <label>줄거리</label>
                        <textarea id="synopsis" rows="4" placeholder="작품의 줄거리를 간단히 소개해주세요"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>시청 포인트</label>
                        <textarea id="highlights" rows="3" placeholder="이 작품의 매력이나 주목할 만한 점을 알려주세요"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>인상 깊은 장면</label>
                        <textarea id="memorable_scenes" rows="3" placeholder="특별히 기억에 남는 장면이나 시퀀스를 설명해주세요"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>명대사</label>
                        <textarea id="quotes" rows="3" placeholder="감동적이거나 인상적인 대사를 공유해주세요"></textarea>
                    </div>

                    <!-- 스타일 정보 -->
                    <h3 style="color: #e50914; margin: 30px 0 20px;">🎨 비주얼 & 스타일</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>작화 스타일</label>
                            <input type="text" id="art_style" placeholder="예: 코믹북 스타일, 2D/3D 혼합">
                        </div>
                        
                        <div class="form-group">
                            <label>색감/분위기</label>
                            <input type="text" id="color_mood" placeholder="예: 네온 컬러, 다크톤">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>OST/음악</label>
                            <textarea id="music" rows="2" placeholder="인상적인 OST나 음악에 대해 설명해주세요"></textarea>
                        </div>
                    </div>

                    <!-- 미디어 -->
                    <h3 style="color: #e50914; margin: 30px 0 20px;">🖼️ 미디어</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>포스터 URL</label>
                            <input type="url" id="poster_url" placeholder="https://...">
                        </div>
                        
                        <div class="form-group">
                            <label>트레일러 URL</label>
                            <input type="url" id="trailer_url" placeholder="https://youtube.com/...">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>스크린샷 (최대 5장)</label>
                            <input type="file" id="screenshots" multiple accept="image/*" class="image-upload">
                            <div class="image-preview" id="screenshot-preview"></div>
                        </div>
                    </div>

                    <!-- 개인 메모 -->
                    <h3 style="color: #e50914; margin: 30px 0 20px;">💭 개인 감상</h3>
                    <div class="form-group full-width">
                        <label>감상평</label>
                        <textarea id="review" rows="4" placeholder="작품을 보고 느낀 개인적인 감상을 자유롭게 작성해주세요"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>추천 대상</label>
                        <input type="text" id="recommend_to" placeholder="예: 히어로물을 좋아하는 사람, 가족과 함께 보기 좋은 작품을 찾는 사람">
                    </div>

                    <!-- Submit Buttons -->
                    <div style="margin-top: 40px;">
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> 작품 등록
                        </button>
                        <button type="reset" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo"></i> 초기화
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="section" id="stats-section">
            <div class="form-container">
                <h2>📊 통계</h2>
                <div id="stats-content">
                    <div class="loading">통계를 불러오는 중...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modal-content">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ddfnxbkiewolgweivomv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let selectedRating = 0;
        let genreTags = [];
        let screenshotFiles = [];
        let animeList = [];
        let currentUser = null;

        // Initialize
        async function init() {
            setupEventListeners();
            
            // Check for OAuth callback
            if (window.location.hash && window.location.hash.includes('access_token')) {
                console.log('OAuth 콜백 처리 중...');
                // Supabase가 자동으로 처리하도록 대기
                setTimeout(async () => {
                    await checkAuth();
                    await loadAnimeList();
                    // Clear the hash
                    window.history.replaceState(null, '', window.location.pathname);
                }, 1000);
            } else {
                await checkAuth();
                await loadAnimeList();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.value);
                    updateStarRating();
                });
            });

            // Form submission
            document.getElementById('anime-form').addEventListener('submit', handleSubmit);

            // Screenshot upload
            document.getElementById('screenshots').addEventListener('change', handleScreenshots);
        }

        // Update star rating display
        function updateStarRating() {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < selectedRating) {
                    star.textContent = '★';
                    star.classList.add('active');
                } else {
                    star.textContent = '☆';
                    star.classList.remove('active');
                }
            });
        }

        // Switch tabs
        function switchTab(tab) {
            // Check if user is authenticated for 'add' tab
            if (tab === 'add' && !currentUser) {
                showStatus('작품을 추가하려면 로그인이 필요합니다', 'error');
                loginWithGoogle();
                return;
            }
            
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');

            // Update sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');

            // Load content if needed
            if (tab === 'list') {
                loadAnimeList();
            } else if (tab === 'stats') {
                loadStats();
            }
        }

        // Handle tag input
        function handleTagInput(event, containerId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();
                
                if (value && !genreTags.includes(value)) {
                    genreTags.push(value);
                    renderTags(containerId);
                    input.value = '';
                }
            }
        }

        // Render tags
        function renderTags(containerId) {
            const container = document.getElementById(containerId);
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());

            genreTags.forEach((tag, index) => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="remove-tag" onclick="removeTag(${index}, '${containerId}')">&times;</span>
                `;
                container.insertBefore(tagElement, container.querySelector('.tag-input'));
            });
        }

        // Remove tag
        function removeTag(index, containerId) {
            genreTags.splice(index, 1);
            renderTags(containerId);
        }

        // Handle screenshot upload
        function handleScreenshots(event) {
            const files = Array.from(event.target.files).slice(0, 5);
            screenshotFiles = files;
            
            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `
                        <img src="${e.target.result}" alt="Screenshot ${index + 1}">
                        <button class="remove-btn" onclick="removeScreenshot(${index})">&times;</button>
                    `;
                    preview.appendChild(item);
                };
                reader.readAsDataURL(file);
            });
        }

        // Remove screenshot
        function removeScreenshot(index) {
            screenshotFiles.splice(index, 1);
            const input = document.getElementById('screenshots');
            const dt = new DataTransfer();
            screenshotFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            handleScreenshots({ target: input });
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            // Check authentication first
            if (!currentUser) {
                showStatus('작품을 추가하려면 로그인이 필요합니다', 'error');
                loginWithGoogle();
                return;
            }
            
            try {
                showStatus('작품을 등록하는 중...', 'warning');
                
                // Collect form data
                const formData = {
                    title: document.getElementById('title').value,
                    subtitle: document.getElementById('subtitle').value,
                    year: parseInt(document.getElementById('year').value),
                    episodes: document.getElementById('episodes').value,
                    platform: document.getElementById('platform').value,
                    genres: genreTags,
                    director: document.getElementById('director').value,
                    studio: document.getElementById('studio').value,
                    original: document.getElementById('original').value,
                    cast_info: document.getElementById('cast').value,
                    rating: selectedRating,
                    age_rating: document.getElementById('age_rating').value,
                    synopsis: document.getElementById('synopsis').value,
                    highlights: document.getElementById('highlights').value,
                    memorable_scenes: document.getElementById('memorable_scenes').value,
                    quotes: document.getElementById('quotes').value,
                    art_style: document.getElementById('art_style').value,
                    color_mood: document.getElementById('color_mood').value,
                    music: document.getElementById('music').value,
                    poster_url: document.getElementById('poster_url').value,
                    trailer_url: document.getElementById('trailer_url').value,
                    review: document.getElementById('review').value,
                    recommend_to: document.getElementById('recommend_to').value,
                    created_at: new Date().toISOString()
                };

                // Upload screenshots if any
                if (screenshotFiles.length > 0) {
                    const screenshotUrls = [];
                    for (const file of screenshotFiles) {
                        const fileName = `${Date.now()}_${file.name}`;
                        const { data, error } = await supabase.storage
                            .from('anime-screenshots')
                            .upload(fileName, file);
                        
                        if (!error) {
                            const { data: publicUrl } = supabase.storage
                                .from('anime-screenshots')
                                .getPublicUrl(fileName);
                            screenshotUrls.push(publicUrl.publicUrl);
                        }
                    }
                    formData.screenshots = screenshotUrls;
                }

                // Insert into database
                const { data, error } = await supabase
                    .from('anime_board')
                    .insert([formData])
                    .select();
                
                if (error) throw error;
                
                showStatus('작품이 성공적으로 등록되었습니다!', 'success');
                resetForm();
                switchTab('list');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('작품 등록에 실패했습니다: ' + error.message, 'error');
            }
        }

        // Load anime list
        async function loadAnimeList() {
            try {
                const { data, error } = await supabase
                    .from('anime_board')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                animeList = data || [];
                renderAnimeList();
                
            } catch (error) {
                console.error('Error loading anime:', error);
                document.getElementById('anime-grid').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-film"></i>
                        <p>작품을 불러올 수 없습니다</p>
                    </div>
                `;
            }
        }

        // Render anime list
        function renderAnimeList() {
            const grid = document.getElementById('anime-grid');
            
            if (animeList.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-film"></i>
                        <h3>아직 등록된 작품이 없습니다</h3>
                        <p>첫 번째 작품을 추가해보세요!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = animeList.map(anime => `
                <div class="anime-card" onclick="showDetail('${anime.id}')">
                    ${anime.poster_url ? 
                        `<img src="${anime.poster_url}" alt="${anime.title}" class="anime-poster">` :
                        `<div class="anime-poster" style="display: flex; align-items: center; justify-content: center; font-size: 3em; color: #333;">
                            <i class="fas fa-film"></i>
                        </div>`
                    }
                    <div class="anime-info">
                        <h3 class="anime-title">${anime.title}</h3>
                        ${anime.subtitle ? `<p class="anime-subtitle">${anime.subtitle}</p>` : ''}
                        <div class="anime-meta">
                            <span>${anime.year}</span>
                            ${anime.episodes ? `<span>${anime.episodes}</span>` : ''}
                            ${anime.rating ? `<span>${'★'.repeat(anime.rating)}${'☆'.repeat(5 - anime.rating)}</span>` : ''}
                        </div>
                        <div class="anime-platform">${anime.platform}</div>
                    </div>
                </div>
            `).join('');
        }

        // Show detail modal
        function showDetail(id) {
            const anime = animeList.find(a => a.id === id);
            if (!anime) return;
            
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="modal-header">
                    ${anime.poster_url ? `<img src="${anime.poster_url}" alt="${anime.title}">` : ''}
                    <div class="modal-header-content">
                        <h1>${anime.title}</h1>
                        ${anime.subtitle ? `<p style="color: #aaa; margin-top: 5px;">${anime.subtitle}</p>` : ''}
                        <div style="margin-top: 15px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <span style="background: ${getPlatformColor(anime.platform)}; color: #fff; padding: 6px 15px; border-radius: 20px;">
                                ${anime.platform}
                            </span>
                            ${anime.year ? `<span>${anime.year}</span>` : ''}
                            ${anime.episodes ? `<span>${anime.episodes}</span>` : ''}
                            ${anime.age_rating ? `<span>${anime.age_rating}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <!-- 평점 및 장르 -->
                    ${anime.rating || anime.genres?.length ? `
                    <div class="detail-section">
                        ${anime.rating ? `
                        <h3>평점</h3>
                        <p style="font-size: 2em; color: #ffd700;">
                            ${'★'.repeat(anime.rating)}${'☆'.repeat(5 - anime.rating)}
                            <span style="font-size: 0.6em; color: #888; margin-left: 10px;">${anime.rating}/5</span>
                        </p>
                        ` : ''}
                        ${anime.genres?.length ? `
                        <div style="margin-top: 20px;">
                            ${anime.genres.map(genre => `
                                <span class="tag" style="margin-right: 8px;">${genre}</span>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- 제작 정보 -->
                    ${anime.director || anime.studio || anime.original || anime.cast_info ? `
                    <div class="detail-section">
                        <h3>제작 정보</h3>
                        <div class="detail-grid">
                            ${anime.director ? `
                            <div class="detail-item">
                                <div class="detail-label">감독</div>
                                <div class="detail-value">${anime.director}</div>
                            </div>
                            ` : ''}
                            ${anime.studio ? `
                            <div class="detail-item">
                                <div class="detail-label">제작사</div>
                                <div class="detail-value">${anime.studio}</div>
                            </div>
                            ` : ''}
                            ${anime.original ? `
                            <div class="detail-item">
                                <div class="detail-label">원작</div>
                                <div class="detail-value">${anime.original}</div>
                            </div>
                            ` : ''}
                            ${anime.cast_info ? `
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label">주요 성우/출연진</div>
                                <div class="detail-value">${anime.cast_info}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 줄거리 -->
                    ${anime.synopsis ? `
                    <div class="detail-section">
                        <h3>줄거리</h3>
                        <p style="line-height: 1.8; color: #ccc;">${anime.synopsis}</p>
                    </div>
                    ` : ''}
                    
                    <!-- 시청 포인트 -->
                    ${anime.highlights ? `
                    <div class="detail-section">
                        <h3>시청 포인트</h3>
                        <p style="line-height: 1.8; color: #ccc;">${anime.highlights}</p>
                    </div>
                    ` : ''}
                    
                    <!-- 인상 깊은 장면 & 명대사 -->
                    ${anime.memorable_scenes || anime.quotes ? `
                    <div class="detail-section">
                        ${anime.memorable_scenes ? `
                        <h3>인상 깊은 장면</h3>
                        <p style="line-height: 1.8; color: #ccc; margin-bottom: 20px;">${anime.memorable_scenes}</p>
                        ` : ''}
                        ${anime.quotes ? `
                        <h3>명대사</h3>
                        <blockquote style="border-left: 3px solid #e50914; padding-left: 20px; margin: 15px 0; font-style: italic; color: #ccc;">
                            ${anime.quotes}
                        </blockquote>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- 비주얼 & 스타일 -->
                    ${anime.art_style || anime.color_mood || anime.music ? `
                    <div class="detail-section">
                        <h3>비주얼 & 스타일</h3>
                        <div class="detail-grid">
                            ${anime.art_style ? `
                            <div class="detail-item">
                                <div class="detail-label">작화 스타일</div>
                                <div class="detail-value">${anime.art_style}</div>
                            </div>
                            ` : ''}
                            ${anime.color_mood ? `
                            <div class="detail-item">
                                <div class="detail-label">색감/분위기</div>
                                <div class="detail-value">${anime.color_mood}</div>
                            </div>
                            ` : ''}
                            ${anime.music ? `
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label">OST/음악</div>
                                <div class="detail-value">${anime.music}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 스크린샷 갤러리 -->
                    ${anime.screenshots?.length ? `
                    <div class="detail-section">
                        <h3>스크린샷</h3>
                        <div class="screenshot-gallery">
                            ${anime.screenshots.map((url, index) => `
                                <div class="screenshot-item" onclick="window.open('${url}', '_blank')">
                                    <img src="${url}" alt="Screenshot ${index + 1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 개인 감상 -->
                    ${anime.review || anime.recommend_to ? `
                    <div class="detail-section">
                        <h3>감상평</h3>
                        ${anime.review ? `
                        <p style="line-height: 1.8; color: #ccc; margin-bottom: 20px;">${anime.review}</p>
                        ` : ''}
                        ${anime.recommend_to ? `
                        <div class="detail-item">
                            <div class="detail-label">추천 대상</div>
                            <div class="detail-value">${anime.recommend_to}</div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- 트레일러 링크 -->
                    ${anime.trailer_url ? `
                    <div class="detail-section">
                        <a href="${anime.trailer_url}" target="_blank" class="btn" style="width: 100%; text-align: center;">
                            <i class="fas fa-play"></i> 트레일러 보기
                        </a>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('detail-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Reset form
        function resetForm() {
            document.getElementById('anime-form').reset();
            selectedRating = 0;
            genreTags = [];
            screenshotFiles = [];
            updateStarRating();
            renderTags('genre-tags');
            document.getElementById('screenshot-preview').innerHTML = '';
        }

        // Load stats
        async function loadStats() {
            const statsContent = document.getElementById('stats-content');
            
            try {
                const { data, error } = await supabase
                    .from('anime_board')
                    .select('*');
                
                if (error) throw error;
                
                // Calculate stats
                const totalAnime = data.length;
                const platformCounts = {};
                const genreCounts = {};
                const yearCounts = {};
                let totalRating = 0;
                let ratedCount = 0;
                
                data.forEach(anime => {
                    // Platform stats
                    platformCounts[anime.platform] = (platformCounts[anime.platform] || 0) + 1;
                    
                    // Genre stats
                    if (anime.genres) {
                        anime.genres.forEach(genre => {
                            genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                        });
                    }
                    
                    // Year stats
                    if (anime.year) {
                        yearCounts[anime.year] = (yearCounts[anime.year] || 0) + 1;
                    }
                    
                    // Rating stats
                    if (anime.rating) {
                        totalRating += anime.rating;
                        ratedCount++;
                    }
                });
                
                const averageRating = ratedCount > 0 ? (totalRating / ratedCount).toFixed(1) : 0;
                
                // Render stats
                statsContent.innerHTML = `
                    <div class="detail-grid" style="margin-top: 30px;">
                        <div class="detail-item">
                            <div class="detail-label">총 작품 수</div>
                            <div class="detail-value" style="font-size: 2em;">${totalAnime}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">평균 평점</div>
                            <div class="detail-value" style="font-size: 2em; color: #ffd700;">
                                ${averageRating} / 5
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">플랫폼별 분포</h3>
                    <div class="detail-grid">
                        ${Object.entries(platformCounts)
                            .sort((a, b) => b[1] - a[1])
                            .map(([platform, count]) => `
                                <div class="detail-item">
                                    <div class="detail-label">${platform}</div>
                                    <div class="detail-value">${count} 작품</div>
                                </div>
                            `).join('')}
                    </div>
                    
                    ${Object.keys(genreCounts).length > 0 ? `
                    <h3 style="margin-top: 30px;">장르별 분포</h3>
                    <div style="margin-top: 15px;">
                        ${Object.entries(genreCounts)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10)
                            .map(([genre, count]) => `
                                <span class="tag" style="margin: 5px;">
                                    ${genre} (${count})
                                </span>
                            `).join('')}
                    </div>
                    ` : ''}
                `;
                
            } catch (error) {
                console.error('Error loading stats:', error);
                statsContent.innerHTML = '<p style="color: #666;">통계를 불러올 수 없습니다</p>';
            }
        }

        // Get platform color
        function getPlatformColor(platform) {
            const colors = {
                '넷플릭스': '#e50914',
                '디즈니+': '#1a5eff',
                '왓챠': '#ff0558',
                '웨이브': '#1f4ef5',
                '티빙': '#ff153c',
                '애플TV+': '#000000',
                '아마존 프라임': '#00a8e1',
                '극장': '#ffd700',
                '기타': '#666666'
            };
            return colors[platform] || '#666666';
        }

        // Show status message
        function showStatus(message, type) {
            const existing = document.querySelector('.status-message');
            if (existing) existing.remove();
            
            const status = document.createElement('div');
            status.className = `status-message status-${type}`;
            status.textContent = message;
            document.body.appendChild(status);
            
            setTimeout(() => {
                status.remove();
            }, 3000);
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Check authentication
        async function checkAuth() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                updateAuthUI();
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        // Update auth UI
        function updateAuthUI() {
            const authText = document.getElementById('auth-text');
            const authBtn = document.getElementById('auth-btn');
            
            if (currentUser) {
                authText.textContent = `로그인됨: ${currentUser.email}`;
                authBtn.textContent = '로그아웃';
            } else {
                authText.textContent = '로그인하지 않음';
                authBtn.textContent = '로그인';
            }
        }

        // Toggle authentication
        async function toggleAuth() {
            if (currentUser) {
                // Logout
                await supabase.auth.signOut();
                currentUser = null;
                updateAuthUI();
                showStatus('로그아웃되었습니다', 'success');
                // Switch to list tab if on add tab
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab && activeTab.textContent.includes('작품 추가')) {
                    switchTab('list');
                }
            } else {
                // Login with Google directly
                loginWithGoogle();
            }
        }

        // Google로 로그인
        async function loginWithGoogle() {
            try {
                showStatus('Google 로그인 중...', 'warning');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href.split('?')[0].split('#')[0],
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        },
                        skipBrowserRedirect: false
                    }
                });
                
                if (error) throw error;
                
                // OAuth는 자동으로 리다이렉트됨
                
            } catch (error) {
                console.error('Google 로그인 오류:', error);
                showStatus('Google 로그인 실패: ' + error.message, 'error');
            }
        }
        
        // Listen for auth changes
        supabase?.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            updateAuthUI();
        });

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>