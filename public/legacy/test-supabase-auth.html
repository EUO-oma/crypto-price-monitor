<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Auth Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { opacity: 0.8; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Supabase Auth í…ŒìŠ¤íŠ¸</h1>
        
        <div id="status" class="status info">ì´ˆê¸°í™” ì¤‘...</div>
        
        <div id="auth-section" style="display: none;">
            <h3>ë¡œê·¸ì¸ ì˜µì…˜</h3>
            <button class="btn-primary" onclick="loginWithGoogle()">Googleë¡œ ë¡œê·¸ì¸</button>
            <button class="btn-secondary" onclick="checkSession()">ì„¸ì…˜ í™•ì¸</button>
            <button class="btn-secondary" onclick="checkLocalStorage()">LocalStorage í™•ì¸</button>
        </div>
        
        <div id="user-section" style="display: none;">
            <h3>ë¡œê·¸ì¸ ì •ë³´</h3>
            <p id="user-info"></p>
            <button class="btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            <button class="btn-success" onclick="testDatabase()">ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div id="debug" class="debug-info"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase = null;
        let currentUser = null;
        
        // ì´ˆê¸°í™”
        async function init() {
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            
            try {
                // Supabase ì„¤ì •
                const SUPABASE_URL = 'https://ddfnxbkiewolgweivomv.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8';
                
                debugEl.textContent = `ë¸Œë¼ìš°ì €: ${navigator.userAgent}\n`;
                debugEl.textContent += `í˜„ì¬ URL: ${window.location.href}\n`;
                debugEl.textContent += `í”„ë¡œí† ì½œ: ${window.location.protocol}\n`;
                
                // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true,
                        storage: window.localStorage,
                        storageKey: 'sb-auth-token'
                    }
                });
                
                // Auth ìƒíƒœ ë³€ê²½ ê°ì§€
                supabase.auth.onAuthStateChange((event, session) => {
                    debugEl.textContent += `\nAuth ì´ë²¤íŠ¸: ${event}\n`;
                    if (session) {
                        debugEl.textContent += `ì‚¬ìš©ì: ${session.user.email}\n`;
                    }
                    updateUI();
                });
                
                // URL í•´ì‹œ í™•ì¸
                if (window.location.hash) {
                    debugEl.textContent += `\nURL í•´ì‹œ ê°ì§€: ${window.location.hash.substring(0, 50)}...\n`;
                }
                
                // ì„¸ì…˜ í™•ì¸
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                if (session) {
                    currentUser = session.user;
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… ë¡œê·¸ì¸ë¨: ' + session.user.email;
                } else {
                    statusEl.className = 'status warning';
                    statusEl.textContent = 'âš ï¸ ë¡œê·¸ì¸ í•„ìš”';
                }
                
                updateUI();
                
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                debugEl.textContent += `\nì˜¤ë¥˜ ìƒì„¸: ${error.stack}\n`;
            }
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const authSection = document.getElementById('auth-section');
            const userSection = document.getElementById('user-section');
            const userInfo = document.getElementById('user-info');
            
            if (currentUser) {
                authSection.style.display = 'none';
                userSection.style.display = 'block';
                userInfo.innerHTML = `
                    <strong>ì´ë©”ì¼:</strong> ${currentUser.email}<br>
                    <strong>ID:</strong> ${currentUser.id}<br>
                    <strong>Provider:</strong> ${currentUser.app_metadata?.provider || 'email'}
                `;
            } else {
                authSection.style.display = 'block';
                userSection.style.display = 'none';
            }
        }
        
        // Google ë¡œê·¸ì¸
        async function loginWithGoogle() {
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            
            try {
                statusEl.className = 'status info';
                statusEl.textContent = 'Google ë¡œê·¸ì¸ ì¤‘...';
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) throw error;
                
                debugEl.textContent += '\nGoogle OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œì‘...\n';
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                currentUser = null;
                location.reload();
            }
        }
        
        // ì„¸ì…˜ í™•ì¸
        async function checkSession() {
            const debugEl = document.getElementById('debug');
            const { data: { session }, error } = await supabase.auth.getSession();
            
            debugEl.textContent = '=== ì„¸ì…˜ ì •ë³´ ===\n';
            if (session) {
                debugEl.textContent += JSON.stringify(session, null, 2);
            } else {
                debugEl.textContent += 'ì„¸ì…˜ ì—†ìŒ\n';
            }
            
            if (error) {
                debugEl.textContent += '\nì˜¤ë¥˜: ' + error.message;
            }
        }
        
        // LocalStorage í™•ì¸
        function checkLocalStorage() {
            const debugEl = document.getElementById('debug');
            debugEl.textContent = '=== LocalStorage ===\n';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('supabase') || key.includes('sb-')) {
                    const value = localStorage.getItem(key);
                    debugEl.textContent += `${key}: ${value.substring(0, 100)}...\n\n`;
                }
            }
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸
        async function testDatabase() {
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            
            try {
                debugEl.textContent = '=== ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ===\n';
                
                const { data, error } = await supabase
                    .from('links')
                    .select('*')
                    .limit(5);
                
                if (error) throw error;
                
                debugEl.textContent += `ì„±ê³µ! ${data.length}ê°œ í•­ëª© ë°œê²¬\n`;
                debugEl.textContent += JSON.stringify(data, null, 2);
                
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ';
                
            } catch (error) {
                console.error('DB ì˜¤ë¥˜:', error);
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ DB ì˜¤ë¥˜: ' + error.message;
                debugEl.textContent += '\nì˜¤ë¥˜: ' + JSON.stringify(error, null, 2);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>