<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ì—°ê²° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #0f0;
            background: #001100;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        .error {
            color: #f00;
        }
        .success {
            color: #0f0;
        }
        .warning {
            color: #ff0;
        }
        pre {
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h2>1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸</h2>
        <div id="env-check">í™•ì¸ ì¤‘...</div>
    </div>
    
    <div class="test-section">
        <h2>2. Supabase ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Links í…Œì´ë¸” ì½ê¸° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testReadLinks()">ì½ê¸° í…ŒìŠ¤íŠ¸</button>
        <div id="read-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. ì§ì ‘ SQL ì‹¤í–‰ (RLS ì •ì±… ìˆ˜ì •)</h2>
        <button onclick="showRLSFix()">RLS ìˆ˜ì • SQL ë³´ê¸°</button>
        <div id="rls-sql" style="display:none;">
            <p class="warning">ì•„ë˜ SQLì„ Supabase SQL Editorì— ë³µì‚¬í•˜ì„¸ìš”:</p>
            <pre>
-- ê¸°ì¡´ ì •ì±… ì‚­ì œ
DROP POLICY IF EXISTS "Enable read access for all users" ON links;
DROP POLICY IF EXISTS "Enable insert for authenticated users only" ON links;
DROP POLICY IF EXISTS "Enable update for authenticated users only" ON links;
DROP POLICY IF EXISTS "Enable delete for authenticated users only" ON links;

-- ìƒˆ ì •ì±… ìƒì„±
CREATE POLICY "Enable read access for all users" ON links
    FOR SELECT USING (true);

CREATE POLICY "Enable insert for authenticated users" ON links
    FOR INSERT TO authenticated WITH CHECK (true);

CREATE POLICY "Enable update for authenticated users" ON links
    FOR UPDATE TO authenticated USING (true);

CREATE POLICY "Enable delete for authenticated users" ON links
    FOR DELETE TO authenticated USING (true);

-- í™•ì¸
SELECT * FROM links;
            </pre>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5. ë°ì´í„° ì‚½ì… í…ŒìŠ¤íŠ¸ (ìƒ˜í”Œ ë°ì´í„°)</h2>
        <button onclick="insertSampleData()">ìƒ˜í”Œ ë°ì´í„° ì‚½ì…</button>
        <div id="insert-result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-env.js"></script>
    <script src="config-loader.js"></script>
    <script>
        // í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        document.addEventListener('DOMContentLoaded', () => {
            const envDiv = document.getElementById('env-check');
            let html = '';
            
            if (typeof SUPABASE_URL !== 'undefined') {
                html += `<p class="success">âœ“ SUPABASE_URL: ${SUPABASE_URL}</p>`;
            } else {
                html += `<p class="error">âœ— SUPABASE_URLì´ ì •ì˜ë˜ì§€ ì•ŠìŒ</p>`;
            }
            
            if (typeof SUPABASE_ANON_KEY !== 'undefined') {
                html += `<p class="success">âœ“ SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY.substring(0, 20)}...</p>`;
            } else {
                html += `<p class="error">âœ— SUPABASE_ANON_KEYê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ</p>`;
            }
            
            if (typeof supabase !== 'undefined') {
                html += `<p class="success">âœ“ Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”ë¨</p>`;
            } else {
                html += `<p class="error">âœ— Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨</p>`;
            }
            
            envDiv.innerHTML = html;
        });
        
        // ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<p>í…ŒìŠ¤íŠ¸ ì¤‘...</p>';
            
            try {
                // ê°„ë‹¨í•œ ì¿¼ë¦¬ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
                const { data, error } = await window.supabaseClient.from('links')
                    .select('count');
                
                if (error) {
                    resultDiv.innerHTML = `<p class="error">âŒ ì—°ê²° ì‹¤íŒ¨</p>
                        <p class="error">ì—ëŸ¬: ${error.message}</p>
                        <p class="error">ì½”ë“œ: ${error.code}</p>
                        <p class="error">ìƒì„¸: ${JSON.stringify(error, null, 2)}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="success">âœ… ì—°ê²° ì„±ê³µ!</p>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<p class="error">âŒ ì˜ˆì™¸ ë°œìƒ: ${err.message}</p>`;
            }
        }
        
        // ì½ê¸° í…ŒìŠ¤íŠ¸
        async function testReadLinks() {
            const resultDiv = document.getElementById('read-result');
            resultDiv.innerHTML = '<p>ì½ê¸° ì‹œë„ ì¤‘...</p>';
            
            try {
                const { data: links, error } = await window.supabaseClient.from('links')
                    .select('*')
                    .order('position', { ascending: true });
                
                if (error) {
                    resultDiv.innerHTML = `<p class="error">âŒ ì½ê¸° ì‹¤íŒ¨</p>
                        <p class="error">ì—ëŸ¬: ${error.message}</p>
                        <p class="error">ì½”ë“œ: ${error.code}</p>`;
                    
                    if (error.code === 'PGRST301') {
                        resultDiv.innerHTML += `<p class="warning">âš ï¸ RLS ì •ì±… ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.</p>
                            <p class="warning">ìœ„ì˜ "RLS ìˆ˜ì • SQL ë³´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>`;
                    }
                } else {
                    resultDiv.innerHTML = `<p class="success">âœ… ì½ê¸° ì„±ê³µ!</p>
                        <p class="success">ì´ ${links ? links.length : 0}ê°œì˜ ë§í¬ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>`;
                    
                    if (links && links.length > 0) {
                        resultDiv.innerHTML += '<p>ë°ì´í„°:</p><pre>' + JSON.stringify(links, null, 2) + '</pre>';
                    }
                }
            } catch (err) {
                resultDiv.innerHTML = `<p class="error">âŒ ì˜ˆì™¸ ë°œìƒ: ${err.message}</p>`;
            }
        }
        
        // RLS SQL ë³´ê¸°
        function showRLSFix() {
            const sqlDiv = document.getElementById('rls-sql');
            sqlDiv.style.display = sqlDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        // ìƒ˜í”Œ ë°ì´í„° ì‚½ì…
        async function insertSampleData() {
            const resultDiv = document.getElementById('insert-result');
            resultDiv.innerHTML = '<p>ì‚½ì… ì‹œë„ ì¤‘...</p>';
            
            const sampleData = [
                { name: 'ì‚¬ë˜', url: 'https://www.youtube.com/@live-streamersatto/live', category: 'youtube', position: 1 },
                { name: 'ì§­êµ¬', url: 'https://www.youtube.com/@zzap9/live', category: 'youtube', position: 2 },
                { name: 'CoinSect.io', url: 'https://coinsect.io', category: 'favorite', position: 1 },
                { name: 'ChatGPT', url: 'https://chat.openai.com', category: 'gpt', position: 1 }
            ];
            
            try {
                const { data, error } = await window.supabaseClient.from('links')
                    .insert(sampleData)
                    .select();
                
                if (error) {
                    if (error.code === '42501') {
                        resultDiv.innerHTML = `<p class="warning">âš ï¸ ê¶Œí•œ ì—†ìŒ - ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
                            <p>ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ í›„ ì¶”ê°€í•˜ì„¸ìš”.</p>`;
                    } else {
                        resultDiv.innerHTML = `<p class="error">âŒ ì‚½ì… ì‹¤íŒ¨: ${error.message}</p>`;
                    }
                } else {
                    resultDiv.innerHTML = `<p class="success">âœ… ìƒ˜í”Œ ë°ì´í„° ì‚½ì… ì„±ê³µ!</p>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<p class="error">âŒ ì˜ˆì™¸ ë°œìƒ: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>