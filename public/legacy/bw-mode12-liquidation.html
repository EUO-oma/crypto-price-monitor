<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BW - Liquidation Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'SF Mono', monospace;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.3;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .leverage-btn {
            background: #111;
            border: 1px solid #222;
            color: #666;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 14px;
        }
        
        .leverage-btn.active {
            border-color: #fff;
            color: #fff;
            background: #222;
        }
        
        .leverage-btn:hover {
            border-color: #444;
            color: #aaa;
        }
        
        .position-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .position-btn {
            background: #111;
            border: 1px solid #222;
            color: #666;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .position-btn.active.long {
            border-color: #0f0;
            color: #0f0;
        }
        
        .position-btn.active.short {
            border-color: #f00;
            color: #f00;
        }
        
        .crypto-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .crypto-item {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
        }
        
        .crypto-item.safe {
            border-color: #0a4f0a;
        }
        
        .crypto-item.warning {
            border-color: #4f4f0a;
        }
        
        .crypto-item.danger {
            border-color: #4f0a0a;
            animation: dangerPulse 2s infinite;
        }
        
        @keyframes dangerPulse {
            0%, 100% { border-color: #4f0a0a; }
            50% { border-color: #8f0a0a; }
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1);
            }
        }
        
        .symbol {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 5px;
        }
        
        .price {
            font-size: 24px;
            font-weight: 300;
        }
        
        .change {
            font-size: 14px;
            opacity: 0.7;
        }
        
        .change.positive { color: #0f0; }
        .change.negative { color: #f00; }
        
        .liquidation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #222;
        }
        
        .liquidation-price {
            font-size: 16px;
            color: #f00;
        }
        
        .distance {
            font-size: 14px;
            color: #666;
        }
        
        .distance-detail {
            font-size: 18px;
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .vwap-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            background: #111;
            padding: 15px;
            border-radius: 8px;
        }
        
        .vwap-header {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .vwap-price {
            font-size: 16px;
            color: #ffa500;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .vwap-liquidations {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .vwap-liq-item {
            background: #1a1a1a;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        
        .vwap-liq-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .vwap-liq-value {
            font-size: 14px;
            font-weight: bold;
        }
        
        .vwap-liq-value.long {
            color: #00ff00;
        }
        
        .vwap-liq-value.short {
            color: #ff0000;
        }
        
        .distance-bar {
            width: 100%;
            height: 4px;
            background: #111;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .distance-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #0f0;
            transition: all 0.5s ease;
        }
        
        .distance-fill.warning {
            background: #ff0;
        }
        
        .distance-fill.danger {
            background: #f00;
        }
        
        .loading {
            text-align: center;
            margin-top: 50px;
            color: #666;
        }
        
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .back-link:hover {
            color: #fff;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .crypto-item {
                padding: 15px;
            }
            
            .price {
                font-size: 20px;
            }
            
            .distance-detail {
                font-size: 16px;
            }
            
            .controls {
                gap: 5px;
            }
            
            .leverage-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <a href="bw-mode.html" class="back-link">← back</a>
    
    <div class="header">liquidation monitor</div>
    
    <div class="position-toggle">
        <button class="position-btn long active" onclick="setPosition('long')">LONG</button>
        <button class="position-btn short" onclick="setPosition('short')">SHORT</button>
    </div>
    
    <div class="controls">
        <button class="leverage-btn" onclick="setLeverage(1)">1x</button>
        <button class="leverage-btn" onclick="setLeverage(3)">3x</button>
        <button class="leverage-btn" onclick="setLeverage(5)">5x</button>
        <button class="leverage-btn active" onclick="setLeverage(10)">10x</button>
        <button class="leverage-btn" onclick="setLeverage(20)">20x</button>
        <button class="leverage-btn" onclick="setLeverage(50)">50x</button>
        <button class="leverage-btn" onclick="setLeverage(100)">100x</button>
    </div>
    
    <div class="crypto-container" id="crypto-container">
        <div class="loading">Loading...</div>
    </div>

    <script>
        let currentLeverage = 10;
        let currentPosition = 'long';
        let prices = {};
        let vwapData = {};
        let ws = null;
        
        const maintenanceMargin = 0.004; // 0.4% for Binance
        
        const symbols = [
            'BTCUSDT',
            'ETHUSDT',
            'SOLUSDT',
            'XRPUSDT',
            'AVAXUSDT'
        ];
        
        function setLeverage(leverage) {
            currentLeverage = leverage;
            document.querySelectorAll('.leverage-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateAllLiquidations();
        }
        
        function setPosition(position) {
            currentPosition = position;
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.position-btn.${position}`).classList.add('active');
            updateAllLiquidations();
        }
        
        function calculateLiquidationPrice(entryPrice, leverage, position) {
            if (position === 'long') {
                return entryPrice * (1 - 1/leverage + maintenanceMargin);
            } else {
                return entryPrice * (1 + 1/leverage - maintenanceMargin);
            }
        }
        
        function calculateDistance(currentPrice, liquidationPrice, position) {
            if (position === 'long') {
                return ((currentPrice - liquidationPrice) / currentPrice) * 100;
            } else {
                return ((liquidationPrice - currentPrice) / currentPrice) * 100;
            }
        }
        
        async function fetchVWAP(symbol) {
            try {
                // Fetch 24h klines for VWAP calculation
                const response = await fetch(
                    `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=24`
                );
                const klines = await response.json();
                
                let totalVolume = 0;
                let volumeWeightedPrice = 0;
                
                klines.forEach(k => {
                    const avgPrice = (parseFloat(k[2]) + parseFloat(k[3]) + parseFloat(k[4])) / 3; // (high + low + close) / 3
                    const volume = parseFloat(k[5]);
                    volumeWeightedPrice += avgPrice * volume;
                    totalVolume += volume;
                });
                
                const vwap = volumeWeightedPrice / totalVolume;
                vwapData[symbol] = vwap;
                
                // Update display if item exists
                updateVWAPDisplay(symbol);
                
            } catch (error) {
                console.error('Error fetching VWAP for', symbol, error);
            }
        }
        
        function updateVWAPDisplay(symbol) {
            const item = document.getElementById(symbol);
            if (!item || !vwapData[symbol]) return;
            
            let vwapSection = item.querySelector('.vwap-section');
            if (!vwapSection) {
                // Create VWAP section if it doesn't exist
                vwapSection = document.createElement('div');
                vwapSection.className = 'vwap-section';
                item.appendChild(vwapSection);
            }
            
            const vwap = vwapData[symbol];
            const liq25Long = calculateLiquidationPrice(vwap, 25, 'long');
            const liq25Short = calculateLiquidationPrice(vwap, 25, 'short');
            const liq50Long = calculateLiquidationPrice(vwap, 50, 'long');
            const liq50Short = calculateLiquidationPrice(vwap, 50, 'short');
            
            vwapSection.innerHTML = `
                <div class="vwap-header">VWAP 기준 청산가</div>
                <div class="vwap-price">VWAP: $${vwap.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
                })}</div>
                <div class="vwap-liquidations">
                    <div class="vwap-liq-item">
                        <div class="vwap-liq-label">25x Long Liq</div>
                        <div class="vwap-liq-value long">$${liq25Long.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
                        })}</div>
                    </div>
                    <div class="vwap-liq-item">
                        <div class="vwap-liq-label">25x Short Liq</div>
                        <div class="vwap-liq-value short">$${liq25Short.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
                        })}</div>
                    </div>
                    <div class="vwap-liq-item">
                        <div class="vwap-liq-label">50x Long Liq</div>
                        <div class="vwap-liq-value long">$${liq50Long.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
                        })}</div>
                    </div>
                    <div class="vwap-liq-item">
                        <div class="vwap-liq-label">50x Short Liq</div>
                        <div class="vwap-liq-value short">$${liq50Short.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
                        })}</div>
                    </div>
                </div>
            `;
        }
        
        function updateCryptoItem(symbol, price, change24h) {
            let item = document.getElementById(symbol);
            if (!item) {
                createCryptoItem(symbol);
                item = document.getElementById(symbol);
            }
            
            const liquidationPrice = calculateLiquidationPrice(price, currentLeverage, currentPosition);
            const distance = calculateDistance(price, liquidationPrice, currentPosition);
            
            // Update price
            item.querySelector('.price').textContent = price.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
            });
            
            // Update change
            const changeEl = item.querySelector('.change');
            changeEl.textContent = (change24h >= 0 ? '+' : '') + change24h.toFixed(2) + '%';
            changeEl.className = 'change ' + (change24h >= 0 ? 'positive' : 'negative');
            
            // Update liquidation price
            item.querySelector('.liquidation-price').textContent = 
                'Liq: $' + liquidationPrice.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
                });
            
            // Update distance with more detail
            const distanceDetail = item.querySelector('.distance-detail');
            const distanceEl = item.querySelector('.distance');
            
            // Show distance with 0.1% precision
            distanceDetail.textContent = distance.toFixed(1) + '%';
            
            // Calculate price difference to liquidation
            const priceDiff = Math.abs(price - liquidationPrice);
            const priceDiffText = priceDiff.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: symbol === 'XRPUSDT' ? 4 : 2
            });
            
            distanceEl.textContent = `$${priceDiffText} to liq`;
            
            // Update distance bar
            const fillEl = item.querySelector('.distance-fill');
            const fillPercentage = Math.max(0, Math.min(100, 100 - distance));
            fillEl.style.width = fillPercentage + '%';
            
            // Update danger status with more granular levels
            item.classList.remove('safe', 'warning', 'danger');
            fillEl.classList.remove('warning', 'danger');
            distanceDetail.classList.remove('warning', 'danger');
            
            if (distance < 1) {
                // Critical - less than 1%
                item.classList.add('danger');
                fillEl.classList.add('danger');
                distanceDetail.style.color = '#ff0000';
                distanceDetail.style.animation = 'pulse 0.5s infinite';
            } else if (distance < 2) {
                // Extreme danger - 1-2%
                item.classList.add('danger');
                fillEl.classList.add('danger');
                distanceDetail.style.color = '#ff3333';
                distanceDetail.style.animation = 'pulse 1s infinite';
            } else if (distance < 5) {
                // Danger - 2-5%
                item.classList.add('danger');
                fillEl.classList.add('danger');
                distanceDetail.style.color = '#ff6666';
                distanceDetail.style.animation = 'none';
            } else if (distance < 10) {
                // Warning - 5-10%
                item.classList.add('warning');
                fillEl.classList.add('warning');
                distanceDetail.style.color = '#ffff00';
                distanceDetail.style.animation = 'none';
            } else if (distance < 20) {
                // Caution - 10-20%
                item.classList.add('safe');
                distanceDetail.style.color = '#90EE90';
                distanceDetail.style.animation = 'none';
            } else {
                // Safe - over 20%
                item.classList.add('safe');
                distanceDetail.style.color = '#00ff00';
                distanceDetail.style.animation = 'none';
            }
        }
        
        function createCryptoItem(symbol) {
            const container = document.getElementById('crypto-container');
            
            // Clear loading message if it exists
            const loading = container.querySelector('.loading');
            if (loading) loading.remove();
            
            const item = document.createElement('div');
            item.className = 'crypto-item';
            item.id = symbol;
            
            item.innerHTML = `
                <div class="symbol">${symbol.replace('USDT', '')}</div>
                <div class="price-row">
                    <div class="price">-</div>
                    <div class="change">-</div>
                </div>
                <div class="liquidation-row">
                    <div class="liquidation-price">Liq: -</div>
                    <div style="text-align: right;">
                        <div class="distance-detail">-</div>
                        <div class="distance">- to liquidation</div>
                    </div>
                </div>
                <div class="distance-bar">
                    <div class="distance-fill"></div>
                </div>
            `;
            
            container.appendChild(item);
        }
        
        function updateAllLiquidations() {
            for (const [symbol, data] of Object.entries(prices)) {
                updateCryptoItem(symbol, data.price, data.change24h);
            }
        }
        
        function connectWebSocket() {
            if (ws) ws.close();
            
            const streams = symbols.map(s => s.toLowerCase() + '@ticker').join('/');
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${streams}`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const symbol = data.s;
                const price = parseFloat(data.c);
                const change24h = parseFloat(data.P);
                
                prices[symbol] = { price, change24h };
                updateCryptoItem(symbol, price, change24h);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // Initialize
        connectWebSocket();
        
        // Fetch VWAP for all symbols
        symbols.forEach(symbol => fetchVWAP(symbol));
        
        // Refresh VWAP every 5 minutes
        setInterval(() => {
            symbols.forEach(symbol => fetchVWAP(symbol));
        }, 5 * 60 * 1000);
    </script>
</body>
</html>