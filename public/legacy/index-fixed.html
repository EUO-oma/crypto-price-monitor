<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>CRYPTO Ã— LIVE ğŸ’¹ - Fixed Version</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #0a0a0a;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            max-width: 900px;
            width: 100%;
            border: 1px solid #1a1a1a;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5em;
        }

        .status {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #666;
            font-size: 0.9em;
        }

        .exchange-section {
            margin-bottom: 40px;
        }

        h2 {
            color: #aaa;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .price-card {
            background: #1a1a1a;
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid #333;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }

        .price-card:hover {
            transform: translateY(-5px);
            border-color: #555;
        }

        .symbol {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .price {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .change {
            font-size: 1.1em;
        }

        .change.positive { color: #4caf50; }
        .change.negative { color: #f44336; }

        .timestamp {
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* ë§í¬ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .links-section {
            margin-bottom: 30px;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
        }

        .links-section h3 {
            color: #4facfe;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .link-card {
            display: block;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            text-decoration: none;
            color: #fff;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .link-card:hover {
            background: #3a3a3a;
            transform: translateY(-2px);
            border-color: #666;
        }

        /* ì´ˆê¸°í™” ìƒíƒœ í‘œì‹œ */
        .init-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #333;
            font-size: 0.9em;
        }

        .init-status.loading { border-color: #ff6f00; color: #ff6f00; }
        .init-status.ready { border-color: #4caf50; color: #4caf50; }
        .init-status.error { border-color: #f44336; color: #f44336; }

        /* ì±„íŒ… ë²„íŠ¼ */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4facfe;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-button:hover {
            background: #00e5ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .chat-button:active {
            transform: translateY(0);
        }

        .chat-button .badge {
            background: #ff4444;
            color: white;
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }

        .chat-button .badge.show {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="init-status loading" id="init-status">ì´ˆê¸°í™” ì¤‘...</div>
    
    <!-- ì±„íŒ… ë²„íŠ¼ -->
    <button class="chat-button" id="chat-button" onclick="openChat()">
        ğŸ’¬ ì±„íŒ…
        <span class="badge" id="chat-badge">New</span>
    </button>
    
    <div class="container">
        <h1>CRYPTO Ã— LIVE ğŸ’¹</h1>
        
        <!-- ì•”í˜¸í™”í ê°€ê²© ì„¹ì…˜ -->
        <div class="exchange-section">
            <h2>ğŸ“Š ì‹¤ì‹œê°„ ì•”í˜¸í™”í ê°€ê²©</h2>
            <div class="price-grid" id="crypto-prices">
                <!-- ê°€ê²© ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>

        <!-- ë§í¬ ì„¹ì…˜ë“¤ -->
        <div class="exchange-section">
            <h2>ğŸ”— Quick Links</h2>
            
            <div class="links-section">
                <h3>ğŸ¤– GPT Tools</h3>
                <div class="links-grid" id="gpt-links">
                    <div class="link-card">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <div class="links-section">
                <h3>ğŸ“º YouTube Channels</h3>
                <div class="links-grid" id="youtube-links">
                    <div class="link-card">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <div class="links-section">
                <h3>â­ Favorite Sites</h3>
                <div class="links-grid" id="favorite-links">
                    <div class="link-card">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <div class="status">
            <p id="ws-status">WebSocket ìƒíƒœ: ì—°ê²° ëŒ€ê¸°ì¤‘...</p>
            <p id="supabase-status">Supabase ìƒíƒœ: ì´ˆê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <!-- Configuration Scripts -->
    <script src="config-loader.js"></script>
    <script src="auth-helper.js"></script>
    
    <!-- Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ========== Configuration Loading ==========
        async function waitForConfig() {
            return new Promise((resolve) => {
                if (window.APP_CONFIG?.SUPABASE?.URL) {
                    resolve();
                } else {
                    window.addEventListener('configLoaded', resolve, { once: true });
                    setTimeout(resolve, 3000); // Fallback
                }
            });
        }
        
        // ========== ì „ì—­ ì„¤ì • ==========
        let CONFIG = {
            supabase: {
                url: '',
                key: ''
            },
            coins: ['BTC', 'ETH', 'SOL', 'XRP', 'AVAX']
        };
        
        // Initialize config from environment
        async function initializeConfig() {
            await waitForConfig();
            
            CONFIG.supabase.url = window.APP_CONFIG?.SUPABASE?.URL || 'https://ddfnxbkiewolgweivomv.supabase.co';
            CONFIG.supabase.key = window.APP_CONFIG?.SUPABASE?.ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8';
            
            if (!CONFIG.supabase.url || !CONFIG.supabase.key) {
                AppState.updateInitStatus('error', 'Configuration Error');
                throw new Error('Supabase configuration not found');
            }
        }

        // ========== ì•± ìƒíƒœ ê´€ë¦¬ ==========
        const AppState = {
            supabase: null,
            webSockets: {},
            prices: {},
            initialized: false,
            
            // ì´ˆê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            updateInitStatus(status, message) {
                const el = document.getElementById('init-status');
                el.className = `init-status ${status}`;
                el.textContent = message;
                
                if (status === 'ready') {
                    setTimeout(() => el.style.display = 'none', 3000);
                }
            }
        };

        // ========== Supabase ì´ˆê¸°í™” (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤) ==========
        async function initializeSupabase() {
            console.log('ğŸ”„ Supabase ì´ˆê¸°í™” ì‹œì‘...');
            
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸°
            let attempts = 0;
            while (!window.supabase && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            
            if (!window.supabase) {
                throw new Error('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ë‹¨ì¼ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            AppState.supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);
            
            // ì „ì—­ ì°¸ì¡° ì„¤ì • (í˜¸í™˜ì„±)
            window.supabaseClient = AppState.supabase;
            
            console.log('âœ… Supabase ì´ˆê¸°í™” ì™„ë£Œ');
            document.getElementById('supabase-status').textContent = 'Supabase ìƒíƒœ: âœ… ì—°ê²°ë¨';
            
            return true;
        }

        // ========== ê°€ê²© ì¹´ë“œ ìƒì„± ==========
        function createPriceCards() {
            const container = document.getElementById('crypto-prices');
            
            CONFIG.coins.forEach(coin => {
                const card = document.createElement('div');
                card.className = 'price-card';
                card.id = `price-${coin.toLowerCase()}`;
                card.innerHTML = `
                    <div class="symbol">${coin}/USDT</div>
                    <div class="price" id="${coin.toLowerCase()}-price">-</div>
                    <div class="change" id="${coin.toLowerCase()}-change">-</div>
                    <div class="timestamp" id="${coin.toLowerCase()}-time">-</div>
                `;
                container.appendChild(card);
            });
        }

        // ========== WebSocket ì—°ê²° ==========
        function connectWebSocket(coin) {
            const ws = new WebSocket(`wss://fstream.binance.com/ws/${coin.toLowerCase()}usdt@ticker`);
            
            ws.onopen = () => {
                console.log(`âœ… ${coin} WebSocket ì—°ê²°ë¨`);
                updateWebSocketStatus();
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updatePrice(coin, data);
            };
            
            ws.onerror = (error) => {
                console.error(`âŒ ${coin} WebSocket ì—ëŸ¬:`, error);
            };
            
            ws.onclose = () => {
                console.log(`ğŸ”„ ${coin} WebSocket ì¬ì—°ê²° ì‹œë„...`);
                setTimeout(() => connectWebSocket(coin), 5000);
            };
            
            AppState.webSockets[coin] = ws;
        }

        // ========== ê°€ê²© ì—…ë°ì´íŠ¸ ==========
        function updatePrice(coin, data) {
            const price = parseFloat(data.c);
            const change = parseFloat(data.P);
            
            AppState.prices[coin] = price;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById(`${coin.toLowerCase()}-price`).textContent = `$${price.toFixed(2)}`;
            
            const changeEl = document.getElementById(`${coin.toLowerCase()}-change`);
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeEl.className = `change ${change >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById(`${coin.toLowerCase()}-time`).textContent = 
                new Date().toLocaleTimeString('ko-KR');
        }

        // ========== WebSocket ìƒíƒœ ì—…ë°ì´íŠ¸ ==========
        function updateWebSocketStatus() {
            const connected = Object.values(AppState.webSockets).filter(ws => 
                ws && ws.readyState === WebSocket.OPEN
            ).length;
            
            document.getElementById('ws-status').textContent = 
                `WebSocket ìƒíƒœ: ${connected}/${CONFIG.coins.length} ì—°ê²°ë¨`;
        }

        // ========== ë§í¬ ë¡œë“œ (ë‹¨ìˆœí™”) ==========
        async function loadLinks() {
            if (!AppState.supabase) {
                console.error('âŒ Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }
            
            try {
                const { data: links, error } = await AppState.supabase
                    .from('links')
                    .select('*')
                    .order('position');
                
                if (error) throw error;
                
                // ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜
                const categories = {
                    gpt: links.filter(l => l.category === 'gpt'),
                    youtube: links.filter(l => l.category === 'youtube'),
                    favorite: links.filter(l => l.category === 'favorite')
                };
                
                // ë Œë”ë§
                Object.entries(categories).forEach(([category, items]) => {
                    const container = document.getElementById(`${category}-links`);
                    if (container && items.length > 0) {
                        container.innerHTML = items.map(link => 
                            `<a href="${link.url}" target="_blank" class="link-card">${link.name}</a>`
                        ).join('');
                    }
                });
                
                console.log(`âœ… ${links.length}ê°œ ë§í¬ ë¡œë“œ ì™„ë£Œ`);
                
            } catch (error) {
                console.error('âŒ ë§í¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ========== ë©”ì¸ ì´ˆê¸°í™” í•¨ìˆ˜ ==========
        async function initialize() {
            try {
                AppState.updateInitStatus('loading', 'ì´ˆê¸°í™” ì¤‘...');
                
                // 1. Config ì´ˆê¸°í™”
                await initializeConfig();
                
                // 2. UI ì¤€ë¹„
                createPriceCards();
                
                // 3. Supabase ì´ˆê¸°í™”
                await initializeSupabase();
                
                // 3. WebSocket ì—°ê²°
                CONFIG.coins.forEach(coin => connectWebSocket(coin));
                
                // 4. ë§í¬ ë¡œë“œ
                await loadLinks();
                
                // 5. ì™„ë£Œ
                AppState.initialized = true;
                AppState.updateInitStatus('ready', 'âœ… ì¤€ë¹„ ì™„ë£Œ');
                
                console.log('ğŸ‰ ì•± ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                AppState.updateInitStatus('error', 'ì´ˆê¸°í™” ì‹¤íŒ¨');
            }
        }

        // ========== ì±„íŒ… ì°½ ì—´ê¸° ==========
        function openChat() {
            // íŒì—… ì°½ ì„¤ì •
            const width = 400;
            const height = 600;
            const left = window.screen.width - width - 50;
            const top = 100;
            
            const features = `
                width=${width},
                height=${height},
                left=${left},
                top=${top},
                toolbar=no,
                menubar=no,
                scrollbars=no,
                resizable=yes,
                status=no
            `.replace(/\s+/g, '');
            
            // íŒì—… ì—´ê¸°
            const chatWindow = window.open('chat-popup.html', 'ChatWindow', features);
            
            // í¬ì»¤ìŠ¤ ì£¼ê¸°
            if (chatWindow) {
                chatWindow.focus();
                // ë°°ì§€ ìˆ¨ê¸°ê¸°
                document.getElementById('chat-badge').classList.remove('show');
            }
        }
        
        // ========== ì±„íŒ… ì—…ë°ì´íŠ¸ í™•ì¸ (ì˜µì…˜) ==========
        async function checkChatUpdates() {
            if (!AppState.supabase || !AppState.initialized) return;
            
            try {
                // ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (localStorage)
                const lastCheck = localStorage.getItem('lastChatCheck') || new Date(0).toISOString();
                
                const { data, error } = await AppState.supabase
                    .from('messages')
                    .select('created_at')
                    .gt('created_at', lastCheck)
                    .limit(1);
                
                if (!error && data && data.length > 0) {
                    // ìƒˆ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ë°°ì§€ í‘œì‹œ
                    document.getElementById('chat-badge').classList.add('show');
                }
                
            } catch (error) {
                console.error('ì±„íŒ… ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        // ========== ì•± ì‹œì‘ ==========
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ ì•± ì‹œì‘...');
            initialize();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì±„íŒ… ì—…ë°ì´íŠ¸ í™•ì¸ (30ì´ˆë§ˆë‹¤)
            setInterval(checkChatUpdates, 30000);
        });
        
        // ========== ì •ë¦¬ ì‘ì—… ==========
        window.addEventListener('beforeunload', () => {
            // WebSocket ì—°ê²° ì¢…ë£Œ
            Object.values(AppState.webSockets).forEach(ws => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
            });
            
            // ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°„ ì €ì¥
            localStorage.setItem('lastChatCheck', new Date().toISOString());
        });
    </script>
</body>
</html>