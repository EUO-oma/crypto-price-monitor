<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ì¸ì¦ ë””ë²„ê·¸</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #0f0;
        }
        button {
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0f0;
            color: #000;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ê´€ë¦¬ì ì¸ì¦ ë””ë²„ê·¸ ë„êµ¬</h1>
    
    <div class="section">
        <h2>1. ì„¤ì • íŒŒì¼ ì²´í¬</h2>
        <button onclick="checkConfig()">ì„¤ì • í™•ì¸</button>
        <pre id="config-result"></pre>
    </div>

    <div class="section">
        <h2>2. í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ</h2>
        <button onclick="checkSession()">ì„¸ì…˜ í™•ì¸</button>
        <pre id="session-result"></pre>
    </div>

    <div class="section">
        <h2>3. ê´€ë¦¬ì ê¶Œí•œ ì²´í¬</h2>
        <button onclick="checkAdmin()">ê¶Œí•œ í™•ì¸</button>
        <pre id="admin-result"></pre>
    </div>

    <div class="section">
        <h2>4. ë¹ ë¥¸ ìˆ˜ì •</h2>
        <button onclick="forceLogin()">ê°•ì œ ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸)</button>
        <button onclick="clearAll()">ëª¨ë“  ìºì‹œ ì‚­ì œ</button>
        <button onclick="window.location.href='admin-links.html'">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-env.js"></script>
    <script src="config-loader.js"></script>
    <script src="auth-helper.js"></script>

    <script>
        function checkConfig() {
            const result = document.getElementById('config-result');
            const checks = [];
            
            // ENV_CONFIG í™•ì¸
            checks.push('ğŸ” ENV_CONFIG í™•ì¸:');
            if (window.ENV_CONFIG) {
                checks.push('âœ… ENV_CONFIG ë¡œë“œë¨');
                checks.push(`- ALLOWED_EMAILS: ${JSON.stringify(window.ENV_CONFIG.ADMIN?.ALLOWED_EMAILS || [])}`);
            } else {
                checks.push('âŒ ENV_CONFIG ì—†ìŒ');
            }
            
            // APP_CONFIG í™•ì¸
            checks.push('\nğŸ” APP_CONFIG í™•ì¸:');
            if (window.APP_CONFIG) {
                checks.push('âœ… APP_CONFIG ë¡œë“œë¨');
                checks.push(`- ALLOWED_EMAILS: ${JSON.stringify(window.APP_CONFIG.ADMIN?.ALLOWED_EMAILS || [])}`);
                checks.push(`- Supabase URL: ${window.APP_CONFIG.SUPABASE?.URL ? 'ì„¤ì •ë¨' : 'ì—†ìŒ'}`);
            } else {
                checks.push('âŒ APP_CONFIG ì—†ìŒ');
            }
            
            // getConfig í•¨ìˆ˜ í™•ì¸
            checks.push('\nğŸ” getConfig í•¨ìˆ˜ í™•ì¸:');
            if (window.getConfig) {
                checks.push('âœ… getConfig ì‚¬ìš© ê°€ëŠ¥');
                const emails = window.getConfig('ADMIN.ALLOWED_EMAILS');
                checks.push(`- í—ˆìš©ëœ ì´ë©”ì¼: ${JSON.stringify(emails || [])}`);
            } else {
                checks.push('âŒ getConfig ì—†ìŒ');
            }
            
            result.textContent = checks.join('\n');
        }

        async function checkSession() {
            const result = document.getElementById('session-result');
            try {
                const supabase = window.getSupabaseClient();
                if (!supabase) {
                    result.textContent = 'âŒ Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ';
                    return;
                }
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    result.textContent = `âŒ ì—ëŸ¬: ${error.message}`;
                    return;
                }
                
                if (session) {
                    result.textContent = `âœ… ë¡œê·¸ì¸ë¨
- ì´ë©”ì¼: ${session.user.email}
- ID: ${session.user.id}
- Provider: ${session.user.app_metadata?.provider || 'unknown'}
- ë§Œë£Œ: ${new Date(session.expires_at * 1000).toLocaleString('ko-KR')}`;
                } else {
                    result.textContent = 'âŒ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ';
                }
            } catch (error) {
                result.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        async function checkAdmin() {
            const result = document.getElementById('admin-result');
            try {
                const session = await window.checkAuth();
                if (!session) {
                    result.textContent = 'âŒ ë¡œê·¸ì¸ í•„ìš”';
                    return;
                }
                
                const userEmail = session.user.email;
                const allowedEmails = window.getConfig('ADMIN.ALLOWED_EMAILS') || [];
                const devMode = window.getConfig('ADMIN.DEV_MODE') || false;
                
                const checks = [];
                checks.push(`ğŸ” ê´€ë¦¬ì ê¶Œí•œ í™•ì¸:`);
                checks.push(`- í˜„ì¬ ì´ë©”ì¼: ${userEmail}`);
                checks.push(`- í—ˆìš©ëœ ì´ë©”ì¼: ${JSON.stringify(allowedEmails)}`);
                checks.push(`- ê°œë°œ ëª¨ë“œ: ${devMode ? 'í™œì„±' : 'ë¹„í™œì„±'}`);
                
                if (devMode) {
                    checks.push('âœ… ê°œë°œ ëª¨ë“œ í™œì„± - ëª¨ë“  ì‚¬ìš©ì í—ˆìš©');
                } else if (allowedEmails.includes(userEmail)) {
                    checks.push('âœ… ê´€ë¦¬ì ê¶Œí•œ ìˆìŒ');
                } else {
                    checks.push('âŒ ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ');
                    checks.push('\nğŸ’¡ í•´ê²° ë°©ë²•:');
                    checks.push(`1. Netlify í™˜ê²½ë³€ìˆ˜ ADMIN_EMAILSì— "${userEmail}" ì¶”ê°€`);
                    checks.push(`2. ë˜ëŠ” config.jsì˜ ALLOWED_EMAILSì— ì¶”ê°€`);
                }
                
                result.textContent = checks.join('\n');
            } catch (error) {
                result.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        function forceLogin() {
            // ê°œë°œ ëª¨ë“œ ì„ì‹œ í™œì„±í™”
            if (window.APP_CONFIG) {
                window.APP_CONFIG.ADMIN.DEV_MODE = true;
                alert('ê°œë°œ ëª¨ë“œ í™œì„±í™”! ì´ì œ admin-v3.htmlì— ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)');
            } else {
                alert('APP_CONFIGê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        }

        function clearAll() {
            // localStorage í´ë¦¬ì–´
            localStorage.clear();
            sessionStorage.clear();
            alert('ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
            window.location.reload();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkConfig();
                checkSession();
            }, 1000);
        });
    </script>
</body>
</html>