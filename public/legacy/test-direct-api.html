<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct API í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #111;
            padding: 15px;
            border: 1px solid #0f0;
            overflow-x: auto;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <!-- Configuration Scripts -->
    <script src="config-loader.js"></script>
    <script src="auth-helper.js"></script>
    <h1>Direct REST API í…ŒìŠ¤íŠ¸ (Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´)</h1>
    
    <button onclick="testDirectAPI()">Direct API í…ŒìŠ¤íŠ¸</button>
    <button onclick="testWithProxy()">Proxy ê²½ìœ  í…ŒìŠ¤íŠ¸</button>
    <button onclick="checkNetwork()">ë„¤íŠ¸ì›Œí¬ ì§„ë‹¨</button>
    
    <pre id="log"></pre>

    <script>
        // Wait for config
        async function waitForConfig() {
            return new Promise((resolve) => {
                if (window.APP_CONFIG?.SUPABASE?.URL) {
                    resolve();
                } else {
                    window.addEventListener('configLoaded', resolve, { once: true });
                    setTimeout(resolve, 2000); // Fallback
                }
            });
        }
        
        // Get configuration
        function getSupabaseConfig() {
            return {
                url: window.APP_CONFIG?.SUPABASE?.URL || 'https://intyabzhvtkxgldmvpvr.supabase.co',
                key: window.APP_CONFIG?.SUPABASE?.ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludHlhYnpodnRreGdsZG12cHZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkxODQwMTEsImV4cCI6MjA0NDc2MDAxMX0.mUgaLB6kQKvpsJ0L3n4cEBE_3S94BmdqYJoF-0K_vK0'
            };
        }
        
        function log(message, type = '') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
        }
        
        // 1. Direct API í˜¸ì¶œ
        async function testDirectAPI() {
            log('Direct API í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                // Wait for config
                await waitForConfig();
                
                const config = getSupabaseConfig();
                if (!config.url || !config.key) {
                    log('âŒ Supabase configuration not found', 'error');
                    return;
                }
                
                // ê°€ì¥ ê¸°ë³¸ì ì¸ ë°©ë²•ìœ¼ë¡œ ì‹œë„
                const response = await fetch(`${config.url}/rest/v1/price_history?select=*&limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': config.key,
                        'Authorization': `Bearer ${config.key}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                });
                
                log(`ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('ë°ì´í„°: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const error = await response.text();
                    log('ì—ëŸ¬ ì‘ë‹µ: ' + error, 'error');
                }
            } catch (error) {
                log(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                log(`ì˜¤ë¥˜ íƒ€ì…: ${error.name}`, 'error');
                
                // ë” ìì„¸í•œ ì§„ë‹¨
                if (error.message.includes('Load failed')) {
                    log('âš ï¸ ë„¤íŠ¸ì›Œí¬ê°€ ì°¨ë‹¨ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:', 'error');
                    log('1. VPNì„ ì‚¬ìš©ì¤‘ì´ë©´ ë„ê³  ì‹œë„', 'error');
                    log('2. íšŒì‚¬/í•™êµ ë„¤íŠ¸ì›Œí¬ëŠ” ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŒ', 'error');
                    log('3. ê´‘ê³  ì°¨ë‹¨ê¸°ë¥¼ ë„ê³  ì‹œë„', 'error');
                    log('4. ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬(ëª¨ë°”ì¼ í•«ìŠ¤íŒŸ ë“±)ë¡œ ì‹œë„', 'error');
                }
            }
        }
        
        // 2. í”„ë¡ì‹œ ê²½ìœ  í…ŒìŠ¤íŠ¸
        async function testWithProxy() {
            log('Proxy ê²½ìœ  í…ŒìŠ¤íŠ¸...');
            
            await waitForConfig();
            const config = getSupabaseConfig();
            
            if (!config.url || !config.key) {
                log('âŒ Supabase configuration not found', 'error');
                return;
            }
            
            // CORS í”„ë¡ì‹œ ì„œë¹„ìŠ¤ ì‚¬ìš© (í…ŒìŠ¤íŠ¸ìš©)
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = `${config.url}/rest/v1/price_history?select=*&limit=1`;
            
            log('âš ï¸ ì´ ë°©ë²•ì€ í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤. ì‹¤ì œ ì‚¬ìš©ì‹œì—ëŠ” ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            log(`Proxy URL: ${proxyUrl}${targetUrl}`);
            
            try {
                const response = await fetch(proxyUrl + targetUrl, {
                    headers: {
                        'apikey': config.key,
                        'Authorization': `Bearer ${config.key}`
                    }
                });
                
                log(`Proxy ì‘ë‹µ: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    log('Proxy ì„œë¹„ìŠ¤ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                    log('https://cors-anywhere.herokuapp.com/corsdemo ì—ì„œ í™œì„±í™” í•„ìš”', 'error');
                }
            } catch (error) {
                log(`Proxy ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // 3. ë„¤íŠ¸ì›Œí¬ ì§„ë‹¨
        async function checkNetwork() {
            log('ë„¤íŠ¸ì›Œí¬ ì§„ë‹¨ ì‹œì‘...');
            
            await waitForConfig();
            const config = getSupabaseConfig();
            
            // 1. ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ìƒíƒœ
            log(`ì˜¨ë¼ì¸ ìƒíƒœ: ${navigator.onLine ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸'}`, navigator.onLine ? 'success' : 'error');
            
            // 2. DNS í•´ì„ í…ŒìŠ¤íŠ¸ (ì´ë¯¸ì§€ë¡œ)
            const img = new Image();
            img.onload = () => log('Supabase ë„ë©”ì¸ ì ‘ê·¼ ê°€ëŠ¥ (ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸)', 'success');
            img.onerror = () => log('Supabase ë„ë©”ì¸ ì ‘ê·¼ ë¶ˆê°€ (ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸)', 'error');
            img.src = `${config.url}/favicon.ico?t=${Date.now()}`;
            
            // 3. ë‹¤ë¥¸ API í…ŒìŠ¤íŠ¸
            try {
                const response = await fetch('https://api.github.com/zen');
                const text = await response.text();
                log(`GitHub API í…ŒìŠ¤íŠ¸: ${text}`, 'success');
            } catch (error) {
                log('GitHub APIë„ ì‹¤íŒ¨ - ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ', 'error');
            }
            
            // 4. WebSocket í…ŒìŠ¤íŠ¸
            try {
                const ws = new WebSocket('wss://echo.websocket.org');
                ws.onopen = () => {
                    log('WebSocket ì—°ê²° ê°€ëŠ¥', 'success');
                    ws.close();
                };
                ws.onerror = () => log('WebSocket ì—°ê²° ë¶ˆê°€', 'error');
            } catch (error) {
                log('WebSocket í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
            }
            
            // 5. ë¡œì»¬ ì„œë²„ ì‹¤í–‰ ì•ˆë‚´
            log('\nğŸ’¡ í•´ê²° ë°©ë²•:', 'success');
            log('1. í„°ë¯¸ë„ì—ì„œ: cd "' + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/')) + '"');
            log('2. Python3: python3 -m http.server 8000');
            log('3. ë¸Œë¼ìš°ì €ì—ì„œ: http://localhost:8000 ì ‘ì†');
            log('4. ì´ íŒŒì¼ì„ ë‹¤ì‹œ ì‹¤í–‰');
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ì§„ë‹¨
        window.addEventListener('DOMContentLoaded', () => {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
            log(`í˜„ì¬ í”„ë¡œí† ì½œ: ${window.location.protocol}`);
            log(`í˜„ì¬ í˜¸ìŠ¤íŠ¸: ${window.location.host || 'file:///'}`);
            
            if (window.location.protocol === 'file:') {
                log('âš ï¸ file:// í”„ë¡œí† ì½œì€ CORS ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!', 'error');
            }
        });
    </script>
</body>
</html>