<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Version Test</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        .warning { color: #fbbf24; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #444;
        }
        .log-entry.part1 { border-color: #3b82f6; }
        .log-entry.part2 { border-color: #10b981; }
    </style>
</head>
<body>
    <!-- Configuration Scripts -->
    <script src="config-loader.js"></script>
    <script src="auth-helper.js"></script>
    <h1>ğŸ”§ Modular Version Test</h1>
    
    <div class="test-section">
        <h2>í…ŒìŠ¤íŠ¸ ëª©ì </h2>
        <p>ì´ í˜ì´ì§€ëŠ” index-modular.htmlì˜ ëª¨ë“ˆí™”ëœ êµ¬ì¡°ê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
        <ul>
            <li>Part1: WebSocket ì½”ì¸ ê°€ê²© (ë…ë¦½ì )</li>
            <li>Part2: Supabase ë°ì´í„° (ì±„íŒ… + ë§í¬) (ë…ë¦½ì )</li>
            <li>ë³€ìˆ˜/í•¨ìˆ˜ ì¶©ëŒ ì—†ìŒ í™•ì¸</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>ì‹¤ì‹œê°„ ë¡œê·¸</h2>
        <button onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <button onclick="testPart1()">Part1 í…ŒìŠ¤íŠ¸</button>
        <button onclick="testPart2()">Part2 í…ŒìŠ¤íŠ¸</button>
        <button onclick="testBoth()">ë™ì‹œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸</button>
        <div id="logs" style="max-height: 400px; overflow-y: auto; margin-top: 20px;"></div>
    </div>
    
    <div class="test-section">
        <h2>ìƒíƒœ í™•ì¸</h2>
        <button onclick="checkStatus()">í˜„ì¬ ìƒíƒœ í™•ì¸</button>
        <div id="status-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ëª¨ë“ˆí™” í˜ì´ì§€</h2>
        <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“ˆí™”ëœ í˜ì´ì§€ë¥¼ ìƒˆ ì°½ì—ì„œ ì—½ë‹ˆë‹¤:</p>
        <button onclick="openModular()">index-modular.html ì—´ê¸°</button>
    </div>

    <script>
        // ë¡œê·¸ ì‹œìŠ¤í…œ
        const logContainer = document.getElementById('logs');
        
        function log(message, type = 'info', part = '') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${part}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="${type}">[${timestamp}] ${part ? `[${part.toUpperCase()}]` : ''} ${message}</span>`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLogs() {
            logContainer.innerHTML = '';
            log('ë¡œê·¸ ì§€ì›€', 'info');
        }
        
        // Part1 í…ŒìŠ¤íŠ¸
        function testPart1() {
            log('Part1 (ì½”ì¸ ê°€ê²©) í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info', 'part1');
            
            // WebSocket ì—°ê²° ì‹œë®¬ë ˆì´ì…˜
            const coins = ['BTC', 'ETH', 'SOL'];
            
            coins.forEach((coin, index) => {
                setTimeout(() => {
                    log(`${coin} WebSocket ì—°ê²° ì‹œë„...`, 'info', 'part1');
                    
                    // ì‹¤ì œ WebSocket í…ŒìŠ¤íŠ¸
                    const ws = new WebSocket(`wss://fstream.binance.com/ws/${coin.toLowerCase()}usdt@ticker`);
                    
                    ws.onopen = () => {
                        log(`âœ… ${coin} WebSocket ì—°ê²° ì„±ê³µ`, 'success', 'part1');
                    };
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        log(`${coin} ê°€ê²©: $${parseFloat(data.c).toFixed(2)}`, 'info', 'part1');
                        ws.close();
                    };
                    
                    ws.onerror = (error) => {
                        log(`âŒ ${coin} WebSocket ì˜¤ë¥˜`, 'error', 'part1');
                    };
                    
                }, index * 1000);
            });
        }
        
        // Part2 í…ŒìŠ¤íŠ¸
        async function testPart2() {
            log('Part2 (Supabase) í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info', 'part2');
            
            // Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
            if (!window.supabase) {
                log('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘...', 'warning', 'part2');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            if (!window.supabase) {
                log('âŒ Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error', 'part2');
                return;
            }
            
            log('âœ… Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œë¨', 'success', 'part2');
            
            try {
                // Wait for config
                const waitForConfig = () => {
                    return new Promise((resolve) => {
                        if (window.APP_CONFIG?.SUPABASE?.URL) {
                            resolve();
                        } else {
                            window.addEventListener('configLoaded', resolve, { once: true });
                            setTimeout(resolve, 2000); // Fallback
                        }
                    });
                };
                
                await waitForConfig();
                
                // Get configuration
                const supabaseUrl = window.APP_CONFIG?.SUPABASE?.URL || 'https://ddfnxbkiewolgweivomv.supabase.co';
                const supabaseKey = window.APP_CONFIG?.SUPABASE?.ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8';
                
                if (!supabaseUrl || !supabaseKey) {
                    log('âŒ Supabase configuration not found', 'error', 'part2');
                    return;
                }
                
                // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±ë¨', 'success', 'part2');
                
                // ë§í¬ ì¡°íšŒ í…ŒìŠ¤íŠ¸
                const { data: links, error: linksError } = await supabase
                    .from('links')
                    .select('*')
                    .limit(5);
                
                if (linksError) {
                    log(`âŒ ë§í¬ ì¡°íšŒ ì‹¤íŒ¨: ${linksError.message}`, 'error', 'part2');
                } else {
                    log(`âœ… ë§í¬ ${links.length}ê°œ ì¡°íšŒ ì„±ê³µ`, 'success', 'part2');
                }
                
                // ë©”ì‹œì§€ ì¡°íšŒ í…ŒìŠ¤íŠ¸
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('*')
                    .limit(5);
                
                if (messagesError) {
                    log(`âŒ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨: ${messagesError.message}`, 'error', 'part2');
                } else {
                    log(`âœ… ë©”ì‹œì§€ ${messages.length}ê°œ ì¡°íšŒ ì„±ê³µ`, 'success', 'part2');
                }
                
            } catch (error) {
                log(`âŒ Part2 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error', 'part2');
            }
        }
        
        // ë™ì‹œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
        function testBoth() {
            log('=== ë™ì‹œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
            testPart1();
            testPart2();
        }
        
        // ìƒíƒœ í™•ì¸
        function checkStatus() {
            const result = document.getElementById('status-result');
            
            const status = {
                supabaseLibrary: !!window.supabase,
                supabaseClient: !!window.supabase?.createClient,
                webSocketAPI: typeof WebSocket !== 'undefined',
                part1Defined: typeof Part1 !== 'undefined',
                part2Defined: typeof Part2 !== 'undefined'
            };
            
            let html = '<h3>ì‹œìŠ¤í…œ ìƒíƒœ</h3><pre>';
            for (const [key, value] of Object.entries(status)) {
                html += `${key}: ${value ? 'âœ…' : 'âŒ'}\n`;
            }
            html += '</pre>';
            
            // ëª¨ë“ˆ ê²©ë¦¬ í™•ì¸
            html += '<h3>ëª¨ë“ˆ ê²©ë¦¬ í…ŒìŠ¤íŠ¸</h3>';
            html += '<p>ê° ëª¨ë“ˆì´ ë…ë¦½ì ì¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸:</p>';
            html += '<pre>';
            
            // Part1ê³¼ Part2ê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (typeof window.Part1 !== 'undefined') {
                html += 'âŒ Part1ì´ ì „ì—­ì— ë…¸ì¶œë¨ (ê²©ë¦¬ ì‹¤íŒ¨)\n';
            } else {
                html += 'âœ… Part1ì´ ì „ì—­ì— ë…¸ì¶œë˜ì§€ ì•ŠìŒ (ê²©ë¦¬ ì„±ê³µ)\n';
            }
            
            if (typeof window.Part2 !== 'undefined') {
                html += 'âŒ Part2ê°€ ì „ì—­ì— ë…¸ì¶œë¨ (ê²©ë¦¬ ì‹¤íŒ¨)\n';
            } else {
                html += 'âœ… Part2ê°€ ì „ì—­ì— ë…¸ì¶œë˜ì§€ ì•ŠìŒ (ê²©ë¦¬ ì„±ê³µ)\n';
            }
            
            html += '</pre>';
            
            result.innerHTML = html;
        }
        
        // ëª¨ë“ˆí™” í˜ì´ì§€ ì—´ê¸°
        function openModular() {
            window.open('index-modular.html', '_blank');
        }
        
        // Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = () => {
            log('âœ… Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ', 'success');
        };
        document.head.appendChild(script);
        
        // ì´ˆê¸° ë¡œê·¸
        log('í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ', 'info');
        log('ê° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“ˆ ë™ì‘ì„ í™•ì¸í•˜ì„¸ìš”', 'info');
    </script>
</body>
</html>