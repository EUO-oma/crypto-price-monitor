<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë™ ê°€ê²© ìˆ˜ì§‘ê¸° - ì›¹ ë²„ì „</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .status-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .online { border-left: 5px solid #4caf50; }
        .offline { border-left: 5px solid #f44336; }
        .collecting { border-left: 5px solid #ff9800; }
        
        button {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .stop-btn {
            background: #f44336;
        }
        .stop-btn:hover {
            background: #da190b;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
            margin: 10px 0;
        }
        
        .log {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #333;
        }
        
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #2a2a2a;
        }
        
        .settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        select {
            padding: 5px 10px;
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– ì›¹ ê¸°ë°˜ ìë™ ê°€ê²© ìˆ˜ì§‘ê¸°</h1>
        
        <!-- ìƒíƒœ í‘œì‹œ -->
        <div class="status-card" id="status-card">
            <h3>ìˆ˜ì§‘ê¸° ìƒíƒœ</h3>
            <p>í˜„ì¬ ìƒíƒœ: <span id="status">ëŒ€ê¸° ì¤‘</span></p>
            <p>ë‹¤ìŒ ìˆ˜ì§‘ê¹Œì§€: <span id="next-collection" class="timer">-</span></p>
            <p>ì´ ìˆ˜ì§‘ íšŸìˆ˜: <span id="collection-count">0</span></p>
            <p>ë§ˆì§€ë§‰ ìˆ˜ì§‘: <span id="last-collection">ì—†ìŒ</span></p>
        </div>
        
        <!-- ì„¤ì • -->
        <div class="status-card">
            <h3>âš™ï¸ ìˆ˜ì§‘ ì„¤ì •</h3>
            <div class="settings">
                <div class="setting-item">
                    <label for="collection-time">ìˆ˜ì§‘ ì‹œê°„:</label>
                    <select id="collection-time">
                        <option value="09:01">ë§¤ì¼ ì˜¤ì „ 9ì‹œ 1ë¶„ (ê¶Œì¥)</option>
                        <option value="00:01">ë§¤ì¼ ìì • 1ë¶„</option>
                        <option value="12:01">ë§¤ì¼ ë‚® 12ì‹œ 1ë¶„</option>
                        <option value="18:01">ë§¤ì¼ ì˜¤í›„ 6ì‹œ 1ë¶„</option>
                        <option value="test">í…ŒìŠ¤íŠ¸ (1ë¶„ë§ˆë‹¤)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="enable-notification" checked>
                    <label for="enable-notification">ë¸Œë¼ìš°ì € ì•Œë¦¼ í™œì„±í™”</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="collect-on-start" checked>
                    <label for="collect-on-start">ì‹œì‘ ì‹œ ì¦‰ì‹œ ìˆ˜ì§‘</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="auto-retry" checked>
                    <label for="auto-retry">ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„</label>
                </div>
            </div>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="startAutoCollection()" id="start-btn">ğŸš€ ìë™ ìˆ˜ì§‘ ì‹œì‘</button>
            <button onclick="stopAutoCollection()" id="stop-btn" class="stop-btn" disabled>â¹ ì¤‘ì§€</button>
            <button onclick="collectNow()">ğŸ“Š ì§€ê¸ˆ ìˆ˜ì§‘</button>
            <button onclick="checkMissingDates()">ğŸ” ëˆ„ë½ëœ ë‚ ì§œ í™•ì¸</button>
        </div>
        
        <!-- ë¡œê·¸ -->
        <div class="status-card">
            <h3>ğŸ“ ìˆ˜ì§‘ ë¡œê·¸</h3>
            <div class="log" id="log"></div>
        </div>
        
        <!-- ìµœê·¼ ìˆ˜ì§‘ ë°ì´í„° -->
        <div class="status-card">
            <h3>ğŸ“ˆ ìµœê·¼ ìˆ˜ì§‘ ë°ì´í„°</h3>
            <table id="recent-data">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>BTC</th>
                        <th>ETH</th>
                        <th>SOL</th>
                        <th>ìˆ˜ì§‘ ì‹œê°„</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align: center;">ë°ì´í„° ì—†ìŒ</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ì•Œë¦¼ -->
    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyA6zB_snzOh_e5tG6_-uK64g6dwL5pzU4c",
            authDomain: "crypto-monitor-84bdb.firebaseapp.com",
            databaseURL: "https://crypto-monitor-84bdb-default-rtdb.firebaseio.com",
            projectId: "crypto-monitor-84bdb",
            storageBucket: "crypto-monitor-84bdb.firebasestorage.app",
            messagingSenderId: "146592267275",
            appId: "1:146592267275:web:916c54658889be5dab9b0e",
            measurementId: "G-TTGCF3YWWJ"
        };
        
        // Firebase ì´ˆê¸°í™”
        let database;
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();
        
        // ì „ì—­ ë³€ìˆ˜
        let collectionInterval = null;
        let countdownInterval = null;
        let collectionCount = 0;
        let isCollecting = false;
        
        // DOM ìš”ì†Œ
        const logDiv = document.getElementById('log');
        const statusSpan = document.getElementById('status');
        const statusCard = document.getElementById('status-card');
        const nextCollectionSpan = document.getElementById('next-collection');
        const collectionCountSpan = document.getElementById('collection-count');
        const lastCollectionSpan = document.getElementById('last-collection');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString('ko-KR');
            logDiv.innerHTML = `<div class="${type}">[${time}] ${message}</div>` + logDiv.innerHTML;
            
            // ë¡œê·¸ ì œí•œ
            const logs = logDiv.children;
            if (logs.length > 100) {
                logDiv.removeChild(logs[logs.length - 1]);
            }
        }
        
        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, duration = 3000) {
            const notificationDiv = document.getElementById('notification');
            notificationDiv.textContent = message;
            notificationDiv.style.display = 'block';
            
            setTimeout(() => {
                notificationDiv.style.display = 'none';
            }, duration);
            
            // ë¸Œë¼ìš°ì € ì•Œë¦¼
            if (document.getElementById('enable-notification').checked && Notification.permission === 'granted') {
                new Notification('ì•”í˜¸í™”í ê°€ê²© ìˆ˜ì§‘ê¸°', {
                    body: message,
                    icon: '/favicon.svg'
                });
            }
        }
        
        // UTC ë‚ ì§œ ë¬¸ìì—´
        function getUTCDateString(date) {
            return date.toISOString().split('T')[0];
        }
        
        // ì–´ì œ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        function getYesterday() {
            const today = new Date();
            return new Date(Date.UTC(
                today.getUTCFullYear(),
                today.getUTCMonth(),
                today.getUTCDate() - 1,
                0, 0, 0, 0
            ));
        }
        
        // íŠ¹ì • ë‚ ì§œ ë°ì´í„° ìˆ˜ì§‘
        async function collectDataForDate(date) {
            const dateStr = getUTCDateString(date);
            log(`${dateStr} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`);
            
            const startTime = date.getTime();
            const endTime = startTime + (24 * 60 * 60 * 1000) - 1;
            
            try {
                const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
                const dayData = {
                    date: dateStr,
                    collected_at: new Date().toISOString(),
                    source: 'web_auto_collector'
                };
                
                for (const symbol of symbols) {
                    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&startTime=${startTime}&endTime=${endTime}&limit=1`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                    }
                    
                    const klines = await response.json();
                    
                    if (klines.length > 0) {
                        const kline = klines[0];
                        const prefix = symbol.replace('USDT', '').toLowerCase();
                        
                        dayData[prefix] = parseFloat(kline[4]);
                        dayData[`${prefix}_open`] = parseFloat(kline[1]);
                        dayData[`${prefix}_high`] = parseFloat(kline[2]);
                        dayData[`${prefix}_low`] = parseFloat(kline[3]);
                        dayData[`${prefix}_volume`] = parseFloat(kline[5]);
                    }
                    
                    // API ì œí•œ ë°©ì§€
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Firebaseì— ì €ì¥
                await database.ref(`prices/${dateStr}`).set(dayData);
                log(`âœ… ${dateStr} ìˆ˜ì§‘ ì™„ë£Œ`, 'success');
                
                return dayData;
                
            } catch (error) {
                log(`âŒ ${dateStr} ìˆ˜ì§‘ ì‹¤íŒ¨: ${error.message}`, 'error');
                
                // ìë™ ì¬ì‹œë„
                if (document.getElementById('auto-retry').checked) {
                    log('30ì´ˆ í›„ ì¬ì‹œë„...', 'warning');
                    setTimeout(() => collectDataForDate(date), 30000);
                }
                
                return null;
            }
        }
        
        // ì§€ê¸ˆ ìˆ˜ì§‘
        async function collectNow() {
            if (isCollecting) {
                log('ì´ë¯¸ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤', 'warning');
                return;
            }
            
            isCollecting = true;
            statusSpan.textContent = 'ìˆ˜ì§‘ ì¤‘...';
            statusCard.className = 'status-card collecting';
            
            try {
                const yesterday = getYesterday();
                const data = await collectDataForDate(yesterday);
                
                if (data) {
                    collectionCount++;
                    collectionCountSpan.textContent = collectionCount;
                    lastCollectionSpan.textContent = new Date().toLocaleString('ko-KR');
                    
                    updateRecentData();
                    showNotification('âœ… ê°€ê²© ìˆ˜ì§‘ ì™„ë£Œ!');
                }
            } finally {
                isCollecting = false;
                statusSpan.textContent = 'ëŒ€ê¸° ì¤‘';
                statusCard.className = 'status-card online';
            }
        }
        
        // ìµœê·¼ ë°ì´í„° ì—…ë°ì´íŠ¸
        async function updateRecentData() {
            try {
                const snapshot = await database.ref('prices').orderByChild('date').limitToLast(5).once('value');
                const data = snapshot.val();
                
                if (!data) return;
                
                const tbody = document.querySelector('#recent-data tbody');
                const sortedData = Object.values(data).sort((a, b) => b.date.localeCompare(a.date));
                
                tbody.innerHTML = sortedData.map(d => `
                    <tr>
                        <td>${d.date}</td>
                        <td>$${d.btc?.toLocaleString() || '-'}</td>
                        <td>$${d.eth?.toLocaleString() || '-'}</td>
                        <td>$${d.sol?.toLocaleString() || '-'}</td>
                        <td>${new Date(d.collected_at).toLocaleTimeString('ko-KR')}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                log('ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ë‹¤ìŒ ìˆ˜ì§‘ ì‹œê°„ ê³„ì‚°
        function getNextCollectionTime() {
            const now = new Date();
            const selectedTime = document.getElementById('collection-time').value;
            
            if (selectedTime === 'test') {
                // í…ŒìŠ¤íŠ¸ ëª¨ë“œ: 1ë¶„ í›„
                const next = new Date(now);
                next.setMinutes(next.getMinutes() + 1);
                return next;
            }
            
            // ì„ íƒëœ ì‹œê°„ìœ¼ë¡œ ë‹¤ìŒ ìˆ˜ì§‘ ì‹œê°„ ì„¤ì •
            const [hours, minutes] = selectedTime.split(':').map(Number);
            const next = new Date(now);
            next.setHours(hours, minutes, 0, 0);
            
            // ì´ë¯¸ ì§€ë‚œ ì‹œê°„ì´ë©´ ë‚´ì¼ë¡œ ì„¤ì •
            if (next <= now) {
                next.setDate(next.getDate() + 1);
            }
            
            return next;
        }
        
        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateCountdown() {
            const now = new Date();
            const next = getNextCollectionTime();
            const diff = next - now;
            
            if (diff <= 0) {
                collectNow();
                return;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            nextCollectionSpan.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        }
        
        // ìë™ ìˆ˜ì§‘ ì‹œì‘
        function startAutoCollection() {
            if (collectionInterval) {
                log('ì´ë¯¸ ìë™ ìˆ˜ì§‘ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤', 'warning');
                return;
            }
            
            log('ğŸš€ ìë™ ìˆ˜ì§‘ ì‹œì‘', 'success');
            statusSpan.textContent = 'ìë™ ìˆ˜ì§‘ í™œì„±í™”';
            statusCard.className = 'status-card online';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // ì‹œì‘ ì‹œ ì¦‰ì‹œ ìˆ˜ì§‘
            if (document.getElementById('collect-on-start').checked) {
                collectNow();
            }
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
            
            // ìˆ˜ì§‘ ê°„ê²© ì„¤ì •
            const checkInterval = document.getElementById('collection-time').value === 'test' 
                ? 60000  // í…ŒìŠ¤íŠ¸: 1ë¶„
                : 60000; // ì¼ë°˜: 1ë¶„ë§ˆë‹¤ ì‹œê°„ ì²´í¬
                
            collectionInterval = setInterval(() => {
                const now = new Date();
                const next = getNextCollectionTime();
                
                if (Math.abs(now - next) < 30000) { // 30ì´ˆ ì´ë‚´ë©´ ì‹¤í–‰
                    collectNow();
                }
            }, checkInterval);
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
            localStorage.setItem('auto_collector_active', 'true');
            localStorage.setItem('auto_collector_started', new Date().toISOString());
        }
        
        // ìë™ ìˆ˜ì§‘ ì¤‘ì§€
        function stopAutoCollection() {
            if (collectionInterval) {
                clearInterval(collectionInterval);
                collectionInterval = null;
            }
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            log('â¹ ìë™ ìˆ˜ì§‘ ì¤‘ì§€', 'warning');
            statusSpan.textContent = 'ì¤‘ì§€ë¨';
            statusCard.className = 'status-card offline';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            nextCollectionSpan.textContent = '-';
            
            localStorage.removeItem('auto_collector_active');
        }
        
        // ëˆ„ë½ëœ ë‚ ì§œ í™•ì¸
        async function checkMissingDates() {
            log('ëˆ„ë½ëœ ë‚ ì§œ í™•ì¸ ì¤‘...');
            
            try {
                const snapshot = await database.ref('prices').once('value');
                const data = snapshot.val() || {};
                const existingDates = new Set(Object.keys(data));
                
                // ìµœê·¼ 30ì¼ í™•ì¸
                const missingDates = [];
                const today = new Date();
                
                for (let i = 1; i <= 30; i++) {
                    const date = new Date(Date.UTC(
                        today.getUTCFullYear(),
                        today.getUTCMonth(),
                        today.getUTCDate() - i
                    ));
                    const dateStr = getUTCDateString(date);
                    
                    if (!existingDates.has(dateStr)) {
                        missingDates.push(dateStr);
                    }
                }
                
                if (missingDates.length > 0) {
                    log(`ğŸ“‹ ëˆ„ë½ëœ ë‚ ì§œ ${missingDates.length}ê°œ ë°œê²¬:`, 'warning');
                    log(missingDates.slice(0, 10).join(', ') + (missingDates.length > 10 ? '...' : ''));
                    
                    if (confirm(`${missingDates.length}ê°œì˜ ëˆ„ë½ëœ ë‚ ì§œë¥¼ ìˆ˜ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        for (const dateStr of missingDates) {
                            const date = new Date(dateStr + 'T00:00:00Z');
                            await collectDataForDate(date);
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                } else {
                    log('âœ… ìµœê·¼ 30ì¼ ë°ì´í„°ê°€ ëª¨ë‘ ìˆìŠµë‹ˆë‹¤', 'success');
                }
                
            } catch (error) {
                log('ëˆ„ë½ í™•ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì´ˆê¸°í™”
        window.onload = async () => {
            // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ìµœê·¼ ë°ì´í„° ë¡œë“œ
            updateRecentData();
            
            // ì´ì „ ìƒíƒœ ë³µì›
            if (localStorage.getItem('auto_collector_active') === 'true') {
                const started = localStorage.getItem('auto_collector_started');
                log(`ì´ì „ ì„¸ì…˜ ë³µì› (ì‹œì‘: ${new Date(started).toLocaleString('ko-KR')})`, 'info');
                startAutoCollection();
            }
            
            log('ì›¹ ê¸°ë°˜ ìë™ ìˆ˜ì§‘ê¸° ì¤€ë¹„ ì™„ë£Œ', 'success');
            log('ì´ í˜ì´ì§€ë¥¼ ì—´ì–´ë‘ë©´ ì„¤ì •ëœ ì‹œê°„ì— ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤', 'info');
        };
        
        // í˜ì´ì§€ ë‹«ê¸° ì „ ê²½ê³ 
        window.onbeforeunload = function(e) {
            if (collectionInterval) {
                return 'ìë™ ìˆ˜ì§‘ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
        };
    </script>
</body>
</html>