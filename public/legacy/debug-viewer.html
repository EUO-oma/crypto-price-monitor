<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Î∑∞Ïñ¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', monospace;
            background: #000;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        select, input, button {
            padding: 8px 12px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #333;
            border-color: #555;
        }

        .refresh-btn {
            background: #4caf50;
            color: white;
            border: none;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .clear-btn {
            background: #f44336;
            color: white;
            border: none;
        }

        .clear-btn:hover {
            background: #d32f2f;
        }

        .logs-table {
            background: #0a0a0a;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #1a1a1a;
            padding: 12px;
            text-align: left;
            font-weight: normal;
            color: #888;
            border-bottom: 2px solid #333;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #222;
            vertical-align: top;
        }

        tr:hover {
            background: #1a1a1a;
        }

        .level-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .level-info { background: #2196f3; color: white; }
        .level-success { background: #4caf50; color: white; }
        .level-warning { background: #ff9800; color: white; }
        .level-error { background: #f44336; color: white; }

        .timestamp {
            color: #666;
            font-size: 12px;
        }

        .source {
            color: #9a8ff8;
            font-weight: bold;
        }

        .message {
            color: #fff;
            max-width: 400px;
            word-wrap: break-word;
        }

        .data {
            color: #888;
            font-size: 12px;
            max-width: 400px;
            overflow-x: auto;
        }

        .data pre {
            background: #1a1a1a;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
        }

        .session-id {
            color: #666;
            font-size: 11px;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-refresh input[type="checkbox"] {
            width: auto;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .no-logs {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Configuration Scripts -->
    <script src="config-loader.js"></script>
    <script src="auth-helper.js"></script>
    <div class="container">
        <div class="header">
            <h1>üêõ ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Î∑∞Ïñ¥</h1>
            <a href="index.html" style="color: #888; text-decoration: none;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</a>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-logs">0</div>
                <div class="stat-label">Ï†ÑÏ≤¥ Î°úÍ∑∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="error-count" style="color: #f44336;">0</div>
                <div class="stat-label">ÏóêÎü¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="warning-count" style="color: #ff9800;">0</div>
                <div class="stat-label">Í≤ΩÍ≥†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="success-count" style="color: #4caf50;">0</div>
                <div class="stat-label">ÏÑ±Í≥µ</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label>ÏÜåÏä§:</label>
                <select id="source-filter">
                    <option value="">Ï†ÑÏ≤¥</option>
                    <option value="fetch-historical">Historical Fetch</option>
                    <option value="daily-collection">Daily Collection</option>
                    <option value="test">Test</option>
                    <option value="supabase-test">Supabase Test</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Î†àÎ≤®:</label>
                <select id="level-filter">
                    <option value="">Ï†ÑÏ≤¥</option>
                    <option value="error">ÏóêÎü¨</option>
                    <option value="warning">Í≤ΩÍ≥†</option>
                    <option value="success">ÏÑ±Í≥µ</option>
                    <option value="info">Ï†ïÎ≥¥</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Ï†úÌïú:</label>
                <select id="limit-filter">
                    <option value="50">50Í∞ú</option>
                    <option value="100">100Í∞ú</option>
                    <option value="200">200Í∞ú</option>
                    <option value="500">500Í∞ú</option>
                </select>
            </div>

            <input type="text" id="search-box" class="search-box" placeholder="Î©îÏãúÏßÄ Í≤ÄÏÉâ...">

            <div class="auto-refresh">
                <input type="checkbox" id="auto-refresh" checked>
                <label for="auto-refresh">ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®</label>
            </div>

            <button onclick="loadLogs()" class="refresh-btn">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
            <button onclick="clearFilters()" style="background: #666;">ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
        </div>

        <div class="logs-table">
            <table>
                <thead>
                    <tr>
                        <th style="width: 150px;">ÏãúÍ∞Ñ</th>
                        <th style="width: 80px;">Î†àÎ≤®</th>
                        <th style="width: 120px;">ÏÜåÏä§</th>
                        <th>Î©îÏãúÏßÄ</th>
                        <th>Îç∞Ïù¥ÌÑ∞</th>
                        <th style="width: 100px;">ÏÑ∏ÏÖò ID</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody">
                    <tr>
                        <td colspan="6" class="loading">Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Wait for config to load
        function waitForConfig() {
            return new Promise((resolve) => {
                if (window.APP_CONFIG?.SUPABASE?.URL) {
                    resolve();
                } else {
                    window.addEventListener('configLoaded', resolve);
                }
            });
        }

        await waitForConfig();
        
        // Use environment variables from config
        const supabaseUrl = window.APP_CONFIG.SUPABASE.URL;
        const supabaseKey = window.APP_CONFIG.SUPABASE.ANON_KEY;
        
        if (!supabaseUrl || !supabaseKey) {
            console.error('‚ùå Supabase configuration not found');
            document.getElementById('logs-tbody').innerHTML = '<tr><td colspan="6" class="loading" style="color: #f44336;">‚ùå Supabase configuration not found</td></tr>';
            throw new Error('Missing Supabase configuration');
        }
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        window.supabaseClient = supabase;

        let autoRefreshInterval;
        let allLogs = [];

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // 1Î∂Ñ Ïù¥ÎÇ¥
                return `${Math.floor(diff / 1000)}Ï¥à Ï†Ñ`;
            } else if (diff < 3600000) { // 1ÏãúÍ∞Ñ Ïù¥ÎÇ¥
                return `${Math.floor(diff / 60000)}Î∂Ñ Ï†Ñ`;
            } else if (diff < 86400000) { // 24ÏãúÍ∞Ñ Ïù¥ÎÇ¥
                return `${Math.floor(diff / 3600000)}ÏãúÍ∞Ñ Ï†Ñ`;
            } else {
                return date.toLocaleString('ko-KR');
            }
        }

        function formatData(data) {
            if (!data) return '';
            if (typeof data === 'string') return data;
            try {
                return JSON.stringify(data, null, 2);
            } catch (e) {
                return String(data);
            }
        }

        async function loadLogs() {
            try {
                const sourceFilter = document.getElementById('source-filter').value;
                const levelFilter = document.getElementById('level-filter').value;
                const limit = parseInt(document.getElementById('limit-filter').value);
                const searchTerm = document.getElementById('search-box').value.toLowerCase();

                let query = supabase
                    .from('debug_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(limit);

                if (sourceFilter) {
                    query = query.eq('source', sourceFilter);
                }

                if (levelFilter) {
                    query = query.eq('level', levelFilter);
                }

                const { data, error } = await query;

                if (error) throw error;

                allLogs = data || [];

                // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞ÎßÅ
                let filteredLogs = allLogs;
                if (searchTerm) {
                    filteredLogs = allLogs.filter(log => 
                        log.message.toLowerCase().includes(searchTerm) ||
                        (log.data && JSON.stringify(log.data).toLowerCase().includes(searchTerm))
                    );
                }

                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateStats(filteredLogs);

                // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
                const tbody = document.getElementById('logs-tbody');
                
                if (filteredLogs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-logs">Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</td></tr>';
                    return;
                }

                tbody.innerHTML = filteredLogs.map(log => {
                    const levelClass = `level-${log.level}`;
                    const dataHtml = log.data ? `<pre>${formatData(log.data)}</pre>` : '';
                    const sessionIdShort = log.session_id ? log.session_id.substring(0, 15) + '...' : '';
                    
                    return `
                        <tr>
                            <td class="timestamp">${formatTimestamp(log.created_at)}</td>
                            <td><span class="level-badge ${levelClass}">${log.level.toUpperCase()}</span></td>
                            <td class="source">${log.source || '-'}</td>
                            <td class="message">${log.message}</td>
                            <td class="data">${dataHtml}</td>
                            <td class="session-id" title="${log.session_id}">${sessionIdShort}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®:', error);
                const tbody = document.getElementById('logs-tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading" style="color: #f44336;">Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®</td></tr>';
            }
        }

        function updateStats(logs) {
            const stats = {
                total: logs.length,
                error: logs.filter(l => l.level === 'error').length,
                warning: logs.filter(l => l.level === 'warning').length,
                success: logs.filter(l => l.level === 'success').length
            };

            document.getElementById('total-logs').textContent = stats.total;
            document.getElementById('error-count').textContent = stats.error;
            document.getElementById('warning-count').textContent = stats.warning;
            document.getElementById('success-count').textContent = stats.success;
        }

        function clearFilters() {
            document.getElementById('source-filter').value = '';
            document.getElementById('level-filter').value = '';
            document.getElementById('search-box').value = '';
            loadLogs();
        }

        function setupAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadLogs, 5000); // 5Ï¥àÎßàÎã§
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.getElementById('source-filter').addEventListener('change', loadLogs);
        document.getElementById('level-filter').addEventListener('change', loadLogs);
        document.getElementById('limit-filter').addEventListener('change', loadLogs);
        document.getElementById('search-box').addEventListener('input', loadLogs);
        document.getElementById('auto-refresh').addEventListener('change', setupAutoRefresh);

        // Ï¥àÍ∏∞ Î°úÎìú
        document.addEventListener('DOMContentLoaded', () => {
            loadLogs();
            setupAutoRefresh();
        });

        // Ï†ÑÏó≠ Ìï®Ïàò
        window.loadLogs = loadLogs;
        window.clearFilters = clearFilters;
    </script>
</body>
</html>