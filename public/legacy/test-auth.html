<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ì¦ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #444;
        }
        
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        
        h2 {
            color: #81C784;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status.success {
            background: #2E7D32;
            color: #E8F5E9;
        }
        
        .status.error {
            background: #C62828;
            color: #FFEBEE;
        }
        
        .status.info {
            background: #1565C0;
            color: #E3F2FD;
        }
        
        .status.warning {
            background: #F57C00;
            color: #FFF3E0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .result-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #555;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .test-item {
            margin: 15px 0;
        }
        
        .test-item strong {
            display: inline-block;
            width: 150px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”’ Supabase ì¸ì¦ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    
    <div class="test-section">
        <h2>1. Supabase ì—°ê²° ìƒíƒœ</h2>
        <div id="connection-test" class="result-box">í…ŒìŠ¤íŠ¸ ì¤‘...</div>
    </div>
    
    <div class="test-section">
        <h2>2. í˜„ì¬ ì„¸ì…˜ ì •ë³´</h2>
        <div id="session-test" class="result-box">í™•ì¸ ì¤‘...</div>
        <button onclick="refreshSession()">ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    
    <div class="test-section">
        <h2>3. ì¸ì¦ í…ŒìŠ¤íŠ¸</h2>
        <div class="test-item">
            <button onclick="testGoogleLogin()">Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testLogout()">ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</button>
        </div>
        <div id="auth-test" class="result-box">ëŒ€ê¸° ì¤‘...</div>
    </div>
    
    <div class="test-section">
        <h2>4. ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ í…ŒìŠ¤íŠ¸</h2>
        <div class="test-item">
            <button onclick="testReadLinks()">ì½ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testInsertLink()">ì“°ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testUpdateLink()">ìˆ˜ì • ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testDeleteLink()">ì‚­ì œ ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
        </div>
        <div id="db-test" class="result-box">ëŒ€ê¸° ì¤‘...</div>
    </div>
    
    <div class="test-section">
        <h2>5. RLS ì •ì±… í™•ì¸</h2>
        <button onclick="checkRLSPolicies()">RLS ì •ì±… í™•ì¸</button>
        <div id="rls-test" class="result-box">ëŒ€ê¸° ì¤‘...</div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
        <a href="index.html" style="color: #81C784;">â† ë©”ì¸ í˜ì´ì§€</a>
        <a href="login.html" style="color: #81C784; margin-left: 20px;">ë¡œê·¸ì¸ í˜ì´ì§€ â†’</a>
        <a href="admin-v3.html" style="color: #81C784; margin-left: 20px;">ê´€ë¦¬ì í˜ì´ì§€ â†’</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-env.js"></script>
    <script src="config-loader.js"></script>
    <script src="auth-helper.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', async () => {
            await testConnection();
            await checkSession();
        });

        // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            const resultDiv = document.getElementById('connection-test');
            try {
                const { data, error } = await window.supabaseClient.from('links').select('count');
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                resultDiv.innerHTML = `âœ… Supabase ì—°ê²° ì„±ê³µ!
URL: ${SUPABASE_URL}
í…Œì´ë¸” ì ‘ê·¼: ê°€ëŠ¥`;
                resultDiv.className = 'result-box status success';
            } catch (error) {
                resultDiv.innerHTML = `âŒ Supabase ì—°ê²° ì‹¤íŒ¨!
ì˜¤ë¥˜: ${error.message}`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ì„¸ì…˜ í™•ì¸
        async function checkSession() {
            const resultDiv = document.getElementById('session-test');
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (session) {
                    resultDiv.innerHTML = `âœ… ë¡œê·¸ì¸ ìƒíƒœ
ì´ë©”ì¼: ${session.user.email}
ID: ${session.user.id}
Provider: ${session.user.app_metadata.provider}
ë§Œë£Œì‹œê°„: ${new Date(session.expires_at * 1000).toLocaleString('ko-KR')}`;
                    resultDiv.className = 'result-box status success';
                } else {
                    resultDiv.innerHTML = `âš ï¸ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ`;
                    resultDiv.className = 'result-box status warning';
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨: ${error.message}`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨
        async function refreshSession() {
            await checkSession();
        }

        // Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
        async function testGoogleLogin() {
            const resultDiv = document.getElementById('auth-test');
            try {
                const { data, error } = await window.supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });
                if (error) throw error;
                resultDiv.innerHTML = `ğŸ”„ Google ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...`;
                resultDiv.className = 'result-box status info';
            } catch (error) {
                resultDiv.innerHTML = `âŒ Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸
        async function testLogout() {
            const resultDiv = document.getElementById('auth-test');
            try {
                const { error } = await window.supabaseClient.auth.signOut();
                if (error) throw error;
                resultDiv.innerHTML = `âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ`;
                resultDiv.className = 'result-box status success';
                await checkSession();
            } catch (error) {
                resultDiv.innerHTML = `âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ì½ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸
        async function testReadLinks() {
            const resultDiv = document.getElementById('db-test');
            try {
                const { data, error } = await window.supabaseClient.from('links')
                    .select('*')
                    .limit(5);
                if (error) throw error;
                resultDiv.innerHTML = `âœ… ì½ê¸° ì„±ê³µ! ${data.length}ê°œ ë§í¬ ì¡°íšŒë¨`;
                resultDiv.className = 'result-box status success';
            } catch (error) {
                resultDiv.innerHTML = `âŒ ì½ê¸° ì‹¤íŒ¨: ${error.message}`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ì“°ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸
        async function testInsertLink() {
            const resultDiv = document.getElementById('db-test');
            const session = await checkAuth();
            
            if (!session) {
                resultDiv.innerHTML = `âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤`;
                resultDiv.className = 'result-box status warning';
                return;
            }
            
            try {
                const testData = {
                    name: 'Test Link',
                    url: 'https://test.com',
                    category: 'youtube',
                    sort_order: 9999
                };
                
                const { data, error } = await window.supabaseClient.from('links')
                    .insert([testData])
                    .select();
                    
                if (error) throw error;
                resultDiv.innerHTML = `âœ… ì“°ê¸° ì„±ê³µ! í…ŒìŠ¤íŠ¸ ë§í¬ ì¶”ê°€ë¨ (ID: ${data[0].id})`;
                resultDiv.className = 'result-box status success';
            } catch (error) {
                resultDiv.innerHTML = `âŒ ì“°ê¸° ì‹¤íŒ¨: ${error.message}
(ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥)`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ìˆ˜ì • ê¶Œí•œ í…ŒìŠ¤íŠ¸
        async function testUpdateLink() {
            const resultDiv = document.getElementById('db-test');
            const session = await checkAuth();
            
            if (!session) {
                resultDiv.innerHTML = `âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤`;
                resultDiv.className = 'result-box status warning';
                return;
            }
            
            try {
                // ë¨¼ì € í…ŒìŠ¤íŠ¸ ë§í¬ ì°¾ê¸°
                const { data: links } = await window.supabaseClient.from('links')
                    .select('*')
                    .eq('name', 'Test Link')
                    .limit(1);
                    
                if (!links || links.length === 0) {
                    resultDiv.innerHTML = `âš ï¸ ìˆ˜ì •í•  í…ŒìŠ¤íŠ¸ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì“°ê¸° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.`;
                    resultDiv.className = 'result-box status warning';
                    return;
                }
                
                const { error } = await window.supabaseClient.from('links')
                    .update({ name: 'Test Link (Updated)' })
                    .eq('id', links[0].id);
                    
                if (error) throw error;
                resultDiv.innerHTML = `âœ… ìˆ˜ì • ì„±ê³µ! í…ŒìŠ¤íŠ¸ ë§í¬ ì—…ë°ì´íŠ¸ë¨`;
                resultDiv.className = 'result-box status success';
            } catch (error) {
                resultDiv.innerHTML = `âŒ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}
(ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥)`;
                resultDiv.className = 'result-box status error';
            }
        }

        // ì‚­ì œ ê¶Œí•œ í…ŒìŠ¤íŠ¸
        async function testDeleteLink() {
            const resultDiv = document.getElementById('db-test');
            const session = await checkAuth();
            
            if (!session) {
                resultDiv.innerHTML = `âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤`;
                resultDiv.className = 'result-box status warning';
                return;
            }
            
            try {
                // í…ŒìŠ¤íŠ¸ ë§í¬ ëª¨ë‘ ì‚­ì œ
                const { error } = await window.supabaseClient.from('links')
                    .delete()
                    .or('name.eq.Test Link,name.eq.Test Link (Updated)');
                    
                if (error) throw error;
                resultDiv.innerHTML = `âœ… ì‚­ì œ ì„±ê³µ! í…ŒìŠ¤íŠ¸ ë§í¬ ì œê±°ë¨`;
                resultDiv.className = 'result-box status success';
            } catch (error) {
                resultDiv.innerHTML = `âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message}
(ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥)`;
                resultDiv.className = 'result-box status error';
            }
        }

        // RLS ì •ì±… í™•ì¸
        async function checkRLSPolicies() {
            const resultDiv = document.getElementById('rls-test');
            resultDiv.innerHTML = `â„¹ï¸ RLS ì •ì±… ì •ë³´:

1. SELECT (ì½ê¸°): ëª¨ë“  ì‚¬ìš©ì í—ˆìš©
   - ë©”ì¸ í˜ì´ì§€ì—ì„œ ë§í¬ë¥¼ ë³¼ ìˆ˜ ìˆìŒ

2. INSERT (ì¶”ê°€): ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
   - Google ë¡œê·¸ì¸ í•„ìš”

3. UPDATE (ìˆ˜ì •): ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
   - Google ë¡œê·¸ì¸ í•„ìš”

4. DELETE (ì‚­ì œ): ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
   - Google ë¡œê·¸ì¸ í•„ìš”

RLS ì •ì±…ì„ ë³€ê²½í•˜ë ¤ë©´ Supabase Dashboardì˜ 
SQL Editorì—ì„œ rls-policies.sql íŒŒì¼ì„ ì‹¤í–‰í•˜ì„¸ìš”.`;
            resultDiv.className = 'result-box status info';
        }
    </script>
</body>
</html>