<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 테스트</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        button {
            background: #4285F4;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px;
        }
        pre {
            background: #111;
            padding: 10px;
            border: 1px solid #0f0;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>OAuth 로그인 테스트</h1>
    
    <button onclick="testLogin()">Google 로그인 테스트</button>
    <button onclick="checkSession()">세션 확인</button>
    <button onclick="signOut()">로그아웃</button>
    <button onclick="checkConfig()">설정 확인</button>
    
    <h2>결과:</h2>
    <pre id="output">대기 중...</pre>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-loader.js"></script>
    
    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.textContent += message + '\n';
            console.log(message);
        }

        async function checkConfig() {
            log('\n=== 설정 확인 ===');
            log('APP_CONFIG: ' + (window.APP_CONFIG ? 'OK' : 'Missing'));
            if (window.APP_CONFIG) {
                log('SUPABASE URL: ' + window.APP_CONFIG.SUPABASE.URL);
                log('SUPABASE KEY: ' + (window.APP_CONFIG.SUPABASE.ANON_KEY ? 'Set' : 'Missing'));
            }
        }

        async function testLogin() {
            try {
                log('\n=== 로그인 시작 ===');
                
                if (!window.APP_CONFIG) {
                    throw new Error('APP_CONFIG not loaded');
                }
                
                const supabase = window.supabase.createClient(
                    window.APP_CONFIG.SUPABASE.URL,
                    window.APP_CONFIG.SUPABASE.ANON_KEY
                );
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/test-oauth.html'
                    }
                });
                
                if (error) {
                    log('로그인 에러: ' + error.message);
                } else {
                    log('로그인 요청 성공, Google로 리다이렉트됩니다...');
                }
            } catch (error) {
                log('에러: ' + error.message);
            }
        }

        async function checkSession() {
            try {
                log('\n=== 세션 확인 ===');
                
                const supabase = window.supabase.createClient(
                    window.APP_CONFIG.SUPABASE.URL,
                    window.APP_CONFIG.SUPABASE.ANON_KEY
                );
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log('세션 에러: ' + error.message);
                } else if (session) {
                    log('로그인됨!');
                    log('이메일: ' + session.user.email);
                    log('Provider: ' + session.user.app_metadata.provider);
                } else {
                    log('로그인되지 않음');
                }
                
                // URL 파라미터 확인
                if (window.location.hash) {
                    log('\nURL Hash: ' + window.location.hash);
                }
            } catch (error) {
                log('에러: ' + error.message);
            }
        }

        async function signOut() {
            try {
                log('\n=== 로그아웃 ===');
                
                const supabase = window.supabase.createClient(
                    window.APP_CONFIG.SUPABASE.URL,
                    window.APP_CONFIG.SUPABASE.ANON_KEY
                );
                
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    log('로그아웃 에러: ' + error.message);
                } else {
                    log('로그아웃 성공');
                }
            } catch (error) {
                log('에러: ' + error.message);
            }
        }

        // 페이지 로드 시 자동 실행
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkConfig();
                checkSession();
            }, 1000);
        });
    </script>
</body>
</html>