<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BW - Volume Profile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'SF Mono', monospace;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.3;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .symbol-btn,
        .timeframe-btn {
            background: #111;
            border: 1px solid #222;
            color: #666;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 14px;
        }
        
        .symbol-btn.active,
        .timeframe-btn.active {
            border-color: #fff;
            color: #fff;
            background: #222;
        }
        
        .symbol-btn:hover,
        .timeframe-btn:hover {
            border-color: #444;
            color: #aaa;
        }
        
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .profile-card {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 20px;
            position: relative;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .symbol-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .current-price {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .price-change {
            font-size: 14px;
            opacity: 0.7;
        }
        
        .price-change.positive { color: #0f0; }
        .price-change.negative { color: #f00; }
        
        .profile-visual {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .price-level {
            position: absolute;
            left: 0;
            right: 0;
            height: 14px;
            display: flex;
            align-items: center;
            font-size: 11px;
            transition: all 0.2s;
            transform: translateY(-50%);
        }
        
        .price-bar {
            height: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            margin-right: 8px;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 2px;
        }
        
        .price-bar:hover {
            background: #2a2a2a;
            border-color: #555;
        }
        
        .volume-fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            opacity: 0.8;
        }
        
        .price-label {
            color: #888;
            min-width: 70px;
            text-align: right;
            padding-right: 8px;
            font-size: 10px;
        }
        
        .volume-value {
            color: #666;
            font-size: 9px;
            margin-left: 5px;
            opacity: 0.8;
        }
        
        .poc-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #f00;
            opacity: 0.8;
            box-shadow: 0 0 10px rgba(255,0,0,0.5);
        }
        
        .poc-label {
            position: absolute;
            right: 10px;
            background: #f00;
            color: #fff;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 3px;
            transform: translateY(-50%);
        }
        
        .vwap-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: #ff0;
            opacity: 0.8;
        }
        
        .vwap-label {
            position: absolute;
            right: 10px;
            background: #ff0;
            color: #000;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 3px;
            transform: translateY(-50%);
        }
        
        .current-price-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #00f;
            opacity: 0.8;
            box-shadow: 0 0 10px rgba(0,0,255,0.5);
        }
        
        .current-price-label {
            position: absolute;
            right: 10px;
            background: #00f;
            color: #fff;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 3px;
            transform: translateY(-50%);
        }
        
        .liquidation-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            opacity: 0.6;
            border-top: 1px dashed;
        }
        
        .liquidation-line.long {
            border-color: #0f0;
        }
        
        .liquidation-line.short {
            border-color: #f00;
        }
        
        .liquidation-label {
            position: absolute;
            left: 10px;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            transform: translateY(-50%);
        }
        
        .liquidation-label.long {
            background: rgba(0,255,0,0.2);
            color: #0f0;
            border: 1px solid #0f0;
        }
        
        .liquidation-label.short {
            background: rgba(255,0,0,0.2);
            color: #f00;
            border: 1px solid #f00;
        }
        
        .stats-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #222;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            background: #111;
            padding: 10px;
            border: 1px solid #222;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            margin-top: 50px;
            color: #666;
        }
        
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .back-link:hover {
            color: #fff;
        }
        
        .info-text {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .controls {
                gap: 5px;
            }
            
            .symbol-btn,
            .timeframe-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .profile-container {
                grid-template-columns: 1fr;
            }
            
            .profile-visual {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <a href="bw-mode.html" class="back-link">← back</a>
    
    <div class="header">volume profile analysis</div>
    
    <div class="controls">
        <div class="control-group">
            <span style="color: #666; font-size: 12px;">TIMEFRAME:</span>
            <button class="timeframe-btn" onclick="setTimeframe('5m', 60)">5M</button>
            <button class="timeframe-btn" onclick="setTimeframe('15m', 48)">15M</button>
            <button class="timeframe-btn active" onclick="setTimeframe('1h', 48)">1H</button>
            <button class="timeframe-btn" onclick="setTimeframe('4h', 48)">4H</button>
            <button class="timeframe-btn" onclick="setTimeframe('1d', 30)">1D</button>
        </div>
    </div>
    
    <div class="profile-container" id="profile-container">
        <div class="loading">Analyzing volume profiles...</div>
    </div>
    
    <div class="info-text">
        POC (Point of Control) = 가장 많은 거래가 발생한 가격대<br>
        VWAP = 거래량 가중 평균 가격
    </div>

    <script>
        let currentTimeframe = '1h';
        let currentLimit = 48;
        let profileData = {};
        
        const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'AVAXUSDT'];
        
        function setTimeframe(timeframe, limit) {
            currentTimeframe = timeframe;
            currentLimit = limit;
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Clear and reload
            profileData = {};
            document.getElementById('profile-container').innerHTML = '<div class="loading">Analyzing volume profiles...</div>';
            symbols.forEach(symbol => fetchKlinesForProfile(symbol));
        }
        
        async function fetchKlinesForProfile(symbol) {
            try {
                const response = await fetch(
                    `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${currentTimeframe}&limit=${currentLimit}`
                );
                const klines = await response.json();
                
                // Process klines data
                const processedData = klines.map(k => ({
                    time: new Date(k[0]),
                    open: parseFloat(k[1]),
                    high: parseFloat(k[2]),
                    low: parseFloat(k[3]),
                    close: parseFloat(k[4]),
                    volume: parseFloat(k[5]),
                    quoteVolume: parseFloat(k[7])
                }));
                
                // Calculate volume profile
                const profile = calculateVolumeProfile(processedData);
                
                // Calculate statistics
                const currentPrice = processedData[processedData.length - 1].close;
                const openPrice = processedData[0].open;
                const change24h = ((currentPrice - openPrice) / openPrice) * 100;
                
                profileData[symbol] = {
                    currentPrice,
                    change24h,
                    profile,
                    ...profile.stats
                };
                
                updateProfileDisplay();
                
            } catch (error) {
                console.error('Error fetching klines for', symbol, error);
            }
        }
        
        function calculateVolumeProfile(klines) {
            // Find price range
            const allPrices = klines.flatMap(k => [k.high, k.low]);
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);
            const priceRange = maxPrice - minPrice;
            
            // Create price levels (15 levels for less overlap)
            const levels = 15;
            const levelSize = priceRange / levels;
            const volumeProfile = new Array(levels).fill(0);
            const priceAtLevel = new Array(levels).fill(0);
            
            // Calculate volume at each price level
            klines.forEach(k => {
                const avgPrice = (k.high + k.low) / 2;
                const levelIndex = Math.floor((avgPrice - minPrice) / levelSize);
                if (levelIndex >= 0 && levelIndex < levels) {
                    volumeProfile[levelIndex] += k.volume;
                    priceAtLevel[levelIndex] = minPrice + (levelIndex + 0.5) * levelSize;
                }
            });
            
            // Find POC (Point of Control)
            const maxVolume = Math.max(...volumeProfile);
            const pocIndex = volumeProfile.indexOf(maxVolume);
            const poc = priceAtLevel[pocIndex];
            
            // Calculate VWAP
            let totalVolume = 0;
            let volumeWeightedPrice = 0;
            klines.forEach(k => {
                const avgPrice = (k.high + k.low + k.close) / 3;
                volumeWeightedPrice += avgPrice * k.volume;
                totalVolume += k.volume;
            });
            const vwap = volumeWeightedPrice / totalVolume;
            
            // Calculate value area (70% of volume)
            const sortedLevels = volumeProfile
                .map((v, i) => ({ volume: v, price: priceAtLevel[i], index: i }))
                .sort((a, b) => b.volume - a.volume);
            
            let accumulatedVolume = 0;
            const targetVolume = totalVolume * 0.7;
            let valueAreaHigh = 0;
            let valueAreaLow = Infinity;
            
            for (const level of sortedLevels) {
                if (accumulatedVolume < targetVolume) {
                    accumulatedVolume += level.volume;
                    valueAreaHigh = Math.max(valueAreaHigh, level.price);
                    valueAreaLow = Math.min(valueAreaLow, level.price);
                }
            }
            
            return {
                levels: volumeProfile.map((v, i) => ({
                    price: priceAtLevel[i],
                    volume: v,
                    percentage: (v / maxVolume) * 100
                })),
                stats: {
                    poc,
                    vwap,
                    valueAreaHigh,
                    valueAreaLow,
                    totalVolume,
                    minPrice,
                    maxPrice
                }
            };
        }
        
        function createProfileCard(symbol) {
            const card = document.createElement('div');
            card.className = 'profile-card';
            card.id = `profile-${symbol}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="symbol-name">${symbol.replace('USDT', '')}</div>
                        <div class="current-price">-</div>
                        <div class="price-change">-</div>
                    </div>
                </div>
                <div class="profile-visual">
                    <!-- Price levels will be added here -->
                </div>
                <div class="stats-section">
                    <div class="stat-item">
                        <div class="stat-label">POC</div>
                        <div class="stat-value" id="poc-${symbol}">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">VWAP</div>
                        <div class="stat-value" id="vwap-${symbol}">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Value Area High</div>
                        <div class="stat-value" id="vah-${symbol}">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Value Area Low</div>
                        <div class="stat-value" id="val-${symbol}">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">POC 25x Long Liq</div>
                        <div class="stat-value" id="poc-long-liq-${symbol}" style="color: #0f0;">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">POC 25x Short Liq</div>
                        <div class="stat-value" id="poc-short-liq-${symbol}" style="color: #f00;">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">POC 50x Long Liq</div>
                        <div class="stat-value" id="poc-long-liq-50-${symbol}" style="color: #0f0; opacity: 0.7;">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">POC 50x Short Liq</div>
                        <div class="stat-value" id="poc-short-liq-50-${symbol}" style="color: #f00; opacity: 0.7;">-</div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function updateProfileDisplay() {
            const container = document.getElementById('profile-container');
            
            // Clear loading if all loaded
            if (Object.keys(profileData).length === symbols.length) {
                const loading = container.querySelector('.loading');
                if (loading) loading.remove();
            }
            
            symbols.forEach(symbol => {
                if (!profileData[symbol]) return;
                
                let card = document.getElementById(`profile-${symbol}`);
                if (!card) {
                    card = createProfileCard(symbol);
                    container.appendChild(card);
                }
                
                const data = profileData[symbol];
                
                // Update price info
                card.querySelector('.current-price').textContent = 
                    `$${formatPrice(data.currentPrice, symbol)}`;
                
                const changeEl = card.querySelector('.price-change');
                changeEl.textContent = `${data.change24h >= 0 ? '+' : ''}${data.change24h.toFixed(2)}%`;
                changeEl.className = `price-change ${data.change24h >= 0 ? 'positive' : 'negative'}`;
                
                // Update visual profile
                const visual = card.querySelector('.profile-visual');
                visual.innerHTML = '';
                
                const priceRange = data.maxPrice - data.minPrice;
                
                // Add price levels
                data.profile.levels.forEach((level, index) => {
                    if (level.volume === 0) return;
                    
                    const levelEl = document.createElement('div');
                    levelEl.className = 'price-level';
                    levelEl.style.top = `${(1 - (level.price - data.minPrice) / priceRange) * 100}%`;
                    
                    // Reduce bar width to prevent overlap
                    const barWidth = `${Math.min(level.percentage * 0.8, 80)}%`;
                    
                    levelEl.innerHTML = `
                        <div class="price-label">$${formatPrice(level.price, symbol)}</div>
                        <div class="price-bar" style="width: ${barWidth}">
                            <div class="volume-fill" style="width: 100%"></div>
                        </div>
                        <div class="volume-value">${formatVolume(level.volume)}</div>
                    `;
                    
                    visual.appendChild(levelEl);
                });
                
                // Add POC line
                const pocPosition = ((data.poc - data.minPrice) / priceRange) * 100;
                const pocLine = document.createElement('div');
                pocLine.className = 'poc-line';
                pocLine.style.bottom = `${pocPosition}%`;
                pocLine.innerHTML = `<div class="poc-label">POC</div>`;
                visual.appendChild(pocLine);
                
                // Add VWAP line
                const vwapPosition = ((data.vwap - data.minPrice) / priceRange) * 100;
                const vwapLine = document.createElement('div');
                vwapLine.className = 'vwap-line';
                vwapLine.style.bottom = `${vwapPosition}%`;
                vwapLine.innerHTML = `<div class="vwap-label">VWAP</div>`;
                visual.appendChild(vwapLine);
                
                // Add current price line
                const currentPricePosition = ((data.currentPrice - data.minPrice) / priceRange) * 100;
                const currentPriceLine = document.createElement('div');
                currentPriceLine.className = 'current-price-line';
                currentPriceLine.style.bottom = `${currentPricePosition}%`;
                currentPriceLine.innerHTML = `<div class="current-price-label">현재가</div>`;
                visual.appendChild(currentPriceLine);
                
                // Calculate and add POC-based liquidation lines
                const maintenanceMargin = 0.004; // 0.4%
                const liq25Long = data.poc * (1 - 1/25 + maintenanceMargin);
                const liq25Short = data.poc * (1 + 1/25 - maintenanceMargin);
                const liq50Long = data.poc * (1 - 1/50 + maintenanceMargin);
                const liq50Short = data.poc * (1 + 1/50 - maintenanceMargin);
                
                // Add 50x long liquidation line (closer to POC)
                if (liq50Long >= data.minPrice && liq50Long <= data.maxPrice) {
                    const liq50LongPosition = ((liq50Long - data.minPrice) / priceRange) * 100;
                    const liq50LongLine = document.createElement('div');
                    liq50LongLine.className = 'liquidation-line long';
                    liq50LongLine.style.bottom = `${liq50LongPosition}%`;
                    liq50LongLine.style.opacity = '0.4';
                    liq50LongLine.innerHTML = `<div class="liquidation-label long" style="font-size: 9px;">50x Long</div>`;
                    visual.appendChild(liq50LongLine);
                }
                
                // Add 50x short liquidation line (closer to POC)
                if (liq50Short >= data.minPrice && liq50Short <= data.maxPrice) {
                    const liq50ShortPosition = ((liq50Short - data.minPrice) / priceRange) * 100;
                    const liq50ShortLine = document.createElement('div');
                    liq50ShortLine.className = 'liquidation-line short';
                    liq50ShortLine.style.bottom = `${liq50ShortPosition}%`;
                    liq50ShortLine.style.opacity = '0.4';
                    liq50ShortLine.innerHTML = `<div class="liquidation-label short" style="font-size: 9px;">50x Short</div>`;
                    visual.appendChild(liq50ShortLine);
                }
                
                // Add 25x long liquidation line
                if (liq25Long >= data.minPrice && liq25Long <= data.maxPrice) {
                    const liq25LongPosition = ((liq25Long - data.minPrice) / priceRange) * 100;
                    const liq25LongLine = document.createElement('div');
                    liq25LongLine.className = 'liquidation-line long';
                    liq25LongLine.style.bottom = `${liq25LongPosition}%`;
                    liq25LongLine.innerHTML = `<div class="liquidation-label long">25x Long Liq</div>`;
                    visual.appendChild(liq25LongLine);
                }
                
                // Add 25x short liquidation line
                if (liq25Short >= data.minPrice && liq25Short <= data.maxPrice) {
                    const liq25ShortPosition = ((liq25Short - data.minPrice) / priceRange) * 100;
                    const liq25ShortLine = document.createElement('div');
                    liq25ShortLine.className = 'liquidation-line short';
                    liq25ShortLine.style.bottom = `${liq25ShortPosition}%`;
                    liq25ShortLine.innerHTML = `<div class="liquidation-label short">25x Short Liq</div>`;
                    visual.appendChild(liq25ShortLine);
                }
                
                // Update stats
                document.getElementById(`poc-${symbol}`).textContent = 
                    `$${formatPrice(data.poc, symbol)}`;
                document.getElementById(`vwap-${symbol}`).textContent = 
                    `$${formatPrice(data.vwap, symbol)}`;
                document.getElementById(`vah-${symbol}`).textContent = 
                    `$${formatPrice(data.valueAreaHigh, symbol)}`;
                document.getElementById(`val-${symbol}`).textContent = 
                    `$${formatPrice(data.valueAreaLow, symbol)}`;
                
                // Update POC-based liquidation prices
                document.getElementById(`poc-long-liq-${symbol}`).textContent = 
                    `$${formatPrice(liq25Long, symbol)}`;
                document.getElementById(`poc-short-liq-${symbol}`).textContent = 
                    `$${formatPrice(liq25Short, symbol)}`;
                document.getElementById(`poc-long-liq-50-${symbol}`).textContent = 
                    `$${formatPrice(liq50Long, symbol)}`;
                document.getElementById(`poc-short-liq-50-${symbol}`).textContent = 
                    `$${formatPrice(liq50Short, symbol)}`;
            });
        }
        
        function formatPrice(price, symbol) {
            const decimals = symbol === 'XRPUSDT' ? 4 : 2;
            return price.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        function formatVolume(volume) {
            if (volume > 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            } else if (volume > 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return volume.toFixed(0);
        }
        
        // Initialize
        symbols.forEach(symbol => fetchKlinesForProfile(symbol));
        
        // Refresh every 30 seconds
        setInterval(() => {
            symbols.forEach(symbol => fetchKlinesForProfile(symbol));
        }, 30000);
    </script>
</body>
</html>