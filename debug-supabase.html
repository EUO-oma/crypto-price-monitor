<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 연결 디버그</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
        }
        
        h1, h2 {
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
        }
        
        .error {
            color: #f00;
        }
        
        .success {
            color: #0f0;
        }
        
        .warning {
            color: #ff0;
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
            font-family: monospace;
            font-weight: bold;
        }
        
        button:hover {
            background: #0a0;
        }
        
        pre {
            background: #111;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        #log {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 Supabase 연결 디버그</h1>
    
    <div class="section">
        <h2>1. 환경 확인</h2>
        <div id="env-check"></div>
    </div>
    
    <div class="section">
        <h2>2. Supabase SDK 상태</h2>
        <div id="sdk-status"></div>
    </div>
    
    <div class="section">
        <h2>3. 연결 테스트</h2>
        <button onclick="testDirectConnection()">직접 연결 테스트</button>
        <button onclick="testWithConfig()">Config 연결 테스트</button>
        <button onclick="testQuery()">쿼리 테스트</button>
        <button onclick="clearLog()">로그 클리어</button>
    </div>
    
    <div class="section">
        <h2>4. 로그</h2>
        <pre id="log"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const log = (message, type = 'info') => {
            const logEl = document.getElementById('log');
            const time = new Date().toTimeString().split(' ')[0];
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logEl.innerHTML += `<span class="${colorClass}">[${time}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        };
        
        const clearLog = () => {
            document.getElementById('log').innerHTML = '';
            log('로그 클리어됨', 'info');
        };
        
        // 환경 확인
        function checkEnvironment() {
            const envEl = document.getElementById('env-check');
            let html = '<ul>';
            
            html += `<li>현재 URL: ${window.location.href}</li>`;
            html += `<li>Netlify 환경: ${window.location.hostname.includes('netlify') ? 'Yes' : 'No'}</li>`;
            html += `<li>window.supabase 존재: ${window.supabase ? '<span class="success">Yes</span>' : '<span class="error">No</span>'}</li>`;
            html += `<li>window.supabase.createClient 존재: ${window.supabase?.createClient ? '<span class="success">Yes</span>' : '<span class="error">No</span>'}</li>`;
            html += `<li>window.supabaseClient 존재: ${window.supabaseClient ? '<span class="success">Yes</span>' : '<span class="error">No</span>'}</li>`;
            html += `<li>window.APP_CONFIG 존재: ${window.APP_CONFIG ? '<span class="success">Yes</span>' : '<span class="error">No</span>'}</li>`;
            
            if (window.APP_CONFIG) {
                html += `<li>APP_CONFIG.SUPABASE.URL: ${window.APP_CONFIG.SUPABASE?.URL || 'undefined'}</li>`;
                html += `<li>APP_CONFIG.SUPABASE.ANON_KEY: ${window.APP_CONFIG.SUPABASE?.ANON_KEY ? '***' + window.APP_CONFIG.SUPABASE.ANON_KEY.slice(-10) : 'undefined'}</li>`;
            }
            
            html += '</ul>';
            envEl.innerHTML = html;
        }
        
        // SDK 상태 확인
        function checkSDKStatus() {
            const sdkEl = document.getElementById('sdk-status');
            
            if (!window.supabase) {
                sdkEl.innerHTML = '<span class="error">❌ Supabase SDK가 로드되지 않았습니다</span>';
                return;
            }
            
            let html = '<ul>';
            html += `<li class="success">✅ Supabase SDK 로드됨</li>`;
            html += `<li>createClient 함수: ${typeof window.supabase.createClient === 'function' ? '<span class="success">사용 가능</span>' : '<span class="error">사용 불가</span>'}</li>`;
            html += '</ul>';
            
            sdkEl.innerHTML = html;
        }
        
        // 직접 연결 테스트
        async function testDirectConnection() {
            log('직접 연결 테스트 시작...', 'info');
            
            const url = 'https://ddfnxbkiewolgweivomv.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8';
            
            try {
                log(`URL: ${url}`, 'info');
                log(`Key: ***${key.slice(-10)}`, 'info');
                
                const client = window.supabase.createClient(url, key);
                log('✅ 클라이언트 생성 성공', 'success');
                
                // 연결 테스트
                const { data, error } = await client.from('links').select('count').limit(1);
                
                if (error) {
                    log(`❌ 쿼리 실패: ${error.message}`, 'error');
                    log(`Error code: ${error.code}`, 'error');
                    log(`Error hint: ${error.hint}`, 'error');
                } else {
                    log('✅ 쿼리 성공!', 'success');
                    log(`결과: ${JSON.stringify(data)}`, 'success');
                }
                
            } catch (e) {
                log(`❌ 예외 발생: ${e.message}`, 'error');
                console.error(e);
            }
        }
        
        // Config를 사용한 연결 테스트
        async function testWithConfig() {
            log('Config 연결 테스트 시작...', 'info');
            
            // config.js 로드 시도
            if (!window.APP_CONFIG) {
                log('⚠️ APP_CONFIG가 없습니다. config.js 로드 시도...', 'warning');
                
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'config.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    
                    log('✅ config.js 로드 성공', 'success');
                } catch (e) {
                    log('❌ config.js 로드 실패', 'error');
                    return;
                }
            }
            
            if (!window.APP_CONFIG?.SUPABASE) {
                log('❌ APP_CONFIG.SUPABASE가 없습니다', 'error');
                return;
            }
            
            const url = window.APP_CONFIG.SUPABASE.URL;
            const key = window.APP_CONFIG.SUPABASE.ANON_KEY;
            
            log(`Config URL: ${url}`, 'info');
            log(`Config Key: ***${key.slice(-10)}`, 'info');
            
            try {
                const client = window.supabase.createClient(url, key);
                log('✅ Config 기반 클라이언트 생성 성공', 'success');
                
                // 연결 테스트
                const { data, error } = await client.from('links').select('count').limit(1);
                
                if (error) {
                    log(`❌ 쿼리 실패: ${error.message}`, 'error');
                } else {
                    log('✅ 쿼리 성공!', 'success');
                }
                
            } catch (e) {
                log(`❌ 예외 발생: ${e.message}`, 'error');
            }
        }
        
        // 쿼리 테스트
        async function testQuery() {
            log('쿼리 테스트 시작...', 'info');
            
            let client = window.supabaseClient;
            
            if (!client) {
                log('⚠️ supabaseClient가 없습니다. 새로 생성...', 'warning');
                
                const url = 'https://ddfnxbkiewolgweivomv.supabase.co';
                const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZm54YmtpZXdvbGd3ZWl2b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzI3NzYsImV4cCI6MjA2NzIwODc3Nn0.YCS2UH6YWarPX3C2ryFUUQnFA-3er_ZQomf_mccjmD8';
                
                try {
                    client = window.supabase.createClient(url, key);
                    window.supabaseClient = client;
                } catch (e) {
                    log(`❌ 클라이언트 생성 실패: ${e.message}`, 'error');
                    return;
                }
            }
            
            // 여러 테이블 테스트
            const tables = ['links', 'users', 'test'];
            
            for (const table of tables) {
                try {
                    log(`📊 ${table} 테이블 테스트...`, 'info');
                    const { data, error } = await client.from(table).select('*').limit(1);
                    
                    if (error) {
                        log(`  ❌ ${table}: ${error.message}`, 'error');
                    } else {
                        log(`  ✅ ${table}: 성공 (${data.length}개 레코드)`, 'success');
                    }
                } catch (e) {
                    log(`  ❌ ${table}: 예외 - ${e.message}`, 'error');
                }
            }
        }
        
        // 페이지 로드 시 실행
        window.addEventListener('load', () => {
            checkEnvironment();
            checkSDKStatus();
            log('페이지 로드 완료', 'info');
            
            // supabase-init.js 로드 시도
            const scripts = document.getElementsByTagName('script');
            let hasSupabaseInit = false;
            for (let script of scripts) {
                if (script.src.includes('supabase-init.js')) {
                    hasSupabaseInit = true;
                    break;
                }
            }
            
            if (!hasSupabaseInit) {
                log('⚠️ supabase-init.js가 로드되지 않았습니다', 'warning');
            }
        });
        
        // 5초 후 재확인
        setTimeout(() => {
            log('5초 후 재확인...', 'info');
            checkEnvironment();
            checkSDKStatus();
        }, 5000);
    </script>
</body>
</html>